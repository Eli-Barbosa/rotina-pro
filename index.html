<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotina Pro V13 - Dark Mode</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a90e2">
    <link rel="apple-touch-icon" href="icon-512.png">
    <link rel="icon" type="image/png" href="icon-512.png">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            /* Variaveis CLARAS (Padr√£o) */
            --bg: #f4f6f8; 
            --card-bg: #ffffff; 
            --text: #333; 
            --text-light: #777;
            --primary-btn: #4a90e2; 
            --edit-btn: #f39c12; 
            --danger: #e74c3c; 
            --success: #2ecc71;
            
            /* Cores Categorias */
            --cat-trabalho: #4a90e2; --cat-saude: #2ecc71; --cat-estudos: #9b59b6;
            --cat-casa: #f39c12; --cat-lazer: #e74c3c; --cat-eclesiastico: #DAA520; --cat-outros: #95a5a6;
            
            /* Gamifica√ß√£o */
            --xp-bar-bg: #e0e0e0; --xp-bar-fill: #FFD700; --level-badge: #333;
            
            /* UI Elements */
            --border-color: #eee;
            --input-bg: #fff;
            --shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        /* --- MODO ESCURO --- */
        body.dark-mode {
            --bg: #121212; 
            --card-bg: #1e1e1e; 
            --text: #e0e0e0; 
            --text-light: #aaa;
            
            --xp-bar-bg: #333;
            --level-badge: #000;
            
            --border-color: #333;
            --input-bg: #2c2c2c;
            --shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; min-height: 100vh; transition: background-color 0.3s, color 0.3s; }
        
        .app-container {
            width: 100%; max-width: 500px; background: var(--card-bg);
            box-shadow: var(--shadow); min-height: 100vh;
            display: flex; flex-direction: column; position: relative; overflow-x: hidden;
            transition: background-color 0.3s;
        }

        /* --- GAMIFICATION BAR & THEME --- */
        .gamification-bar {
            background: var(--card-bg); padding: 10px 20px; border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }
        .level-badge {
            background: var(--level-badge); color: #fff; padding: 5px 10px; border-radius: 12px;
            font-size: 0.8rem; font-weight: bold; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .xp-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .xp-text { font-size: 0.7rem; color: var(--text-light); margin-bottom: 2px; display: flex; justify-content: space-between; }
        .xp-track { width: 100%; height: 8px; background: var(--xp-bar-bg); border-radius: 4px; overflow: hidden; }
        .xp-fill { height: 100%; background: var(--xp-bar-fill); width: 0%; transition: width 0.5s ease; }

        /* --- HEADER --- */
        .header-section { padding: 15px 20px; text-align: center; }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .header-actions { display: flex; gap: 15px; }
        .btn-icon { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #ccc; transition: all 0.3s; }
        .btn-icon.active { color: var(--primary-btn); text-shadow: 0 0 10px rgba(74, 144, 226, 0.4); }
        h1 { margin: 0; font-size: 1rem; color: var(--text-light); }
        .subtitle { font-size: 0.9rem; color: var(--primary-btn); font-weight: bold; margin-bottom: 10px; }

        /* --- TIMER --- */
        .timer-wrapper { position: relative; width: 180px; height: 180px; margin: 0 auto; }
        .timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .timer-circle-bg { fill: none; stroke: var(--border-color); stroke-width: 8; transition: stroke 0.3s; }
        .timer-circle-progress {
            fill: none; stroke: var(--cat-outros); stroke-width: 8; stroke-linecap: round;
            stroke-dasharray: 691; stroke-dashoffset: 691; transition: stroke-dashoffset 1s linear, stroke 0.5s;
        }
        .timer-info {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 30px;
        }
        .timer-current-task { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 2px; line-height: 1.2; }
        .timer-countdown { font-size: 2rem; font-weight: 300; color: var(--text); margin: 2px 0; }
        .timer-next { font-size: 0.75rem; color: var(--text-light); background: var(--border-color); padding: 2px 8px; border-radius: 10px; }

        /* --- PAIN√âIS --- */
        .dashboard-panel, .details-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--card-bg); z-index: 200; transform: translateY(100%); transition: transform 0.3s ease;
            overflow-y: auto; padding: 20px; box-sizing: border-box; color: var(--text);
        }
        .dashboard-panel.open { transform: translateY(0); }
        .details-panel { 
            background: var(--bg); border-top-left-radius: 25px; border-top-right-radius: 25px; 
            max-height: 0; opacity: 0; transition: max-height 0.5s ease, opacity 0.3s ease;
            position: relative; transform: none; top: auto; left: auto; z-index: 10;
        }
        .app-container.details-open .details-panel { max-height: 80vh; opacity: 1; padding-bottom: 90px; }

        .dash-card { background: var(--input-bg); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .dash-title { font-size: 0.9rem; color: var(--text-light); font-weight: bold; text-transform: uppercase; margin-bottom: 10px; }
        .big-number { font-size: 2.5rem; font-weight: 800; color: var(--text); }
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 5px 0; }
        
        .backup-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-download { background-color: #333; color: white; }
        .btn-restore { background-color: #ccc; color: #333; }
        body.dark-mode .btn-download { background-color: #444; }
        body.dark-mode .btn-restore { background-color: #666; color: #fff; }

        /* --- LISTA & INPUTS --- */
        .day-selector { display: flex; justify-content: space-between; margin-bottom: 20px; background: var(--input-bg); padding: 10px; border-radius: 12px; border: 1px solid var(--border-color); }
        .day-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light); font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .day-btn.active { background: var(--primary-btn); color: white; border-color: var(--primary-btn); transform: scale(1.1); }
        .day-btn.today-indicator { border-color: var(--cat-saude); color: var(--cat-saude); }
        .day-btn.active.today-indicator { color: white; }

        .input-group { margin-bottom: 20px; background: var(--input-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .full-width { display: flex; gap: 10px; }
        input, select { border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; background: var(--card-bg); color: var(--text); }
        button.add-btn { background: var(--primary-btn); color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; min-width: 50px; }
        button.add-btn.editing-mode { background: var(--edit-btn); }
        .cancel-edit-btn { display: none; background: #777; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; margin-top: 5px; }

        .repeat-wrapper { margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .repeat-wrapper.disabled { opacity: 0.4; pointer-events: none; }
        .repeat-selector { display: flex; gap: 5px; justify-content: space-between;}
        .repeat-btn { width: 28px; height: 28px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg); color: var(--text-light); cursor: pointer; }
        .repeat-btn.selected { background: #333; color: white; border-color: #333; }
        body.dark-mode .repeat-btn.selected { background: #ccc; color: #000; }

        ul { list-style: none; padding: 0; margin: 0; }
        li { display: flex; align-items: center; background: var(--input-bg); border-bottom: 1px solid var(--border-color); padding: 15px; margin-bottom: 8px; border-radius: 8px; border-left: 5px solid transparent; transition: transform 0.2s; color: var(--text); }
        li.completed { opacity: 0.6; background-color: var(--bg); }
        li.completed .task-desc { text-decoration: line-through; }
        .task-checkbox { margin-right: 15px; width: 22px; height: 22px; cursor: pointer; accent-color: var(--success); }
        .task-info { flex-grow: 1; }
        .task-header { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--text-light);}
        .cat-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; color: white; text-transform: uppercase; font-weight: bold; }
        .punctuality-badge { font-size: 0.7rem; margin-left: auto; color: var(--text-light); font-weight: bold; }
        .xp-gain { color: #f39c12; font-weight: bold; font-size: 0.75rem; animation: floatUp 1s ease-out forwards; display: inline-block; margin-left: 5px;}
        
        .action-container { display: flex; gap: 10px; margin-left: 10px; }
        .list-btn { background: transparent; border: none; cursor: pointer; font-size: 1.2rem; padding: 2px;}
        .edit-btn-icon { color: var(--edit-btn); }
        .delete-btn-icon { color: var(--danger); }

        .fab-toggle {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
            background-color: var(--primary-btn); color: white; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4); cursor: pointer; border: none; z-index: 100;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body>

<div class="app-container" id="appContainer">
    
    <div class="gamification-bar">
        <div class="level-badge" id="userLevelBadge">Lvl 1</div>
        <div class="xp-container">
            <div class="xp-text">
                <span>XP</span>
                <span id="xpValues">0 / 100</span>
            </div>
            <div class="xp-track">
                <div class="xp-fill" id="xpFill"></div>
            </div>
        </div>
        <button class="btn-icon" onclick="toggleTheme()" id="themeBtn" style="font-size:1.2rem; margin-left:10px;">üåô</button>
    </div>

    <div class="header-section">
        <div class="header-top-row">
            <h1 id="headerDate">Carregando...</h1>
            <div class="header-actions">
                <button class="btn-icon" id="alarmToggle" onclick="toggleAlarm()" title="Alarme">üîî</button>
                <button class="btn-icon" onclick="openDashboard()" title="Painel">üìä</button>
            </div>
        </div>
        <div class="subtitle" id="dayStatus">Foco no Agora</div>
        
        <div class="timer-wrapper">
            <svg class="timer-svg" viewBox="0 0 240 240">
                <circle class="timer-circle-bg" cx="120" cy="120" r="110"></circle>
                <circle class="timer-circle-progress" id="timerCircle" cx="120" cy="120" r="110"></circle>
            </svg>
            <div class="timer-info">
                <div class="timer-current-task" id="timerTaskName">Livre</div>
                <div class="timer-countdown" id="timerCountdown">--:--</div>
                <div class="timer-next" id="timerNextLabel">...</div>
            </div>
        </div>
    </div>

    <div class="dashboard-panel" id="dashboardPanel">
        <div class="dash-header">
            <h2>Gest√£o & Conquistas</h2>
            <button class="btn-icon" onclick="closeDashboard()">‚úï</button>
        </div>
        
        <div class="dash-card" style="text-align:center;">
            <div class="dash-title">N√≠vel Atual</div>
            <div class="big-number" id="dashLevel" style="color:#f39c12">1</div>
            <p style="font-size:0.8rem; color:var(--text-light);">Continue pontual para subir!</p>
        </div>

        <div class="dash-card">
            <div class="dash-title">Taxa de Conclus√£o</div>
            <div class="big-number" id="dashCompletionRate">--%</div>
        </div>
        <div class="dash-card">
            <div class="dash-title">Pontualidade M√©dia</div>
            <div class="big-number" id="dashPunctuality">-- min</div>
        </div>

        <div class="backup-section" style="margin-top:20px; border-top:1px dashed var(--border-color); padding-top:15px;">
            <div class="dash-title">Seguran√ßa (Backup)</div>
            <button class="backup-btn btn-download" onclick="exportBackup()">üì• Baixar Dados</button>
            <button class="backup-btn btn-restore" onclick="document.getElementById('backupInput').click()">üì§ Restaurar</button>
            <input type="file" id="backupInput" style="display:none" accept=".json" onchange="importBackup(this)">
        </div>
        
        <button onclick="clearHistory()" style="color:red; background:none; border:none; margin-top:15px; text-decoration:underline; cursor:pointer;">Resetar Tudo</button>
        <div style="height:50px;"></div>
    </div>

    <div class="details-panel" id="detailsPanel">
        <div style="padding-top: 10px;">
            <h3 style="text-align:center; color:var(--text-light); margin-bottom:15px;">Planejamento</h3>
            
            <div class="day-selector">
                <button class="day-btn" onclick="switchViewDay(0)" id="btnDay0">D</button>
                <button class="day-btn" onclick="switchViewDay(1)" id="btnDay1">S</button>
                <button class="day-btn" onclick="switchViewDay(2)" id="btnDay2">T</button>
                <button class="day-btn" onclick="switchViewDay(3)" id="btnDay3">Q</button>
                <button class="day-btn" onclick="switchViewDay(4)" id="btnDay4">Q</button>
                <button class="day-btn" onclick="switchViewDay(5)" id="btnDay5">S</button>
                <button class="day-btn" onclick="switchViewDay(6)" id="btnDay6">S</button>
            </div>

            <div class="input-group">
                <div class="input-row">
                    <input type="time" id="taskTime" required>
                    <select id="taskCategory">
                        <option value="trabalho">Trabalho</option>
                        <option value="eclesiastico">Eclesi√°stico</option>
                        <option value="saude">Sa√∫de</option>
                        <option value="estudos">Estudos</option>
                        <option value="casa">Casa</option>
                        <option value="lazer">Lazer</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="full-width">
                    <input type="text" id="taskDesc" placeholder="Atividade..." required>
                    <button class="add-btn" id="mainActionBtn" onclick="handleAction()">+</button>
                </div>
                <div style="text-align: right;">
                    <button class="cancel-edit-btn" id="cancelEditBtn" onclick="cancelEdit()">Cancelar Edi√ß√£o</button>
                </div>
                <div class="repeat-wrapper" id="repeatWrapper">
                    <span style="font-size:0.8rem; color:var(--text-light);">Repetir em:</span>
                    <div class="repeat-selector">
                        <button class="repeat-btn" onclick="toggleRepeat(0)" id="rep0">D</button>
                        <button class="repeat-btn" onclick="toggleRepeat(1)" id="rep1">S</button>
                        <button class="repeat-btn" onclick="toggleRepeat(2)" id="rep2">T</button>
                        <button class="repeat-btn" onclick="toggleRepeat(3)" id="rep3">Q</button>
                        <button class="repeat-btn" onclick="toggleRepeat(4)" id="rep4">Q</button>
                        <button class="repeat-btn" onclick="toggleRepeat(5)" id="rep5">S</button>
                        <button class="repeat-btn" onclick="toggleRepeat(6)" id="rep6">S</button>
                    </div>
                </div>
            </div>

            <ul id="taskList"></ul>
            <div style="height: 50px;"></div>
        </div>
    </div>

    <button class="fab-toggle" id="toggleBtn" onclick="toggleDetails()">‚ò∞</button>

</div>

<script>
    // --- CORES ---
    const categoryColors = { 
        'trabalho': '#4a90e2', 'saude': '#2ecc71', 'estudos': '#9b59b6', 
        'casa': '#f39c12', 'lazer': '#e74c3c', 'eclesiastico': '#DAA520', 'outros': '#95a5a6' 
    };
    
    // --- DADOS ---
    const emptyWeek = { 0:[], 1:[], 2:[], 3:[], 4:[], 5:[], 6:[] };
    let allTasks = JSON.parse(localStorage.getItem('myRoutineTasksV7')) || emptyWeek;
    let historyLog = JSON.parse(localStorage.getItem('routineHistoryV7')) || [];
    let userXP = parseInt(localStorage.getItem('userXP')) || 0;
    let userLevel = parseInt(localStorage.getItem('userLevel')) || 1;

    let todayIndex = new Date().getDay();
    let viewIndex = todayIndex; 
    let selectedRepeats = new Set();
    let editingTaskIndex = null;
    let alarmEnabled = false;
    let lastAlarmTime = null; 
    const alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

    // --- INIT ---
    updateHeaderDate();
    checkDailyReset();
    renderDayButtons();
    updateXPUI();
    loadTheme(); // Carrega o tema (Escuro/Claro)
    renderTasks();
    setInterval(updateTimer, 1000);
    updateTimer();

    // --- DARK MODE LOGIC ---
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('themeBtn').innerText = isDark ? "‚òÄÔ∏è" : "üåô";
        localStorage.setItem('darkMode', isDark);
    }
    function loadTheme() {
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) {
            document.body.classList.add('dark-mode');
            document.getElementById('themeBtn').innerText = "‚òÄÔ∏è";
        } else {
            document.getElementById('themeBtn').innerText = "üåô";
        }
    }

    // --- GAMIFICA√á√ÉO ---
    function getXpForNextLevel(level) { return level * 100; }
    function addXP(amount) {
        userXP += amount;
        let nextLevelXP = getXpForNextLevel(userLevel);
        if (userXP >= nextLevelXP) {
            userXP -= nextLevelXP; userLevel++; celebrateLevelUp();
        }
        saveGamification(); updateXPUI();
    }
    function subtractXP(amount) { userXP = Math.max(0, userXP - amount); saveGamification(); updateXPUI(); }
    function saveGamification() { localStorage.setItem('userXP', userXP); localStorage.setItem('userLevel', userLevel); }
    function updateXPUI() {
        const nextLevelXP = getXpForNextLevel(userLevel);
        const percentage = Math.min(100, (userXP / nextLevelXP) * 100);
        document.getElementById('userLevelBadge').innerText = `Lvl ${userLevel}`;
        document.getElementById('xpValues').innerText = `${userXP} / ${nextLevelXP}`;
        document.getElementById('xpFill').style.width = `${percentage}%`;
        document.getElementById('dashLevel').innerText = userLevel;
    }
    function celebrateLevelUp() {
        var duration = 3000; var end = Date.now() + duration;
        (function frame() {
            confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
            confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
        alert(`üéâ PARAB√âNS! Voc√™ alcan√ßou o N√≠vel ${userLevel}!`);
    }
    function fireConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }

    // --- TOGGLE TASK ---
    function toggleTask(index) {
        const task = allTasks[viewIndex][index];
        const wasDone = task.done;
        task.done = !task.done;
        task.completedAt = task.done ? new Date().toISOString() : null;

        if (task.done && !wasDone) {
            let points = 10; 
            const [sH, sM] = task.time.split(':').map(Number);
            const now = new Date();
            const taskMin = sH * 60 + sM;
            const nowMin = now.getHours() * 60 + now.getMinutes();
            const diff = nowMin - taskMin;
            if (Math.abs(diff) <= 15) { points += 5; }
            addXP(points); fireConfetti(); task.lastXPGain = `+${points} XP`; 
        } else if (!task.done && wasDone) {
            subtractXP(10); task.lastXPGain = null;
        }
        saveAll(); renderTasks();
    }

    // --- RENDER TASKS ---
    function renderTasks() {
        const list = document.getElementById('taskList'); list.innerHTML = '';
        let tasksToShow = allTasks[viewIndex];
        tasksToShow.forEach((task, index) => {
            const li = document.createElement('li'); 
            li.className = task.done ? 'completed' : '';
            li.style.borderLeftColor = categoryColors[task.category] || categoryColors['outros'];
            let badges = '';
            if (task.done && task.lastXPGain) badges += `<span class="xp-gain">${task.lastXPGain}</span>`;
            if (task.done && task.completedAt) {
                const [sH, sM] = task.time.split(':').map(Number); const d = new Date(task.completedAt);
                const diffMin = (d.getHours()*60 + d.getMinutes()) - (sH*60 + sM);
                if (diffMin > 15) badges += ` <span class="punctuality-badge" style="color:var(--danger)">Atraso</span>`;
                else if (diffMin < -15) badges += ` <span class="punctuality-badge" style="color:var(--success)">Adiantado</span>`;
                else badges += ` <span class="punctuality-badge" style="color:var(--cat-casa)">‚òÖ Pontual</span>`;
            }
            li.innerHTML = `
                <input type="checkbox" class="task-checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${index})">
                <div class="task-info">
                    <div class="task-header">
                        <span class="task-time">${task.time}</span>
                        <span class="cat-badge" style="background:${li.style.borderLeftColor}">${task.category}</span>
                        ${badges}
                    </div>
                    <span class="task-desc">${task.title}</span>
                </div>
                <div class="action-container">
                    <button class="list-btn edit-btn-icon" onclick="startEdit(${index})">‚úé</button>
                    <button class="list-btn delete-btn-icon" onclick="deleteTask(${index})">&times;</button>
                </div>`;
            list.appendChild(li);
        });
    }

    // --- BACKUP ---
    function exportBackup() {
        const data = { tasks: localStorage.getItem('myRoutineTasksV7'), history: localStorage.getItem('routineHistoryV7'), xp: localStorage.getItem('userXP'), level: localStorage.getItem('userLevel'), date: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url;
        const dateStr = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
        a.download = `backup-gamified-${dateStr}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function importBackup(inputElement) {
        const file = inputElement.files[0]; if (!file) return;
        if(!confirm('Isso substituir√° suas tarefas, hist√≥rico e N√çVEL atual. Continuar?')) { inputElement.value = ''; return; }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.tasks) {
                    localStorage.setItem('myRoutineTasksV7', data.tasks);
                    if(data.history) localStorage.setItem('routineHistoryV7', data.history);
                    if(data.xp) localStorage.setItem('userXP', data.xp);
                    if(data.level) localStorage.setItem('userLevel', data.level);
                    alert('Backup restaurado! Recarregando...'); location.reload();
                } else { alert('Arquivo inv√°lido.'); }
            } catch (err) { alert('Erro ao ler arquivo.'); }
        }; reader.readAsText(file);
    }

    // --- UTILS ---
    function updateHeaderDate() { document.getElementById('headerDate').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }); }
    function checkDailyReset() {
        const todayStr = new Date().toLocaleDateString(); const lastSavedDate = localStorage.getItem('lastRoutineDateV7');
        if (lastSavedDate && lastSavedDate !== todayStr) { archiveTasks(lastSavedDate); for(let i=0; i<7; i++) allTasks[i] = allTasks[i].map(t => ({ ...t, done: false, completedAt: null, lastXPGain: null })); saveAll(); }
        localStorage.setItem('lastRoutineDateV7', todayStr);
    }
    function archiveTasks(dateLabel) { Object.values(allTasks).forEach(dayList => { dayList.forEach(task => { historyLog.push({ date: dateLabel, title: task.title, category: task.category, scheduledTime: task.time, done: task.done, completedAt: task.completedAt || null }); }); }); if (historyLog.length > 500) historyLog = historyLog.slice(historyLog.length - 500); localStorage.setItem('routineHistoryV7', JSON.stringify(historyLog)); }
    function openDashboard() { document.getElementById('dashboardPanel').classList.add('open'); }
    function closeDashboard() { document.getElementById('dashboardPanel').classList.remove('open'); }
    function clearHistory() { if(confirm('Resetar TUDO (Tarefas, Hist√≥rico e N√≠vel)?')) { localStorage.clear(); location.reload(); } }
    function switchViewDay(dayIndex) { viewIndex = dayIndex; cancelEdit(); renderDayButtons(); renderTasks(); }
    function renderDayButtons() { for(let i=0; i<7; i++) { const btn = document.getElementById(`btnDay${i}`); btn.classList.remove('active', 'today-indicator'); if (i === viewIndex) btn.classList.add('active'); if (i === todayIndex) btn.classList.add('today-indicator'); } }
    
    function startEdit(index) { editingTaskIndex = index; const task = allTasks[viewIndex][index]; document.getElementById('taskTime').value = task.time; document.getElementById('taskDesc').value = task.title; document.getElementById('taskCategory').value = task.category; document.getElementById('mainActionBtn').innerHTML = "üíæ"; document.getElementById('mainActionBtn').classList.add('editing-mode'); document.getElementById('cancelEditBtn').style.display = 'inline-block'; document.getElementById('repeatWrapper').classList.add('disabled'); }
    function cancelEdit() { editingTaskIndex = null; document.getElementById('taskTime').value = ''; document.getElementById('taskDesc').value = ''; document.getElementById('mainActionBtn').innerHTML = "+"; document.getElementById('mainActionBtn').classList.remove('editing-mode'); document.getElementById('cancelEditBtn').style.display = 'none'; document.getElementById('repeatWrapper').classList.remove('disabled'); }
    function handleAction() { 
        const timeInput = document.getElementById('taskTime'); const descInput = document.getElementById('taskDesc'); const catInput = document.getElementById('taskCategory');
        if (!timeInput.value || !descInput.value) { alert('Preencha os dados!'); return; }
        if (editingTaskIndex !== null) {
            allTasks[viewIndex][editingTaskIndex].time = timeInput.value; allTasks[viewIndex][editingTaskIndex].title = descInput.value; allTasks[viewIndex][editingTaskIndex].category = catInput.value;
            allTasks[viewIndex].sort((a, b) => a.time.localeCompare(b.time));
            saveAll(); renderTasks(); updateTimer(); cancelEdit();
        } else {
            let targetDays = selectedRepeats.size > 0 ? Array.from(selectedRepeats) : [viewIndex];
            targetDays.forEach(day => { allTasks[day].push({ time: timeInput.value, title: descInput.value, category: catInput.value, done: false, completedAt: null }); allTasks[day].sort((a, b) => a.time.localeCompare(b.time)); });
            saveAll(); renderTasks(); updateTimer(); descInput.value = ''; selectedRepeats.clear(); document.querySelectorAll('.repeat-btn').forEach(b => b.classList.remove('selected'));
        }
    }
    function deleteTask(index) { if(confirm('Excluir?')) { allTasks[viewIndex].splice(index, 1); saveAll(); renderTasks(); updateTimer(); cancelEdit(); } }
    function saveAll() { localStorage.setItem('myRoutineTasksV7', JSON.stringify(allTasks)); }
    function toggleRepeat(dayIndex) { if(editingTaskIndex !== null) return; const btn = document.getElementById(`rep${dayIndex}`); if (selectedRepeats.has(dayIndex)) { selectedRepeats.delete(dayIndex); btn.classList.remove('selected'); } else { selectedRepeats.add(dayIndex); btn.classList.add('selected'); } }
    function toggleDetails() { const c = document.getElementById('appContainer'); c.classList.toggle('details-open'); document.getElementById('toggleBtn').innerHTML = c.classList.contains('details-open') ? "&times;" : "‚ò∞"; }
    
    function toggleAlarm() { alarmEnabled = !alarmEnabled; const btn = document.getElementById('alarmToggle'); if(alarmEnabled){ btn.classList.add('active'); alarmAudio.play().then(()=>{alarmAudio.pause();alarmAudio.currentTime=0;}).catch(e=>{}); if(Notification.permission!=="granted")Notification.requestPermission(); }else{ btn.classList.remove('active'); } }
    function checkAlarm(h,m){ if(!alarmEnabled)return; const t=`${formatTime(h)}:${formatTime(m)}`; if(lastAlarmTime===t)return; const tasks=allTasks[todayIndex].filter(tk=>tk.time===t&&!tk.done); if(tasks.length>0){ alarmAudio.currentTime=0; alarmAudio.play().catch(e=>{}); if(Notification.permission==="granted")new Notification("Rotina!",{body:tasks[0].title,icon:"icon-512.png"}); lastAlarmTime=t; } }
    function updateTimer(){ const daily=allTasks[todayIndex]; const elN=document.getElementById('timerTaskName'); const elC=document.getElementById('timerCountdown'); const elNext=document.getElementById('timerNextLabel'); const elCi=document.getElementById('timerCircle'); const now=new Date(); const curH=now.getHours();const curM=now.getMinutes();const curS=now.getSeconds(); if(curS===0)checkAlarm(curH,curM); const curTotal=curH*60+curM; if(!daily||daily.length===0){ elN.textContent="Dia Livre";elC.textContent="--:--";elNext.textContent="";elCi.style.stroke="#eee";return;} let act=-1,nxt=-1; const mins=daily.map(t=>{const[h,m]=t.time.split(':').map(Number);return h*60+m;}); for(let i=0;i<mins.length;i++){if(curTotal>=mins[i])act=i;else{nxt=i;break;}} const circum=2*Math.PI*110; if(act===-1&&nxt!==-1){ elN.textContent="Prepare-se"; elNext.textContent=`Pr√≥x: ${daily[nxt].title}`; elC.textContent=`-${(mins[nxt]-curTotal-1).toString().padStart(2,'0')}:${(60-curS).toString().padStart(2,'0')}`; elCi.style.strokeDashoffset=0; return;} if(nxt===-1){elN.textContent="Tudo Feito!";elC.textContent="00:00";elCi.style.strokeDashoffset=0;return;} if(act!==-1&&nxt!==-1){ const cur=daily[act]; elN.textContent=cur.title; elNext.textContent=`Depois: ${daily[nxt].title}`; elCi.style.stroke=categoryColors[cur.category]||'#999'; const rem=((mins[nxt]-mins[act])*60)-(((curTotal-mins[act])*60)+curS); elC.textContent=`${Math.floor(rem/60).toString().padStart(2,'0')}:${(rem%60).toString().padStart(2,'0')}`; elCi.style.strokeDashoffset=circum*(1-(rem/((mins[nxt]-mins[act])*60))); } }
    function formatTime(v){return v<10?`0${v}`:v;}
</script>
</body>
</html>