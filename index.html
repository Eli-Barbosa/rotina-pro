<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotina Pro V26.1 - Fixed</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d1b2a">
    <link rel="apple-touch-icon" href="icon-512.png">
    <link rel="icon" type="image/png" href="icon-512.png">

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            /* PALETA V19 ANIME */
            --bg: #0d1b2a; --card-bg: #1b263b; --text: #ffffff; --text-muted: #a0aab5;
            --pop-yellow: #ffca3a; --pop-pink: #ff006e; --pop-cyan: #4cc9f0; --pop-green: #8ac926; --pop-orange: #fb5607;
            --pop-purple: #8338ec;
            
            /* UI */
            --border-radius: 20px; --input-bg: #253247;
            --nav-height: 70px;
            
            /* Categorias */
            --cat-trabalho: #4cc9f0; --cat-saude: #8ac926; --cat-estudos: #ff006e;
            --cat-casa: #fb5607; --cat-lazer: #ffca3a; --cat-eclesiastico: #f72585; --cat-outros: #a0aab5;
        }

        body.light-mode {
            --bg: #e0fbfc; --card-bg: #ffffff; --text: #2d3436; --text-muted: #636e72; --input-bg: #f1f4f9;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Nunito', sans-serif; background-color: var(--bg); color: var(--text); 
            margin: 0; display: flex; justify-content: center; min-height: 100vh; 
            transition: 0.3s; overflow: hidden;
            background-image: radial-gradient(var(--text-muted) 1px, transparent 1px);
            background-size: 30px 30px; background-blend-mode: overlay; opacity: 1;
        }
        
        h1, h2, h3, .level-badge, .timer-countdown, .dash-title, .evaluate-btn, .quest-title { font-family: 'Fredoka', sans-serif; letter-spacing: 0.5px; }
        
        .app-container { 
            width: 100%; max-width: 500px; background: var(--bg); 
            height: 100vh; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* --- VIEWS (TELAS) --- */
        .view-section {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 90px;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        .view-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- BOTTOM NAVIGATION (MENU INFERIOR) --- */
        .bottom-nav {
            position: absolute; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: var(--card-bg); border-top: 2px solid var(--pop-cyan);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
            border-radius: 20px 20px 0 0;
        }
        .nav-btn {
            background: none; border: none; color: var(--text-muted);
            font-size: 0.8rem; font-family: 'Fredoka', sans-serif; font-weight: bold;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer; transition: 0.2s; width: 60px;
        }
        .nav-btn i { font-size: 1.5rem; display: block; margin-bottom: 2px; transition: 0.2s; }
        .nav-btn.active { color: var(--pop-yellow); transform: translateY(-5px); }
        .nav-btn.active i { color: var(--pop-cyan); text-shadow: 0 0 10px var(--pop-cyan); }

        /* --- HEADER --- */
        .header-simple { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-title { font-size: 1.5rem; color: var(--pop-yellow); margin: 0; }
        
        /* --- ESTILOS GERAIS --- */
        .timer-wrapper { position: relative; width: 240px; height: 240px; margin: 20px auto; }
        .timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .timer-circle-bg { fill: none; stroke: var(--input-bg); stroke-width: 15; stroke-linecap: round; }
        .timer-circle-progress { fill: none; stroke: var(--pop-green); stroke-width: 15; stroke-linecap: round; stroke-dasharray: 691; stroke-dashoffset: 691; transition: stroke-dashoffset 1s linear, stroke 0.5s; filter: drop-shadow(0 0 5px var(--pop-green)); }
        .timer-info { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .timer-current-task { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; color: var(--text); }
        .timer-countdown { font-size: 3.5rem; margin: 0; color: var(--text); letter-spacing: -1px; }
        .timer-next { font-size: 0.9rem; color: var(--card-bg); background: var(--pop-cyan); padding: 5px 15px; border-radius: 20px; margin-top: 10px; font-weight: bold; }

        .dash-card { background: var(--input-bg); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 2px solid rgba(255,255,255,0.05); }
        .dash-title { font-size: 1rem; color: var(--pop-yellow); margin-bottom: 10px; display: block; }
        
        .quest-card { background: linear-gradient(135deg, #6a1b9a, #4a148c); color: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 3px solid #ab47bc; box-shadow: 0 6px 0 #4a148c; position: relative; overflow: hidden; }
        .quest-card::after { content: '‚úùÔ∏è'; position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.2; transform: rotate(-15deg); }
        .quest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .quest-tag { background: #ab47bc; font-size: 0.7rem; padding: 4px 8px; border-radius: 8px; font-weight: bold; }
        .quest-xp { background: var(--pop-yellow); color: #000; padding: 4px 8px; border-radius: 8px; font-weight: 900; }
        .quest-btn { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 12px; background: #fff; color: #4a148c; font-weight: 900; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s; }
        .quest-btn:active { transform: translateY(4px); box-shadow: none; }
        .quest-btn:disabled { background: rgba(255,255,255,0.3); color: rgba(255,255,255,0.7); cursor: default; transform: translateY(4px); box-shadow: none; }

        .day-selector { display: flex; justify-content: space-between; margin-bottom: 20px; background: var(--input-bg); padding: 8px; border-radius: 20px; }
        .day-btn { width: 40px; height: 40px; border-radius: 12px; border: none; background: transparent; color: var(--text-muted); font-weight: bold; cursor: pointer; transition: 0.2s; }
        .day-btn.active { background: var(--pop-cyan); color: #fff; transform: scale(1.1); }
        .day-btn.today-indicator { color: var(--pop-yellow); }
        
        .input-group { background: var(--input-bg); padding: 15px; border-radius: 20px; margin-bottom: 20px; border: 2px solid rgba(255,255,255,0.05); }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .full-width { display: flex; gap: 10px; }
        input, select { border: 2px solid transparent; padding: 12px; border-radius: 12px; width: 100%; background: rgba(0,0,0,0.3); color: var(--text); font-weight: bold; }
        input:focus, select:focus { outline: none; border-color: var(--pop-pink); }
        button.add-btn { background: var(--pop-yellow); color: #0d1b2a; border: none; padding: 0 20px; border-radius: 12px; cursor: pointer; font-size: 1.5rem; font-weight: 900; box-shadow: 0 4px 0 #cc9a00; }
        button.add-btn:active { transform: translateY(4px); box-shadow: none; }
        button.add-btn.editing-mode { background: var(--pop-pink); box-shadow: 0 4px 0 #b0004c; color: white; }

        ul { list-style: none; padding: 0; margin: 0; }
        li { display: flex; align-items: center; background: var(--input-bg); border-radius: 16px; margin-bottom: 12px; padding: 15px; color: var(--text); position: relative; overflow: hidden; border-left: 5px solid transparent; }
        li.completed { opacity: 0.6; filter: grayscale(0.5); }
        li.completed .task-desc { text-decoration: line-through; color: var(--text-muted); }
        .task-checkbox { width: 24px; height: 24px; margin-right: 15px; accent-color: var(--pop-green); cursor: pointer; }
        .task-info { flex-grow: 1; }
        .task-header { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 2px; }
        .task-desc { font-size: 1.1rem; font-weight: 700; }
        .cat-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 6px; color: #fff; font-weight: 800; }
        .action-container { display: flex; gap: 10px; margin-left: 10px; }
        .list-btn { background: rgba(255,255,255,0.1); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 1rem; color: var(--text); }

        .gamification-bar { background: var(--input-bg); padding: 15px; border-radius: 16px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; border: 2px solid rgba(255,255,255,0.05); }
        .hud-row-1 { display: flex; justify-content: space-between; align-items: center; }
        .level-badge { background: var(--pop-pink); padding: 5px 10px; border-radius: 8px; font-weight: bold; }
        .medals-display { display: flex; gap: 15px; justify-content: center; margin-top: 5px; }
        
        .daily-progress-container { margin-bottom: 20px; background: var(--input-bg); padding: 15px; border-radius: 16px; }
        .progress-track { height: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; overflow: hidden; position: relative; margin-top: 5px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--pop-orange), var(--pop-yellow), var(--pop-green)); width: 0%; transition: width 0.5s; }
        .medal-marker { position: absolute; top:0; bottom:0; width:2px; background:rgba(255,255,255,0.5); }
        
        .evaluate-btn { width: 100%; padding: 18px; background: var(--pop-green); color: #fff; border: none; border-radius: 16px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 6px 0 #5f8d18; margin-bottom: 20px; font-weight: bold; }
        .evaluate-btn:disabled { background: var(--text-muted); box-shadow: none; cursor: not-allowed; }

        .btn-icon-small { width: 35px; height: 35px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); color: var(--text); cursor: pointer; }
        .btn-icon-small.active { background: var(--pop-yellow); color: #000; }

        .floating-xp { position: fixed; color: var(--pop-yellow); font-family: 'Fredoka', sans-serif; font-weight: 900; font-size: 1.8rem; text-shadow: 2px 2px 0 rgba(0,0,0,0.5); pointer-events: none; z-index: 9999; animation: floatUpFade 1.5s ease-out forwards; }
        @keyframes floatUpFade { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.5); } }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .gamer-toast { background: var(--card-bg); color: var(--text); padding: 15px 20px; border-radius: 16px; border: 2px solid var(--pop-cyan); box-shadow: 0 8px 20px rgba(0,0,0,0.3); font-family: 'Fredoka', sans-serif; font-weight: 600; display: flex; align-items: center; gap: 10px; transform: translateX(120%); animation: slideIn 0.3s forwards; pointer-events: auto; }
        .gamer-toast.success { border-color: var(--pop-green); } .gamer-toast.error { border-color: var(--pop-pink); }
        @keyframes slideIn { to { transform: translateX(0); } } @keyframes slideOut { to { transform: translateX(120%); opacity: 0; } }

        #bibleReaderModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; justify-content: center; align-items: center; }
        #bibleReaderModal.show { display: flex; }
        .reader-content { background: var(--card-bg); width: 90%; max-width: 600px; height: 80vh; border-radius: 20px; display: flex; flex-direction: column; border: 2px solid var(--pop-purple); }
        .reader-header { padding: 15px; background: var(--pop-purple); color: white; display: flex; justify-content: space-between; align-items: center; }
        .reader-body { padding: 20px; overflow-y: auto; flex-grow: 1; font-size: 1.1rem; line-height: 1.6; }
        .confirm-read-btn { width: 100%; padding: 15px; background: var(--text-muted); border: none; font-weight: bold; cursor: not-allowed; }
        .confirm-read-btn.unlocked { background: var(--pop-green); color: white; cursor: pointer; }
        .reading-progress-bar { height: 4px; background: rgba(0,0,0,0.3); }
        .reading-progress-fill { height: 100%; background: var(--pop-green); width: 0%; }
        
        .repeat-btn { width: 30px; height: 30px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: var(--text-muted); cursor: pointer; }
        .repeat-btn.active { background: var(--pop-cyan); color: #fff; border-color: var(--pop-cyan); }
        
        .backup-btn { width: 100%; padding: 10px; margin-bottom: 10px; background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); border-radius: 8px; cursor: pointer; }
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 10px 0; font-size: 1rem; }
        .bad-stat { color: var(--pop-pink); font-weight: bold; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="bibleReaderModal">
    <div class="reader-content">
        <div class="reader-header">
            <h3 style="margin:0" id="bibleChapterTitle">Carregando...</h3>
            <button onclick="closeReader()" style="background:none; border:none; color:white; font-size:1.5rem;">‚úï</button>
        </div>
        <div class="reading-progress-bar"><div class="reading-progress-fill" id="readingProgress"></div></div>
        <div class="reader-body" id="bibleTextContent">
            <div style="text-align:center; padding:50px; color:var(--text-muted);"><div style="font-size:2rem;">üìñ</div><p>Buscando...</p></div>
        </div>
        <div style="padding:15px; border-top:1px solid rgba(255,255,255,0.1); background:var(--input-bg);">
            <button id="btnConfirmRead" class="confirm-read-btn" onclick="finishReading()">LEIA AT√â O FIM...</button>
        </div>
    </div>
</div>

<div class="app-container">
    
    <div id="view-home" class="view-section active">
        <div class="header-simple">
            <div>
                <h1 class="header-title">FOCO</h1>
                <div id="headerDate" style="font-size:0.9rem; color:var(--text-muted); font-weight:bold; margin-top:2px;">Carregando...</div>
            </div>
            <div>
                <button class="btn-icon-small" id="alarmToggle" onclick="toggleAlarm()">üîî</button>
            </div>
        </div>

        <div class="timer-wrapper">
            <svg class="timer-svg" viewBox="0 0 240 240">
                <circle class="timer-circle-bg" cx="120" cy="120" r="110"></circle>
                <circle class="timer-circle-progress" id="timerCircle" cx="120" cy="120" r="110"></circle>
            </svg>
            <div class="timer-info">
                <div class="timer-current-task" id="timerTaskName">Livre</div>
                <div class="timer-countdown" id="timerCountdown">00:00</div>
                <div class="timer-next" id="timerNextLabel">--</div>
            </div>
        </div>

        <div class="quote-box" id="dailyQuote" style="margin-top:30px; text-align:center;">"Carregando..."</div>

        <div class="quest-card" style="margin-top:20px;">
            <div class="quest-header"><span class="quest-tag">MISS√ÉO DI√ÅRIA</span><span class="quest-xp">+50 XP</span></div>
            <h3 style="margin:0 0 5px 0;">Leitura B√≠blica üìñ</h3>
            <p style="margin:0; font-size:0.9rem; opacity:0.9;">Leia para fortalecer o esp√≠rito.</p>
            <button class="quest-btn" id="btnBibleQuest" onclick="openBibleReader()">LER AGORA</button>
            <div style="margin-top:10px; font-weight:bold;" id="bibleStreak">üî• Ofensiva: 0 dias</div>
        </div>
    </div>

    <div id="view-tasks" class="view-section">
        <div class="header-simple">
            <h1 class="header-title">ROTINA</h1>
        </div>

        <div class="day-selector">
            <button class="day-btn" onclick="switchViewDay(0)" id="btnDay0">D</button>
            <button class="day-btn" onclick="switchViewDay(1)" id="btnDay1">S</button>
            <button class="day-btn" onclick="switchViewDay(2)" id="btnDay2">T</button>
            <button class="day-btn" onclick="switchViewDay(3)" id="btnDay3">Q</button>
            <button class="day-btn" onclick="switchViewDay(4)" id="btnDay4">Q</button>
            <button class="day-btn" onclick="switchViewDay(5)" id="btnDay5">S</button>
            <button class="day-btn" onclick="switchViewDay(6)" id="btnDay6">S</button>
        </div>

        <div class="input-group">
            <div class="input-row">
                <input type="time" id="taskTime" required>
                <select id="taskCategory">
                    <option value="trabalho">Trabalho üíº</option>
                    <option value="eclesiastico">Igreja ‚õ™</option>
                    <option value="saude">Sa√∫de üçé</option>
                    <option value="estudos">Estudos üìö</option>
                    <option value="casa">Casa üè†</option>
                    <option value="lazer">Lazer üéÆ</option>
                    <option value="outros">Outros üìå</option>
                </select>
            </div>
            <div class="full-width">
                <input type="text" id="taskDesc" placeholder="Nome da tarefa..." required>
                <button class="add-btn" id="mainActionBtn" onclick="handleAction()">+</button>
            </div>
            <div style="text-align: right;">
                <button onclick="cancelEdit()" id="cancelEditBtn" style="display:none; background:transparent; color:var(--text-muted); border:none; cursor:pointer;">Cancelar</button>
            </div>
            
            <div class="repeat-wrapper" id="repeatWrapper" style="margin-top:15px; border-top:1px dashed rgba(255,255,255,0.1); padding-top:10px;">
                <span style="font-size:0.8rem; color:var(--text-muted);">REPETIR:</span>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                    <button class="repeat-btn" onclick="toggleRepeat(0)" id="rep0">D</button>
                    <button class="repeat-btn" onclick="toggleRepeat(1)" id="rep1">S</button>
                    <button class="repeat-btn" onclick="toggleRepeat(2)" id="rep2">T</button>
                    <button class="repeat-btn" onclick="toggleRepeat(3)" id="rep3">Q</button>
                    <button class="repeat-btn" onclick="toggleRepeat(4)" id="rep4">Q</button>
                    <button class="repeat-btn" onclick="toggleRepeat(5)" id="rep5">S</button>
                    <button class="repeat-btn" onclick="toggleRepeat(6)" id="rep6">S</button>
                </div>
            </div>
        </div>

        <ul id="taskList"></ul>
    </div>

    <div id="view-profile" class="view-section">
        <div class="header-simple">
            <h1 class="header-title">PERFIL</h1>
            <button class="btn-icon-small" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è</button>
        </div>

        <div class="gamification-bar">
            <div class="hud-row-1">
                <div class="level-badge" id="userLevelBadge">N√≠vel 1</div>
                <div class="score-display">PONTOS: <span id="userScore">0</span></div>
            </div>
            <div class="medals-display">
                <div class="medal-count" style="color:var(--pop-yellow)">ü•á <span id="cntGold">0</span></div>
                <div class="medal-count" style="color:#dfe6e9">ü•à <span id="cntSilver">0</span></div>
                <div class="medal-count" style="color:#e17055">ü•â <span id="cntBronze">0</span></div>
            </div>
        </div>

        <div class="daily-progress-container">
            <div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:5px; font-weight:bold;">
                <span>Progresso Hoje</span>
                <span id="progressText">0%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="dayProgressBar"></div>
                <div class="medal-marker" style="left:50%;" title="Bronze"></div>
                <div class="medal-marker" style="left:70%;" title="Prata"></div>
            </div>
        </div>

        <button class="evaluate-btn" id="btnEvaluate" onclick="evaluateDay()">
            <span>üèÜ</span> Avaliar Desempenho do Dia
        </button>

        <div class="dash-card">
            <div class="dash-title">‚ö†Ô∏è Negligenciadas</div>
            <div id="dashSkippedList"><p style="font-size:0.9rem; color:var(--text-muted);">Sem dados.</p></div>
        </div>

        <div class="dash-card">
            <div class="dash-title">Di√°rio de Bordo üìù</div>
            <textarea id="journalInput" class="journal-area" placeholder="Notas do dia..." oninput="saveJournal()"></textarea>
        </div>

        <div style="margin-top:20px; border-top:1px dashed rgba(255,255,255,0.1); padding-top:20px;">
            <div class="dash-title">Dados</div>
            <button class="backup-btn btn-download" onclick="exportBackup()">üì• Backup</button>
            <button class="backup-btn btn-restore" onclick="document.getElementById('backupInput').click()">üì§ Restaurar</button>
            <input type="file" id="backupInput" style="display:none" accept=".json" onchange="importBackup(this)">
        </div>
        
        <button onclick="clearHistory()" style="color:var(--pop-pink); background:none; border:none; margin-top:20px; width:100%; font-weight:bold; cursor:pointer;">RESETAR TUDO</button>
    </div>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('view-home', this)">
            <i>üè†</i> FOCO
        </button>
        <button class="nav-btn" onclick="switchTab('view-tasks', this)">
            <i>‚úÖ</i> ROTINA
        </button>
        <button class="nav-btn" onclick="switchTab('view-profile', this)">
            <i>üìä</i> PERFIL
        </button>
    </nav>

</div>

<script>
    // --- L√ìGICA DE NAVEGA√á√ÉO ---
    function switchTab(viewId, btn) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        if(viewId === 'view-tasks') { cancelEdit(); renderTasks(); }
        if(viewId === 'view-profile') { updateSkippedStats(); checkEvaluationButton(); }
    }

    // --- CORES & DADOS ---
    const categoryColors = { 'trabalho': 'var(--cat-trabalho)', 'saude': 'var(--cat-saude)', 'estudos': 'var(--cat-estudos)', 'casa': 'var(--cat-casa)', 'lazer': 'var(--cat-lazer)', 'eclesiastico': 'var(--cat-eclesiastico)', 'outros': 'var(--cat-outros)' };
    const emptyWeek = { 0:[], 1:[], 2:[], 3:[], 4:[], 5:[], 6:[] };
    let allTasks = JSON.parse(localStorage.getItem('myRoutineTasksV7')) || emptyWeek;
    let historyLog = JSON.parse(localStorage.getItem('routineHistoryV7')) || [];
    let medals = JSON.parse(localStorage.getItem('userMedals')) || { gold: 0, silver: 0, bronze: 0 };
    let userLevel = parseInt(localStorage.getItem('userLevel')) || 1;
    let userScore = parseInt(localStorage.getItem('userScore')) || 0;
    let lastEvaluationDate = localStorage.getItem('lastEvalDate');
    let bibleStreak = parseInt(localStorage.getItem('bibleStreak')) || 0;
    let lastBibleDate = localStorage.getItem('lastBibleDate');
    let todayIndex = new Date().getDay(); let viewIndex = todayIndex; let selectedRepeats = new Set(); let editingTaskIndex = null;
    let alarmEnabled = false; let lastAlarmTime = null; const alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    const dailyQuotes = ["Tudo posso naquele que me fortalece.", "Seja forte e corajoso.", "Entrega o teu caminho ao Senhor.", "A alegria do Senhor √© a nossa for√ßa."];

    // --- INIT ---
    if (localStorage.getItem('lightMode') === 'true') document.body.classList.add('light-mode');
    updateHeaderDate(); checkDailyReset(); renderDayButtons(); updateMedalsUI(); updateScoreUI(); renderTasks(); renderQuote(); loadJournal(); checkBibleQuestState(); updateSkippedStats();
    setInterval(updateTimer, 1000); updateTimer(); checkEvaluationButton();

    // --- FUN√á√ïES DE FEEDBACK ---
    function showToast(msg, type = 'info') {
        const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `gamer-toast ${type}`;
        let i = '‚ÑπÔ∏è'; if(type==='success')i='üéâ'; if(type==='warning')i='‚≠ê'; if(type==='error')i='‚ùå'; if(type==='quest')i='‚úùÔ∏è';
        t.innerHTML = `<span>${i}</span> <span>${msg}</span>`; c.appendChild(t);
        setTimeout(() => { t.style.animation = 'slideOut 0.3s forwards'; setTimeout(() => t.remove(), 300); }, 4000);
    }
    function showFloatingXP(amount) {
        const el = document.createElement('div'); el.className = 'floating-xp'; el.innerText = `+${amount} XP`;
        el.style.left = '50%'; el.style.top = '50%'; el.style.transform = 'translate(-50%, -50%)';
        document.body.appendChild(el); setTimeout(() => el.remove(), 1500);
        userScore += amount; localStorage.setItem('userScore', userScore); updateScoreUI();
    }
    function updateScoreUI() { 
        const el = document.getElementById('userScore'); el.innerText = userScore; el.style.color='#fff'; 
        setTimeout(()=>el.style.color='var(--pop-cyan)',300); 
    }
    function updateDailyProgress() {
        const tasks = allTasks[todayIndex]; const bar = document.getElementById('dayProgressBar'); const txt = document.getElementById('progressText');
        if(!tasks || tasks.length===0){ bar.style.width='0%'; txt.innerText='0%'; return; }
        const comp = tasks.filter(t=>t.done).length; const pct = Math.round((comp/tasks.length)*100);
        bar.style.width=`${pct}%`; txt.innerText=`${pct}%`;
    }

    // --- CONTROLE DE TEMPO ---
    function isTaskAllowed(taskTimeStr) {
        if(viewIndex !== todayIndex) return "OK"; 
        const now = new Date(); const [h, m] = taskTimeStr.split(':').map(Number);
        const taskDate = new Date(); taskDate.setHours(h, m, 0, 0);
        const diff = now - taskDate;
        if (diff < -60000) return "WAIT"; 
        if (diff > (24 * 60 * 60 * 1000)) return "EXPIRED";
        return "OK";
    }

    // --- LEITOR B√çBLICO ---
    let readingStartTime = 0; let isReadingComplete = false; const MIN_READING_SECONDS = 15;
    const backupChapter = { title: "Salmos 23", text: ["O Senhor √© o meu pastor...", "Em verdes pastagens...", "Ainda que eu andasse...", "Preparas uma mesa...", "Certamente que a bondade..."] };

    async function openBibleReader() {
        const modal = document.getElementById('bibleReaderModal'); const contentDiv = document.getElementById('bibleTextContent');
        const titleDiv = document.getElementById('bibleChapterTitle'); const btn = document.getElementById('btnConfirmRead');
        const progress = document.getElementById('readingProgress');
        modal.classList.add('show'); contentDiv.scrollTop = 0; progress.style.width = '0%';
        btn.classList.remove('unlocked'); btn.innerText = `Lendo... (M√≠nimo ${MIN_READING_SECONDS}s)`; btn.disabled = true;
        isReadingComplete = false; readingStartTime = Date.now();
        contentDiv.innerHTML = '<div style="text-align:center; padding:50px;"><div style="font-size:2rem;">üìñ</div><p>Buscando...</p></div>';
        try {
            const rc = Math.floor(Math.random() * 150) + 1;
            const res = await fetch(`https://www.abibliadigital.com.br/api/verses/acf/sl/${rc}`);
            if(!res.ok) throw new Error(); const data = await res.json();
            titleDiv.innerText = `${data.book.name} ${data.chapter.number}`;
            let html = ''; data.verses.forEach(v => { html += `<p><span class="verse-num">${v.number}</span> ${v.text}</p>`; });
            contentDiv.innerHTML = html;
        } catch (e) {
            showToast("Modo Offline", "warning"); titleDiv.innerText = `${backupChapter.title} (Offline)`;
            let html = ''; backupChapter.text.forEach((v, i) => { html += `<p><span class="verse-num">${i+1}</span> ${v}</p>`; });
            contentDiv.innerHTML = html;
        }
        setupScrollMonitor(contentDiv, progress);
    }
    function setupScrollMonitor(div, prog) {
        div.onscroll = function() {
            const pct = (div.scrollTop / (div.scrollHeight - div.clientHeight)) * 100;
            prog.style.width = `${pct}%`;
            if (div.scrollHeight <= div.clientHeight || div.scrollTop + div.clientHeight >= div.scrollHeight - 30) checkReadingRequirements();
        }; setTimeout(() => { if (div.scrollHeight <= div.clientHeight) checkReadingRequirements(); }, 500);
    }
    function checkReadingRequirements() {
        if (isReadingComplete) return;
        const elapsed = (Date.now() - readingStartTime) / 1000;
        const btn = document.getElementById('btnConfirmRead');
        if (elapsed >= MIN_READING_SECONDS) {
            isReadingComplete = true; btn.classList.add('unlocked'); btn.disabled = false; btn.innerText = "CONFIRMAR LEITURA ‚úÖ";
        } else {
            btn.innerText = `Leia com calma... (${Math.ceil(MIN_READING_SECONDS - elapsed)}s)`;
            setTimeout(checkReadingRequirements, 1000);
        }
    }
    function finishReading() { if (!isReadingComplete) return; closeReader(); completeBibleQuest(); }
    function closeReader() { document.getElementById('bibleReaderModal').classList.remove('show'); }

    // --- QUESTS & AVALIA√á√ÉO ---
    function checkBibleQuestState() {
        const todayStr = new Date().toLocaleDateString(); const btn = document.getElementById('btnBibleQuest'); const lbl = document.getElementById('bibleStreak');
        lbl.innerText = `üî• Ofensiva: ${bibleStreak} dias`;
        if (lastBibleDate === todayStr) { btn.disabled = true; btn.innerText = "LIDO HOJE ‚úÖ"; btn.style.background = "rgba(255,255,255,0.2)"; btn.style.color = "#fff"; }
        else { btn.disabled = false; btn.innerText = "LER AGORA"; btn.style.background = "#fff"; btn.style.color = "#4a148c"; }
    }
    function completeBibleQuest() {
        const todayStr = new Date().toLocaleDateString();
        if (lastBibleDate) { const d = new Date(); d.setDate(d.getDate()-1); if(lastBibleDate !== d.toLocaleDateString() && lastBibleDate !== todayStr) bibleStreak = 0; }
        bibleStreak++; lastBibleDate = todayStr; localStorage.setItem('bibleStreak', bibleStreak); localStorage.setItem('lastBibleDate', lastBibleDate);
        medals.bronze += 5; saveMedals(); showFloatingXP(50); showToast(`Ofensiva: ${bibleStreak} dias!`, "quest"); fireConfetti(true); checkBibleQuestState();
    }

    function evaluateDay() {
        const todayStr = new Date().toLocaleDateString();
        if (lastEvaluationDate === todayStr) { showToast("J√° avaliado hoje!", "info"); return; }
        const tasks = allTasks[todayIndex];
        if (!tasks || tasks.length === 0) { showToast("Sem tarefas hoje.", "warning"); return; }
        
        // --- BLOQUEIO DE HOR√ÅRIO ---
        let lastTaskMinutes = 0; let lastTaskTimeStr = "";
        tasks.forEach(t => { const [h, m] = t.time.split(':').map(Number); const mins = h*60+m; if(mins>lastTaskMinutes){lastTaskMinutes=mins; lastTaskTimeStr=t.time;} });
        const now = new Date(); const curMin = now.getHours()*60+now.getMinutes();
        if(curMin < lastTaskMinutes) { showToast(`Aguarde a √∫ltima tarefa (${lastTaskTimeStr})!`, "error"); return; }
        // ---------------------------

        const total = tasks.length; const completed = tasks.filter(t => t.done).length;
        let punctual = 0; tasks.forEach(t => { if (t.done && t.completedAt) { const [h, m] = t.time.split(':').map(Number); const d = new Date(t.completedAt); const diff = (d.getHours()*60 + d.getMinutes()) - (h*60 + m); if (Math.abs(diff) <= 15) punctual++; } });
        const pRate = total>0?punctual/total:0; const cRate = total>0?completed/total:0; let won = null;
        if (pRate >= 0.99) { medals.gold++; won = "ü•á OURO"; fireConfetti(true); showFloatingXP(100); }
        else if (pRate >= 0.7) { medals.silver++; won = "ü•à PRATA"; fireConfetti(false); showFloatingXP(50); }
        else if (cRate >= 0.5) { medals.bronze++; won = "ü•â BRONZE"; fireConfetti(false); showFloatingXP(25); }
        else { showToast("Tente amanh√£!", "error"); }
        if (won) { showToast(`Ganhou: ${won}`, "success"); lastEvaluationDate = todayStr; localStorage.setItem('lastEvalDate', lastEvaluationDate); saveMedals(); checkLevelUp(); }
        checkEvaluationButton();
    }

    // --- CORE & UTILS ---
    function updateSkippedStats() {
        const container = document.getElementById('dashSkippedList'); if (!container) return;
        if (historyLog.length === 0) { container.innerHTML = '<p style="font-size:0.9rem; color:var(--text-muted);">Sem dados.</p>'; return; }
        const skippedMap = {}; historyLog.forEach(t => { if (!t.done) skippedMap[t.title] = (skippedMap[t.title] || 0) + 1; });
        const sorted = Object.entries(skippedMap).sort((a,b) => b[1] - a[1]).slice(0, 3);
        container.innerHTML = '';
        if (sorted.length === 0) container.innerHTML = '<p style="font-size:0.9rem; color:var(--pop-green);">Tudo em dia!</p>';
        else sorted.forEach(([t, c]) => { container.innerHTML += `<div class="stat-row"><span class="stat-name">${t}</span> <span class="stat-val bad-stat">${c}x</span></div>`; });
    }

    function checkLevelUp() { if (medals.gold >= 10 || medals.silver >= 20 || medals.bronze >= 30) { userLevel++; medals.gold=0; medals.silver=0; medals.bronze=0; saveMedals(); showToast(`LEVEL UP! N√≠vel ${userLevel}!`, "level-up"); fireConfetti(true); } updateMedalsUI(); }
    function saveMedals() { localStorage.setItem('userMedals', JSON.stringify(medals)); localStorage.setItem('userLevel', userLevel); updateMedalsUI(); }
    function updateMedalsUI() { document.getElementById('userLevelBadge').innerText = `N√≠vel ${userLevel}`; document.getElementById('cntGold').innerText = medals.gold; document.getElementById('cntSilver').innerText = medals.silver; document.getElementById('cntBronze').innerText = medals.bronze; }
    function checkEvaluationButton() { const todayStr = new Date().toLocaleDateString(); const btn = document.getElementById('btnEvaluate'); if (lastEvaluationDate === todayStr) { btn.disabled = true; btn.innerHTML = "<span>‚úÖ</span> Dia Avaliado"; btn.style.background = "var(--input-bg)"; } else { btn.disabled = false; btn.innerHTML = "<span>üåü</span> Avaliar Meu Dia"; btn.style.background = ""; } }
    function fireConfetti(isBig) { confetti({ particleCount: isBig?150:50, spread: 70, origin: { y: 0.6 } }); }
    
    function toggleTask(index) { 
        const task = allTasks[viewIndex][index]; 
        if (!task.done) {
            const status = isTaskAllowed(task.time);
            if (status === "WAIT") { showToast("Ainda n√£o √© hora!", "warning"); renderTasks(); return; }
            if (status === "EXPIRED") { showToast("Prazo expirado (24h)!", "error"); renderTasks(); return; }
        }
        const wasDone = task.done; task.done = !task.done; task.completedAt = task.done ? new Date().toISOString() : null; 
        if(task.done && !wasDone) showFloatingXP(10); 
        saveAll(); renderTasks(); updateDailyProgress();
    }
    
    function renderTasks() {
        const list = document.getElementById('taskList'); list.innerHTML = ''; let tasks = allTasks[viewIndex]; tasks.sort((a,b) => a.time.localeCompare(b.time));
        tasks.forEach((t, i) => {
            const li = document.createElement('li'); li.className = t.done ? 'completed' : ''; li.style.color = categoryColors[t.category] || categoryColors['outros'];
            let badges = ''; if (t.done && t.completedAt) { const [h, m] = t.time.split(':').map(Number); const d = new Date(t.completedAt); const diff = (d.getHours()*60 + d.getMinutes()) - (h*60 + m); if (diff > 15) badges += ` <span class="punctuality-badge" style="color:var(--pop-pink)">ATRASO</span>`; else if (diff < -15) badges += ` <span class="punctuality-badge" style="color:var(--pop-green)">CEDO</span>`; else badges += ` <span class="punctuality-badge" style="color:var(--pop-yellow)">PONTUAL</span>`; }
            li.innerHTML = `<input type="checkbox" class="task-checkbox" ${t.done?'checked':''} onchange="toggleTask(${i})"> <div class="task-info"> <div class="task-header"><span class="task-time" style="color:var(--text); font-weight:800;">${t.time}</span> <span class="cat-badge" style="background:${li.style.color};">${t.category.toUpperCase()}</span> ${badges}</div> <span class="task-desc" style="color:var(--text);">${t.title}</span> </div> <div class="action-container"><button class="list-btn edit-btn-icon" onclick="startEdit(${i})">‚úèÔ∏è</button><button class="list-btn delete-btn-icon" onclick="deleteTask(${i})">üóëÔ∏è</button></div>`;
            list.appendChild(li);
        });
        updateDailyProgress();
    }

    function renderQuote() { document.getElementById('dailyQuote').innerText = dailyQuotes[Math.floor(Math.random() * dailyQuotes.length)]; }
    function saveJournal() { localStorage.setItem('dailyJournal', document.getElementById('journalInput').value); }
    function loadJournal() { const t = localStorage.getItem('dailyJournal'); if(t) document.getElementById('journalInput').value = t; }
    function toggleTheme() { document.body.classList.toggle('light-mode'); localStorage.setItem('lightMode', document.body.classList.contains('light-mode')); document.getElementById('themeBtn').innerText = document.body.classList.contains('light-mode') ? "üåô" : "‚òÄÔ∏è"; }
    function exportBackup() { const data = { tasks: localStorage.getItem('myRoutineTasksV7'), history: localStorage.getItem('routineHistoryV7'), medals: localStorage.getItem('userMedals'), level: localStorage.getItem('userLevel'), score: userScore, journal: localStorage.getItem('dailyJournal'), bible: { streak: bibleStreak, date: lastBibleDate }, date: new Date().toISOString() }; const b = new Blob([JSON.stringify(data)], {type:'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download=`backup-v26-${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); showToast("Salvo!", "success"); }
    function importBackup(elm) { const f = elm.files[0]; if(!f) return; if(!confirm('Restaurar?')) return; const r = new FileReader(); r.onload = e => { try { const d = JSON.parse(e.target.result); if(d.tasks) { localStorage.setItem('myRoutineTasksV7', d.tasks); if(d.history) localStorage.setItem('routineHistoryV7', d.history); if(d.medals) localStorage.setItem('userMedals', d.medals); if(d.level) localStorage.setItem('userLevel', d.level); if(d.score) localStorage.setItem('userScore', d.score); if(d.journal) localStorage.setItem('dailyJournal', d.journal); if(d.bible) { localStorage.setItem('bibleStreak', d.bible.streak); localStorage.setItem('lastBibleDate', d.bible.date); } showToast("Restaurado!", "success"); setTimeout(()=>location.reload(), 1000); } } catch(err) { showToast("Erro", "error"); } }; r.readAsText(f); }
    
    function updateHeaderDate() { document.getElementById('headerDate').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }); }
    function checkDailyReset() { const today = new Date().toLocaleDateString(); const last = localStorage.getItem('lastRoutineDateV7'); if(last && last !== today) { archiveTasks(last); for(let i=0; i<7; i++) allTasks[i] = allTasks[i].map(t => ({...t, done: false, completedAt: null})); saveAll(); } localStorage.setItem('lastRoutineDateV7', today); }
    function archiveTasks(date) { Object.values(allTasks).forEach(list => list.forEach(t => historyLog.push({ date: date, ...t }))); if(historyLog.length > 500) historyLog = historyLog.slice(-500); localStorage.setItem('routineHistoryV7', JSON.stringify(historyLog)); }
    function clearHistory() { if(confirm('Resetar Tudo?')) { localStorage.clear(); location.reload(); } }
    function switchViewDay(i) { viewIndex = i; cancelEdit(); renderDayButtons(); renderTasks(); }
    function renderDayButtons() { for(let i=0; i<7; i++) { const btn = document.getElementById(`btnDay${i}`); btn.classList.remove('active', 'today-indicator'); if(i===viewIndex) btn.classList.add('active'); if(i===todayIndex) btn.classList.add('today-indicator'); } }
    function startEdit(i) { editingTaskIndex = i; const t = allTasks[viewIndex][i]; document.getElementById('taskTime').value = t.time; document.getElementById('taskDesc').value = t.title; document.getElementById('taskCategory').value = t.category; document.getElementById('mainActionBtn').innerHTML = "üíæ"; document.getElementById('mainActionBtn').classList.add('editing-mode'); document.getElementById('cancelEditBtn').style.display = 'inline-block'; document.getElementById('repeatWrapper').style.opacity = '0.3'; document.getElementById('repeatWrapper').style.pointerEvents = 'none'; }
    function cancelEdit() { editingTaskIndex = null; document.getElementById('taskTime').value = ''; document.getElementById('taskDesc').value = ''; document.getElementById('mainActionBtn').innerHTML = "+"; document.getElementById('mainActionBtn').classList.remove('editing-mode'); document.getElementById('cancelEditBtn').style.display = 'none'; document.getElementById('repeatWrapper').style.opacity = '1'; document.getElementById('repeatWrapper').style.pointerEvents = 'auto'; }
    function handleAction() { const time = document.getElementById('taskTime').value; const title = document.getElementById('taskDesc').value; const cat = document.getElementById('taskCategory').value; if(!time || !title) { showToast("Preencha tudo!", "warning"); return; } if(editingTaskIndex !== null) { allTasks[viewIndex][editingTaskIndex] = { time, title, category: cat, done: false, completedAt: null }; saveAll(); renderTasks(); cancelEdit(); showToast("Editado!", "info"); } else { const days = selectedRepeats.size > 0 ? Array.from(selectedRepeats) : [viewIndex]; days.forEach(d => allTasks[d].push({ time, title, category: cat, done: false, completedAt: null })); saveAll(); renderTasks(); document.getElementById('taskDesc').value = ''; selectedRepeats.clear(); document.querySelectorAll('.repeat-btn').forEach(b => b.classList.remove('active')); showToast("Criado!", "success"); } }
    function deleteTask(i) { if(confirm('Apagar?')) { allTasks[viewIndex].splice(i, 1); saveAll(); renderTasks(); showToast("Apagado.", "error"); } }
    function saveAll() { localStorage.setItem('myRoutineTasksV7', JSON.stringify(allTasks)); updateTimer(); }
    function toggleRepeat(i) { if(editingTaskIndex !== null) return; const btn = document.getElementById(`rep${i}`); if(selectedRepeats.has(i)) { selectedRepeats.delete(i); btn.classList.remove('active'); } else { selectedRepeats.add(i); btn.classList.add('active'); } }
    function toggleDetails() { const c = document.getElementById('appContainer'); c.classList.toggle('details-open'); document.getElementById('toggleBtn').innerHTML = c.classList.contains('details-open') ? "‚úï" : "+"; }
    function toggleAlarm() { alarmEnabled = !alarmEnabled; const btn = document.getElementById('alarmToggle'); if(alarmEnabled) { btn.classList.add('active'); showToast("Alarme ON", "success"); if(Notification.permission!=='granted') Notification.requestPermission(); } else { btn.classList.remove('active'); showToast("Alarme OFF", "info"); } }
    function updateTimer() { const tasks = allTasks[todayIndex]; const elN = document.getElementById('timerTaskName'); const elC = document.getElementById('timerCountdown'); const elNext = document.getElementById('timerNextLabel'); const elCircle = document.getElementById('timerCircle'); const now = new Date(); const curMin = now.getHours()*60 + now.getMinutes(); 
        if(alarmEnabled && now.getSeconds() === 0) { const t = `${formatTime(now.getHours())}:${formatTime(now.getMinutes())}`; const match = tasks.find(tk => tk.time === t && !tk.done); if(match) { alarmAudio.play().catch(()=>{}); if(Notification.permission==='granted') new Notification("Rotina", {body: match.title}); showToast(match.title, "warning"); } }
        if(!tasks || tasks.length === 0) { elN.innerText="Livre"; elC.innerText="00:00"; elCircle.style.strokeDashoffset=0; return; }
        const taskMins = tasks.map(t => { const [h, m] = t.time.split(':').map(Number); return h*60 + m; });
        let act = -1, nxt = -1; for(let i=0; i<taskMins.length; i++) { if(curMin >= taskMins[i]) act = i; else { nxt = i; break; } }
        if(act !== -1 && nxt !== -1) { const cur = tasks[act]; elN.innerText = cur.title; elNext.innerText = `Pr√≥x: ${tasks[nxt].title}`; const total = taskMins[nxt] - taskMins[act]; const passed = curMin - taskMins[act]; const pct = 1 - (passed / total); elCircle.style.strokeDashoffset = (2*Math.PI*110) * (1-pct); elC.innerText = `${formatTime(Math.floor((taskMins[nxt]-curMin)/60))}:${formatTime((taskMins[nxt]-curMin)%60)}`; elCircle.style.stroke = getComputedStyle(document.documentElement).getPropertyValue(`--cat-${cur.category}`).trim(); }
        else if(nxt !== -1) { elN.innerText = "Prepare-se"; elNext.innerText = `Pr√≥x: ${tasks[nxt].title}`; elC.innerText = `${formatTime(Math.floor((taskMins[nxt]-curMin)/60))}:${formatTime((taskMins[nxt]-curMin)%60)}`; elCircle.style.strokeDashoffset=0; }
        else { elN.innerText = "Dia Conclu√≠do"; elC.innerText = "00:00"; elNext.innerText = "Bom descanso"; elCircle.style.strokeDashoffset=0; }
    }
    function formatTime(v) { return v<10?`0${v}`:v; }
</script>
</body>
</html>
