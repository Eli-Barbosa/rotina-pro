<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotina Pro V21.1 - Anime Blindado</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d1b2a">
    <link rel="apple-touch-icon" href="icon-512.png">
    <link rel="icon" type="image/png" href="icon-512.png">

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            /* --- PALETA ANIME FUN (V19) --- */
            --bg: #0d1b2a; 
            --card-bg: #1b263b; 
            --text: #ffffff; 
            --text-muted: #a0aab5;
            
            /* Cores Pop */
            --pop-yellow: #ffca3a; 
            --pop-pink: #ff006e;   
            --pop-cyan: #4cc9f0;   
            --pop-green: #8ac926;  
            --pop-orange: #fb5607;
            --pop-purple: #8338ec; /* Cor da Quest */

            /* UI Elements */
            --border-radius: 20px;
            --btn-shadow: 0 4px 0 rgba(0,0,0,0.3);
            --input-bg: #253247;
            
            /* Categorias */
            --cat-trabalho: #4cc9f0; 
            --cat-saude: #8ac926; 
            --cat-estudos: #ff006e;
            --cat-casa: #fb5607; 
            --cat-lazer: #ffca3a; 
            --cat-eclesiastico: #f72585; 
            --cat-outros: #a0aab5;
        }

        /* MODO CLARO */
        body.light-mode {
            --bg: #e0fbfc; 
            --card-bg: #ffffff; 
            --text: #2d3436; 
            --text-muted: #636e72;
            --input-bg: #f1f4f9; 
            --btn-shadow: 0 4px 0 #dfe6e9;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Nunito', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
            transition: 0.3s;
            /* Padronagem sutil */
            background-image: radial-gradient(var(--text-muted) 1px, transparent 1px);
            background-size: 30px 30px; 
            background-blend-mode: overlay;
            opacity: 1;
        }
        
        /* Tipografia T√≠tulos */
        h1, h2, h3, .level-badge, .timer-countdown, .dash-title, .evaluate-btn, .quest-title, .reader-header {
            font-family: 'Fredoka', sans-serif;
            letter-spacing: 0.5px;
        }
        
        .app-container {
            width: 100%; max-width: 500px; background: var(--card-bg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); min-height: 100vh;
            display: flex; flex-direction: column; position: relative; overflow-x: hidden;
            border-left: 1px solid rgba(255,255,255,0.05);
            border-right: 1px solid rgba(255,255,255,0.05);
        }

        /* --- TOASTS (Notifica√ß√µes) --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .gamer-toast {
            background: var(--card-bg); color: var(--text); padding: 15px 20px; border-radius: 16px;
            border: 2px solid var(--pop-cyan); box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            font-family: 'Fredoka', sans-serif; font-weight: 600; display: flex; align-items: center; gap: 10px;
            transform: translateX(120%); animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            pointer-events: auto; min-width: 260px;
        }
        .gamer-toast.success { border-color: var(--pop-green); background: #f0fff4; color: #2d3436; }
        .gamer-toast.warning { border-color: var(--pop-yellow); background: #fffbe6; color: #2d3436; }
        .gamer-toast.quest { border-color: var(--pop-purple); background: #f3e5f5; color: #4a148c; }
        .gamer-toast.level-up { border: none; background: linear-gradient(135deg, var(--pop-pink), var(--pop-yellow)); color: #fff; box-shadow: 0 10px 25px rgba(255, 0, 110, 0.4); }
        
        @keyframes slideIn { to { transform: translateX(0); } }
        @keyframes slideOut { to { transform: translateX(120%) scale(0.8); opacity: 0; } }

        /* --- HUD TOPO --- */
        .gamification-bar {
            background: rgba(0,0,0,0.2); padding: 15px; margin: 15px 15px 0 15px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between; gap: 10px; border: 2px solid rgba(255,255,255,0.05);
        }
        .level-badge { background: var(--pop-pink); color: white; padding: 6px 12px; border-radius: 12px; font-size: 1rem; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transform: rotate(-2deg); }
        .medals-display { display: flex; gap: 12px; flex-grow: 1; justify-content: center; background: var(--input-bg); padding: 8px; border-radius: 12px; }
        .medal-count { display: flex; align-items: center; gap: 4px; font-size: 0.9rem; font-weight: 800; font-family: 'Fredoka', sans-serif; }

        /* --- QUEST CARD (MISS√ÉO) --- */
        .quest-card {
            background: linear-gradient(135deg, #6a1b9a, #4a148c);
            color: white; padding: 20px; border-radius: 20px; margin-bottom: 20px;
            border: 3px solid #ab47bc; box-shadow: 0 6px 0 #4a148c; position: relative; overflow: hidden;
        }
        .quest-card::after { content: '‚úùÔ∏è'; position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.2; transform: rotate(-15deg); }
        .quest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .quest-tag { background: #ab47bc; font-size: 0.7rem; padding: 4px 8px; border-radius: 8px; font-weight: bold; text-transform: uppercase; }
        .quest-xp { background: var(--pop-yellow); color: #000; padding: 4px 8px; border-radius: 8px; font-weight: 900; }
        
        .quest-btn {
            width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 12px;
            background: #fff; color: #4a148c; font-weight: 900; font-family: 'Fredoka', sans-serif;
            cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s;
        }
        .quest-btn:active { transform: translateY(4px); box-shadow: none; }
        .quest-btn:disabled { background: rgba(255,255,255,0.3); color: rgba(255,255,255,0.7); cursor: default; transform: translateY(4px); box-shadow: none; }

        /* --- MODAL LEITOR B√çBLICO --- */
        #bibleReaderModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #bibleReaderModal.show { display: flex; opacity: 1; }
        
        .reader-content {
            background: var(--card-bg); width: 90%; max-width: 600px; height: 80vh;
            border-radius: 20px; display: flex; flex-direction: column; overflow: hidden;
            border: 2px solid var(--pop-purple); box-shadow: 0 0 30px rgba(131, 56, 236, 0.4);
        }
        
        .reader-header {
            padding: 15px; background: var(--pop-purple); color: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .reader-body {
            padding: 20px; overflow-y: auto; flex-grow: 1;
            font-family: 'Nunito', sans-serif; font-size: 1.1rem; line-height: 1.6; color: var(--text);
        }
        
        .reader-footer {
            padding: 15px; border-top: 1px solid rgba(255,255,255,0.1);
            background: var(--input-bg); text-align: center;
        }
        
        .verse-num { font-weight: bold; color: var(--pop-cyan); margin-right: 5px; font-size: 0.8rem; vertical-align: super; }
        
        .confirm-read-btn {
            width: 100%; padding: 15px; background: var(--text-muted); color: var(--bg);
            border: none; border-radius: 12px; font-weight: 900; cursor: not-allowed;
            font-family: 'Fredoka', sans-serif; font-size: 1rem; transition: 0.3s;
        }
        .confirm-read-btn.unlocked {
            background: var(--pop-green); color: white; cursor: pointer;
            box-shadow: 0 4px 0 #5f8d18; animation: pulse 1s infinite;
        }
        .confirm-read-btn.unlocked:active { transform: translateY(4px); box-shadow: none; animation: none; }

        .reading-progress-bar { height: 4px; background: rgba(0,0,0,0.3); width: 100%; }
        .reading-progress-fill { height: 100%; background: var(--pop-green); width: 0%; transition: width 0.1s; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* --- HEADER & TIMER --- */
        .header-section { padding: 20px; text-align: center; }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-icon { background: var(--input-bg); border: none; width: 45px; height: 45px; border-radius: 12px; font-size: 1.4rem; cursor: pointer; color: var(--text); transition: 0.2s; display:grid; place-items:center; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .btn-icon:hover { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); background: var(--pop-cyan); color: #fff; }
        .btn-icon.active { background: var(--pop-yellow); color: #000; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); transform: translateY(4px); }
        
        h1 { margin: 0; font-size: 1.4rem; color: var(--pop-yellow); text-shadow: 2px 2px 0px rgba(0,0,0,0.3); }
        .subtitle { font-size: 1rem; color: var(--pop-cyan); font-weight: 700; margin-bottom: 5px; }
        .quote-box { font-size: 0.95rem; font-style: italic; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; margin: 10px 0 20px 0; border-left: 4px solid var(--pop-pink); }

        .timer-wrapper { position: relative; width: 220px; height: 220px; margin: 0 auto; }
        .timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .timer-circle-bg { fill: none; stroke: var(--input-bg); stroke-width: 12; stroke-linecap: round; }
        .timer-circle-progress { fill: none; stroke: var(--pop-green); stroke-width: 12; stroke-linecap: round; stroke-dasharray: 691; stroke-dashoffset: 691; transition: stroke-dashoffset 1s linear, stroke 0.5s; }
        .timer-info { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .timer-current-task { font-size: 1.1rem; font-weight: 700; margin-bottom: 5px; color: var(--text); }
        .timer-countdown { font-size: 3rem; margin: 0; color: var(--text); letter-spacing: -1px; }
        .timer-next { font-size: 0.85rem; color: var(--card-bg); background: var(--pop-cyan); padding: 4px 12px; border-radius: 20px; margin-top: 8px; font-weight: bold; }

        /* --- PAIN√âIS --- */
        .dashboard-panel, .details-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 200; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); overflow-y: auto; padding: 25px; box-sizing: border-box; color: var(--text); }
        .dashboard-panel.open { transform: translateY(0); }
        .details-panel { background: var(--card-bg); border-radius: 30px 30px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.4); max-height: 0; opacity: 0; position: relative; transform: none; top: auto; left: auto; z-index: 10; transition: max-height 0.5s ease, opacity 0.3s ease; }
        .app-container.details-open .details-panel { max-height: 80vh; opacity: 1; padding-bottom: 100px; }

        .dash-card { background: var(--input-bg); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 2px solid transparent; transition: 0.3s; }
        .dash-card:hover { border-color: var(--pop-cyan); transform: translateY(-3px); }
        .dash-title { font-size: 1rem; color: var(--pop-yellow); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        
        .evaluate-btn { width: 100%; padding: 18px; background: var(--pop-green); color: #fff; border: none; border-radius: 16px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 6px 0 #5f8d18; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.1s; }
        .evaluate-btn:active { transform: translateY(6px); box-shadow: none; }
        .evaluate-btn:disabled { background: var(--text-muted); box-shadow: none; cursor: not-allowed; transform: translateY(6px); }

        .journal-area { width: 100%; height: 120px; padding: 15px; border-radius: 16px; border: 2px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 1rem; resize: none; }
        .journal-area:focus { outline: none; border-color: var(--pop-yellow); background: rgba(255,255,255,0.05); }

        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 10px 0; font-size: 1rem; }
        .bad-stat { color: var(--pop-pink); font-weight: bold; }

        /* --- LISTA & INPUTS --- */
        .day-selector { display: flex; justify-content: space-between; margin-bottom: 20px; background: var(--input-bg); padding: 8px; border-radius: 20px; }
        .day-btn { width: 42px; height: 42px; border-radius: 14px; border: none; background: transparent; color: var(--text-muted); font-weight: bold; cursor: pointer; transition: 0.2s; font-family: 'Fredoka', sans-serif; font-size: 1rem; }
        .day-btn.active { background: var(--pop-cyan); color: #fff; box-shadow: 0 4px 10px rgba(76, 201, 240, 0.3); transform: scale(1.1); }
        .day-btn.today-indicator { color: var(--pop-yellow); }
        .day-btn.active.today-indicator { color: #fff; background: var(--pop-yellow); }

        .input-group { background: var(--input-bg); padding: 20px; border-radius: 20px; margin-bottom: 20px; position: relative; border: 2px solid rgba(255,255,255,0.05); }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .full-width { display: flex; gap: 10px; }
        
        input, select { border: 2px solid transparent; padding: 12px; border-radius: 12px; width: 100%; background: rgba(0,0,0,0.3); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: bold; transition: 0.3s; }
        input:focus, select:focus { outline: none; border-color: var(--pop-pink); background: rgba(0,0,0,0.5); }

        button.add-btn { background: var(--pop-yellow); color: #0d1b2a; border: none; padding: 0 25px; border-radius: 12px; cursor: pointer; font-size: 1.5rem; min-width: 60px; font-weight: 900; box-shadow: 0 4px 0 #cc9a00; transition: 0.1s; }
        button.add-btn:active { transform: translateY(4px); box-shadow: none; }
        button.add-btn.editing-mode { background: var(--pop-pink); box-shadow: 0 4px 0 #b0004c; color: white; }

        ul { list-style: none; padding: 0; margin: 0; }
        li { display: flex; align-items: center; background: var(--input-bg); border-radius: 16px; margin-bottom: 12px; padding: 15px; color: var(--text); transition: 0.2s; position: relative; overflow: hidden; }
        li::before { content:''; position:absolute; left:0; top:0; bottom:0; width:8px; background: currentColor; }
        li.completed { opacity: 0.6; filter: grayscale(0.5); }
        li.completed .task-desc { text-decoration: line-through; color: var(--text-muted); }
        
        .task-checkbox { appearance: none; width: 26px; height: 26px; border: 3px solid var(--text-muted); border-radius: 8px; margin-left: 10px; margin-right: 15px; cursor: pointer; display: grid; place-items: center; transition: 0.2s; }
        .task-checkbox::after { content: '‚úî'; font-weight: 900; color: #fff; font-size: 14px; display: none; }
        .task-checkbox:checked { background: var(--pop-green); border-color: var(--pop-green); transform: scale(1.1); }
        .task-checkbox:checked::after { display: block; }

        .task-info { flex-grow: 1; }
        .task-header { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 2px; }
        .task-desc { font-size: 1.1rem; font-weight: 700; font-family: 'Nunito', sans-serif; }
        .cat-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 8px; color: #fff; font-weight: 800; font-family: 'Fredoka', sans-serif; letter-spacing: 0.5px; }
        .punctuality-badge { font-size: 0.7rem; margin-left: auto; font-weight: 800; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 6px; }

        .action-container { display: flex; gap: 10px; margin-left: 10px; }
        .list-btn { background: rgba(255,255,255,0.1); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 1rem; color: var(--text); transition: 0.2s; display: grid; place-items: center; }
        .list-btn:hover { transform: scale(1.1); background: rgba(255,255,255,0.2); }

        .backup-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; border: 2px solid var(--text-muted); font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: 'Fredoka', sans-serif; transition: 0.2s; background: transparent; color: var(--text-muted); }
        .btn-download { border-color: var(--pop-cyan); color: var(--pop-cyan); }
        .btn-download:hover { background: var(--pop-cyan); color: var(--card-bg); }
        .btn-restore:hover { border-color: var(--text); color: var(--text); }

        .fab-toggle { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: var(--pop-orange); color: #fff; border-radius: 20px; border: none; display: flex; justify-content: center; align-items: center; font-size: 2rem; box-shadow: 0 6px 0 #b83a00; cursor: pointer; z-index: 100; transition: 0.2s; }
        .fab-toggle:active { transform: translateY(6px); box-shadow: none; }

    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="bibleReaderModal">
    <div class="reader-content">
        <div class="reader-header">
            <h3 style="margin:0" id="bibleChapterTitle">Carregando...</h3>
            <button onclick="closeReader()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">‚úï</button>
        </div>
        <div class="reading-progress-bar"><div class="reading-progress-fill" id="readingProgress"></div></div>
        <div class="reader-body" id="bibleTextContent">
            <div style="text-align:center; padding:50px; color:var(--text-muted);">
                <div style="font-size:2rem;">üìñ</div>
                <p>Buscando texto sagrado...</p>
            </div>
        </div>
        <div class="reader-footer">
            <button id="btnConfirmRead" class="confirm-read-btn" onclick="finishReading()">
                LEIA AT√â O FIM...
            </button>
        </div>
    </div>
</div>

<div class="app-container" id="appContainer">
    
    <div class="gamification-bar">
        <div class="level-badge" id="userLevelBadge">N√≠vel 1</div>
        <div class="medals-display">
            <div class="medal-count" style="color:var(--pop-yellow)"><span class="medal-icon">ü•á</span> <span id="cntGold">0</span>/10</div>
            <div class="medal-count" style="color:#dfe6e9"><span class="medal-icon">ü•à</span> <span id="cntSilver">0</span>/20</div>
            <div class="medal-count" style="color:#e17055"><span class="medal-icon">ü•â</span> <span id="cntBronze">0</span>/30</div>
        </div>
        <button class="btn-icon" onclick="toggleTheme()" id="themeBtn" title="Tema" style="width:35px; height:35px; font-size:1.1rem; background:var(--input-bg);">‚òÄÔ∏è</button>
    </div>

    <div class="header-section">
        <div class="header-top-row">
            <h1 id="headerDate">HOJE</h1>
            <div class="header-actions">
                <button class="btn-icon" id="alarmToggle" onclick="toggleAlarm()" title="Alarme">üîî</button>
                <button class="btn-icon" onclick="openDashboard()" title="Perfil">üìä</button>
            </div>
        </div>
        <div class="subtitle" id="dayStatus">Sua Miss√£o Hoje</div>
        <div class="quote-box" id="dailyQuote">"Carregando inspira√ß√£o..."</div>
        
        <div class="timer-wrapper">
            <svg class="timer-svg" viewBox="0 0 240 240">
                <circle class="timer-circle-bg" cx="120" cy="120" r="110"></circle>
                <circle class="timer-circle-progress" id="timerCircle" cx="120" cy="120" r="110"></circle>
            </svg>
            <div class="timer-info">
                <div class="timer-current-task" id="timerTaskName">Livre</div>
                <div class="timer-countdown" id="timerCountdown">00:00</div>
                <div class="timer-next" id="timerNextLabel">--</div>
            </div>
        </div>
    </div>

    <div class="dashboard-panel" id="dashboardPanel">
        <div class="dash-header" style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 class="dash-title" style="margin:0; font-size:1.5rem; color:var(--pop-cyan);">Meu Progresso</h2>
            <button class="btn-icon" onclick="closeDashboard()">‚úï</button>
        </div>
        
        <div class="quest-card">
            <div class="quest-header">
                <span class="quest-tag">MISS√ÉO DI√ÅRIA</span>
                <span class="quest-xp">+50 XP</span>
            </div>
            <h3 style="margin:0 0 5px 0;">Leitura B√≠blica üìñ</h3>
            <p style="margin:0; font-size:0.9rem; opacity:0.9;">Leia um cap√≠tulo para fortalecer o esp√≠rito.</p>
            
            <button class="quest-btn" id="btnBibleQuest" onclick="openBibleReader()">LER AGORA</button>
            
            <div class="quest-streak" id="bibleStreak" style="margin-top:10px; font-weight:bold;">üî• Ofensiva: 0 dias</div>
        </div>

        <button class="evaluate-btn" id="btnEvaluate" onclick="evaluateDay()">
            <span>üåü</span> Avaliar Desempenho do Dia
        </button>

        <div class="dash-card">
            <div class="dash-title">‚ö†Ô∏è Tarefas Negligenciadas</div>
            <div id="dashSkippedList"><p style="font-size:0.9rem; color:var(--text-muted);">Sem dados suficientes.</p></div>
        </div>

        <div class="dash-card">
            <div class="dash-title">Pr√≥xima Conquista</div>
            <div style="font-size:0.9rem; line-height:1.6;">
                Junte para subir de n√≠vel:<br>
                <span style="color:var(--pop-yellow); font-weight:bold;">10x Ouro</span> OU
                <span style="color:#dfe6e9; font-weight:bold;">20x Prata</span> OU
                <span style="color:#e17055; font-weight:bold;">30x Bronze</span>
            </div>
        </div>

        <div class="dash-card">
            <div class="dash-title">Di√°rio de Bordo üìù</div>
            <textarea id="journalInput" class="journal-area" placeholder="O que aprendeu hoje?..." oninput="saveJournal()"></textarea>
        </div>

        <div style="margin-top:30px; border-top:2px dashed rgba(255,255,255,0.1); padding-top:20px;">
            <div class="dash-title" style="margin-bottom:15px; color:var(--text-muted);">Backup dos Dados</div>
            <button class="backup-btn btn-download" onclick="exportBackup()">üì• Salvar Progresso</button>
            <button class="backup-btn btn-restore" onclick="document.getElementById('backupInput').click()">üì§ Carregar Save</button>
            <input type="file" id="backupInput" style="display:none" accept=".json" onchange="importBackup(this)">
        </div>
        
        <button onclick="clearHistory()" style="color:var(--pop-pink); background:none; border:none; margin-top:20px; width:100%; font-weight:bold; cursor:pointer;">Reiniciar Jogo (Resetar)</button>
        <div style="height:50px;"></div>
    </div>

    <div class="details-panel" id="detailsPanel">
        <div style="padding-top: 10px;">
            <h3 style="text-align:center; color:var(--pop-cyan); margin-bottom:20px;">Editar Rotina</h3>
            
            <div class="day-selector">
                <button class="day-btn" onclick="switchViewDay(0)" id="btnDay0">D</button>
                <button class="day-btn" onclick="switchViewDay(1)" id="btnDay1">S</button>
                <button class="day-btn" onclick="switchViewDay(2)" id="btnDay2">T</button>
                <button class="day-btn" onclick="switchViewDay(3)" id="btnDay3">Q</button>
                <button class="day-btn" onclick="switchViewDay(4)" id="btnDay4">Q</button>
                <button class="day-btn" onclick="switchViewDay(5)" id="btnDay5">S</button>
                <button class="day-btn" onclick="switchViewDay(6)" id="btnDay6">S</button>
            </div>

            <div class="input-group">
                <div class="input-row">
                    <input type="time" id="taskTime" required>
                    <select id="taskCategory">
                        <option value="trabalho">Trabalho üíº</option>
                        <option value="eclesiastico">Igreja ‚õ™</option>
                        <option value="saude">Sa√∫de üçé</option>
                        <option value="estudos">Estudos üìö</option>
                        <option value="casa">Casa üè†</option>
                        <option value="lazer">Lazer üéÆ</option>
                        <option value="outros">Outros üìå</option>
                    </select>
                </div>
                <div class="full-width">
                    <input type="text" id="taskDesc" placeholder="Nome da tarefa..." required>
                    <button class="add-btn" id="mainActionBtn" onclick="handleAction()">+</button>
                </div>
                <div style="text-align: right;">
                    <button class="cancel-edit-btn" id="cancelEditBtn" onclick="cancelEdit()">Cancelar</button>
                </div>
                
                <div class="repeat-wrapper" id="repeatWrapper" style="margin-top:15px; border-top:2px dashed rgba(255,255,255,0.1); padding-top:10px;">
                    <span style="font-size:0.8rem; color:var(--text-muted); font-weight:bold;">REPETIR:</span>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <button class="repeat-btn day-btn" onclick="toggleRepeat(0)" id="rep0" style="width:35px; height:35px;">D</button>
                        <button class="repeat-btn day-btn" onclick="toggleRepeat(1)" id="rep1" style="width:35px; height:35px;">S</button>
                        <button class="repeat-btn day-btn" onclick="toggleRepeat(2)" id="rep2" style="width:35px; height:35px;">T</button>
                        <button class="repeat-btn day-btn" onclick="toggleRepeat(3)" id="rep3" style="width:35px; height:35px;">Q</button>
                        <button class="repeat-btn day-btn" onclick="toggleRepeat(4)" id="rep4" style="width:35px; height:35px;">Q</button>
                        <button class="repeat-btn day-btn" onclick="toggleRepeat(5)" id="rep5" style="width:35px; height:35px;">S</button>
                        <button class="repeat-btn day-btn" onclick="toggleRepeat(6)" id="rep6" style="width:35px; height:35px;">S</button>
                    </div>
                </div>
            </div>

            <ul id="taskList"></ul>
            <div style="height: 50px;"></div>
        </div>
    </div>

    <button class="fab-toggle" id="toggleBtn" onclick="toggleDetails()">+</button>

</div>

<script>
    // --- L√ìGICA DO LEITOR B√çBLICO (COM SISTEMA ANTI-FALHA) ---
    let readingStartTime = 0;
    let isReadingComplete = false;
    const MIN_READING_SECONDS = 15;

    // Backup Offline (Salmos 23) caso a API falhe
    const backupChapter = {
        title: "Salmos 23",
        text: [
            "O Senhor √© o meu pastor; de nada terei falta.",
            "Em verdes pastagens me faz repousar e me conduz a √°guas tranquilas;",
            "restaura-me o vigor. Guia-me nas veredas da justi√ßa por amor do seu nome.",
            "Mesmo quando eu andar por um vale de trevas e morte, n√£o temerei perigo algum, pois tu est√°s comigo; a tua vara e o teu cajado me protegem.",
            "Preparas um banquete para mim √† vista dos meus inimigos. Tu unges a minha cabe√ßa com √≥leo; o meu c√°lice transborda.",
            "Sei que a bondade e a fidelidade me acompanhar√£o todos os dias da minha vida, e voltarei √† casa do Senhor enquanto eu viver."
        ]
    };

    async function openBibleReader() {
        const modal = document.getElementById('bibleReaderModal');
        const contentDiv = document.getElementById('bibleTextContent');
        const titleDiv = document.getElementById('bibleChapterTitle');
        const btn = document.getElementById('btnConfirmRead');
        const progress = document.getElementById('readingProgress');

        modal.classList.add('show');
        contentDiv.scrollTop = 0;
        progress.style.width = '0%';
        
        btn.classList.remove('unlocked');
        btn.innerText = `Lendo... (M√≠nimo ${MIN_READING_SECONDS}s)`;
        btn.disabled = true;
        isReadingComplete = false;
        readingStartTime = Date.now();

        contentDiv.innerHTML = '<div style="text-align:center; padding:50px; color:var(--text-muted);"><div style="font-size:2rem;">üìñ</div><p>Buscando texto sagrado...</p></div>';

        try {
            // API: Tenta buscar (Vers√£o ACF √© mais est√°vel para evitar erro 500)
            const randomChapter = Math.floor(Math.random() * 150) + 1;
            const response = await fetch(`https://www.abibliadigital.com.br/api/verses/acf/sl/${randomChapter}`);
            
            if(!response.ok) throw new Error(`Erro API: ${response.status}`);
            
            const data = await response.json();
            titleDiv.innerText = `${data.book.name} ${data.chapter.number}`;
            
            let htmlContent = '';
            data.verses.forEach(v => {
                htmlContent += `<p><span class="verse-num">${v.number}</span> ${v.text}</p>`;
            });
            contentDiv.innerHTML = htmlContent;

        } catch (e) {
            console.log("Falha na API, usando modo offline:", e);
            // Modo Offline
            showToast("Modo Offline Ativado", "warning");
            titleDiv.innerText = `${backupChapter.title} (Offline)`;
            let htmlContent = '';
            backupChapter.text.forEach((verso, index) => {
                htmlContent += `<p><span class="verse-num">${index + 1}</span> ${verso}</p>`;
            });
            contentDiv.innerHTML = htmlContent;
        }

        setupScrollMonitor(contentDiv, progress);
    }

    function setupScrollMonitor(contentDiv, progress) {
        contentDiv.onscroll = function() {
            const scrollTop = contentDiv.scrollTop;
            const scrollHeight = contentDiv.scrollHeight;
            const clientHeight = contentDiv.clientHeight;
            
            const scrolled = (scrollTop / (scrollHeight - clientHeight)) * 100;
            progress.style.width = `${scrolled}%`;

            if (scrollHeight <= clientHeight || scrollTop + clientHeight >= scrollHeight - 30) {
                checkReadingRequirements();
            }
        };
        
        // Verifica se o texto √© curto e n√£o precisa de scroll
        setTimeout(() => {
            if (contentDiv.scrollHeight <= contentDiv.clientHeight) checkReadingRequirements();
        }, 500);
    }

    function checkReadingRequirements() {
        if (isReadingComplete) return;

        const timeElapsed = (Date.now() - readingStartTime) / 1000;
        const btn = document.getElementById('btnConfirmRead');

        if (timeElapsed >= MIN_READING_SECONDS) {
            isReadingComplete = true;
            btn.classList.add('unlocked');
            btn.disabled = false;
            btn.innerText = "CONFIRMAR LEITURA E GANHAR XP ‚úÖ";
        } else {
            const left = Math.ceil(MIN_READING_SECONDS - timeElapsed);
            btn.innerText = `Leia com calma... (${left}s)`;
            setTimeout(checkReadingRequirements, 1000);
        }
    }

    function finishReading() {
        if (!isReadingComplete) return;
        closeReader();
        completeBibleQuest(); // Fun√ß√£o que d√° o XP
    }

    function closeReader() {
        document.getElementById('bibleReaderModal').classList.remove('show');
    }

    // --- UTILS TOAST ---
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `gamer-toast ${type}`;
        let icon = '‚ÑπÔ∏è';
        if(type === 'success') icon = 'üéâ';
        if(type === 'warning') icon = '‚≠ê';
        if(type === 'error') icon = '‚ùå';
        if(type === 'level-up') icon = 'üöÄ';
        if(type === 'quest') icon = '‚úùÔ∏è';
        toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => { toast.style.animation = 'slideOut 0.3s forwards'; setTimeout(() => { toast.remove(); }, 300); }, 4000);
    }

    // --- CORES & DADOS ---
    const categoryColors = { 'trabalho': 'var(--cat-trabalho)', 'saude': 'var(--cat-saude)', 'estudos': 'var(--cat-estudos)', 'casa': 'var(--cat-casa)', 'lazer': 'var(--cat-lazer)', 'eclesiastico': 'var(--cat-eclesiastico)', 'outros': 'var(--cat-outros)' };
    const emptyWeek = { 0:[], 1:[], 2:[], 3:[], 4:[], 5:[], 6:[] };
    let allTasks = JSON.parse(localStorage.getItem('myRoutineTasksV7')) || emptyWeek;
    let historyLog = JSON.parse(localStorage.getItem('routineHistoryV7')) || [];
    let medals = JSON.parse(localStorage.getItem('userMedals')) || { gold: 0, silver: 0, bronze: 0 };
    let userLevel = parseInt(localStorage.getItem('userLevel')) || 1;
    let lastEvaluationDate = localStorage.getItem('lastEvalDate');
    
    // QUEST B√çBLICA VARS
    let bibleStreak = parseInt(localStorage.getItem('bibleStreak')) || 0;
    let lastBibleDate = localStorage.getItem('lastBibleDate');

    let todayIndex = new Date().getDay();
    let viewIndex = todayIndex; 
    let selectedRepeats = new Set();
    let editingTaskIndex = null;
    let alarmEnabled = false;
    let lastAlarmTime = null; 
    const alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

    const dailyQuotes = [
        "Tudo posso naquele que me fortalece.",
        "O Senhor √© meu pastor e nada me faltar√°.",
        "Seja forte e corajoso.",
        "Entrega o teu caminho ao Senhor.",
        "A alegria do Senhor √© a nossa for√ßa.",
        "Em tudo dai gra√ßas.",
        "Foco na miss√£o."
    ];

    // --- INIT ---
    if (localStorage.getItem('lightMode') === 'true') document.body.classList.add('light-mode');
    
    updateHeaderDate();
    checkDailyReset();
    renderDayButtons();
    updateMedalsUI();
    renderTasks();
    renderQuote();
    loadJournal();
    checkBibleQuestState();
    updateSkippedStats(); // Restaurado!
    
    setInterval(updateTimer, 1000);
    updateTimer();
    checkEvaluationButton();

    // --- FUN√á√ïES DE QUEST ---
    function checkBibleQuestState() {
        const todayStr = new Date().toLocaleDateString();
        const btn = document.getElementById('btnBibleQuest');
        const streakLabel = document.getElementById('bibleStreak');
        
        streakLabel.innerText = `üî• Ofensiva: ${bibleStreak} dias`;

        if (lastBibleDate === todayStr) {
            btn.disabled = true;
            btn.innerText = "LIDO HOJE ‚úÖ";
            btn.style.background = "rgba(255,255,255,0.2)";
            btn.style.color = "#fff";
        } else {
            btn.disabled = false;
            btn.innerText = "LER AGORA";
            btn.style.background = "#fff";
            btn.style.color = "#4a148c";
        }
    }

    function completeBibleQuest() {
        const todayStr = new Date().toLocaleDateString();
        if (lastBibleDate) {
            // Verifica quebra de ofensiva
            const lastDate = new Date(lastBibleDate.split('/').reverse().join('-'));
            const todayD = new Date();
            const yesterday = new Date(todayD);
            yesterday.setDate(todayD.getDate() - 1);
            
            // L√≥gica simplificada de data
            if (lastBibleDate !== yesterday.toLocaleDateString() && lastBibleDate !== todayStr) {
                bibleStreak = 0; 
            }
        }

        bibleStreak++;
        lastBibleDate = todayStr;
        localStorage.setItem('bibleStreak', bibleStreak);
        localStorage.setItem('lastBibleDate', lastBibleDate);

        medals.bronze += 5; // B√¥nus
        saveMedals();
        
        showToast(`+50 XP! Ofensiva: ${bibleStreak} dias`, "quest");
        fireConfetti(true);
        checkBibleQuestState();
    }

    // --- FUN√á√ïES DE DASHBOARD ---
    function updateSkippedStats() {
        const container = document.getElementById('dashSkippedList'); 
        if (!container) return;
        
        if (historyLog.length === 0) {
            container.innerHTML = '<p style="font-size:0.9rem; color:var(--text-muted);">Jogue mais para gerar dados!</p>';
            return;
        }

        const skippedMap = {}; 
        historyLog.forEach(t => { 
            if (!t.done) skippedMap[t.title] = (skippedMap[t.title] || 0) + 1; 
        });
        
        const sortedSkipped = Object.entries(skippedMap).sort((a,b) => b[1] - a[1]).slice(0, 3);
        container.innerHTML = '';
        
        if (sortedSkipped.length === 0) {
            container.innerHTML = '<p style="font-size:0.9rem; color:var(--pop-green);">Parab√©ns! Tudo em dia.</p>';
        } else {
            sortedSkipped.forEach(([title, count]) => { 
                container.innerHTML += `
                    <div class="stat-row">
                        <span class="stat-name">${title}</span> 
                        <span class="stat-val bad-stat">${count}x</span>
                    </div>`; 
            });
        }
    }

    function evaluateDay() {
        const todayStr = new Date().toLocaleDateString();
        if (lastEvaluationDate === todayStr) { showToast("J√° avaliado hoje!", "info"); return; }

        const tasks = allTasks[todayIndex];
        if (!tasks || tasks.length === 0) { showToast("Sem tarefas hoje.", "warning"); return; }

        const total = tasks.length;
        const completed = tasks.filter(t => t.done).length;
        let punctual = 0;

        tasks.forEach(t => {
            if (t.done && t.completedAt) {
                const [sH, sM] = t.time.split(':').map(Number);
                const d = new Date(t.completedAt);
                const diffMin = (d.getHours()*60 + d.getMinutes()) - (sH*60 + sM);
                if (Math.abs(diffMin) <= 15) punctual++;
            }
        });

        const punctualityRate = total > 0 ? punctual / total : 0;
        const completionRate = total > 0 ? completed / total : 0;
        let medalWon = null;

        if (punctualityRate >= 0.99) { 
            medals.gold++; medalWon = "ü•á OURO (Perfeito!)"; fireConfetti(true);
        } else if (punctualityRate >= 0.7) {
            medals.silver++; medalWon = "ü•à PRATA (Muito Bom!)"; fireConfetti(false);
        } else if (completionRate >= 0.5) {
            medals.bronze++; medalWon = "ü•â BRONZE (Bom!)"; fireConfetti(false);
        } else {
            showToast("Complete mais tarefas amanh√£!", "error");
        }

        if (medalWon) {
            showToast(`Ganhou: ${medalWon}`, "success");
            lastEvaluationDate = todayStr;
            localStorage.setItem('lastEvalDate', lastEvaluationDate);
            saveMedals();
            checkLevelUp();
        }
        checkEvaluationButton();
    }

    function checkLevelUp() {
        if (medals.gold >= 10 || medals.silver >= 20 || medals.bronze >= 30) {
            userLevel++;
            medals.gold = 0; medals.silver = 0; medals.bronze = 0;
            saveMedals();
            showToast(`LEVEL UP! N√≠vel ${userLevel} alcan√ßado!`, "level-up");
            fireConfetti(true);
        }
        updateMedalsUI();
    }

    function saveMedals() { localStorage.setItem('userMedals', JSON.stringify(medals)); localStorage.setItem('userLevel', userLevel); updateMedalsUI(); }
    function updateMedalsUI() { document.getElementById('userLevelBadge').innerText = `N√≠vel ${userLevel}`; document.getElementById('cntGold').innerText = medals.gold; document.getElementById('cntSilver').innerText = medals.silver; document.getElementById('cntBronze').innerText = medals.bronze; }
    function checkEvaluationButton() { const todayStr = new Date().toLocaleDateString(); const btn = document.getElementById('btnEvaluate'); if (lastEvaluationDate === todayStr) { btn.disabled = true; btn.innerHTML = "<span>‚úÖ</span> Dia Avaliado"; btn.style.background = "var(--input-bg)"; } else { btn.disabled = false; btn.innerHTML = "<span>üåü</span> Avaliar Meu Dia"; btn.style.background = ""; } }
    function fireConfetti(isBig) { const count = isBig ? 150 : 50; confetti({ particleCount: count, spread: 70, origin: { y: 0.6 } }); }
    
    // --- CORE TASKS ---
    function toggleTask(index) {
        const task = allTasks[viewIndex][index];
        task.done = !task.done;
        task.completedAt = task.done ? new Date().toISOString() : null;
        saveAll(); renderTasks();
    }
    
    function renderTasks() {
        const list = document.getElementById('taskList'); list.innerHTML = '';
        let tasksToShow = allTasks[viewIndex];
        
        // Ordenar
        tasksToShow.sort((a, b) => a.time.localeCompare(b.time));

        tasksToShow.forEach((task, index) => {
            const li = document.createElement('li'); 
            li.className = task.done ? 'completed' : '';
            const catVar = categoryColors[task.category] || categoryColors['outros'];
            li.style.color = catVar; 

            let badges = '';
            if (task.done && task.completedAt) {
                const [sH, sM] = task.time.split(':').map(Number); const d = new Date(task.completedAt);
                const diffMin = (d.getHours()*60 + d.getMinutes()) - (sH*60 + sM);
                if (diffMin > 15) badges += ` <span class="punctuality-badge" style="color:var(--pop-pink)">ATRASO</span>`;
                else if (diffMin < -15) badges += ` <span class="punctuality-badge" style="color:var(--pop-green)">CEDO</span>`;
                else badges += ` <span class="punctuality-badge" style="color:var(--pop-yellow)">PONTUAL</span>`;
            }
            
            const catLabel = `<span class="cat-badge" style="background:${catVar};">${task.category.toUpperCase()}</span>`;

            li.innerHTML = `
                <input type="checkbox" class="task-checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${index})">
                <div class="task-info">
                    <div class="task-header">
                        <span class="task-time" style="color:var(--text); font-weight:800;">${task.time}</span>
                        ${catLabel}
                        ${badges}
                    </div>
                    <span class="task-desc" style="color:var(--text);">${task.title}</span>
                </div>
                <div class="action-container">
                    <button class="list-btn edit-btn-icon" onclick="startEdit(${index})">‚úèÔ∏è</button>
                    <button class="list-btn delete-btn-icon" onclick="deleteTask(${index})">üóëÔ∏è</button>
                </div>`;
            list.appendChild(li);
        });
    }

    // --- UTILS ---
    function renderQuote() { const i = Math.floor(Math.random() * dailyQuotes.length); document.getElementById('dailyQuote').innerText = dailyQuotes[i]; }
    function saveJournal() { localStorage.setItem('dailyJournal', document.getElementById('journalInput').value); }
    function loadJournal() { const t = localStorage.getItem('dailyJournal'); if(t) document.getElementById('journalInput').value = t; }
    
    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        const isLight = document.body.classList.contains('light-mode');
        localStorage.setItem('lightMode', isLight);
        document.getElementById('themeBtn').innerText = isLight ? "üåô" : "‚òÄÔ∏è";
    }
    
    // BACKUP
    function exportBackup() {
        const data = { tasks: localStorage.getItem('myRoutineTasksV7'), history: localStorage.getItem('routineHistoryV7'), medals: localStorage.getItem('userMedals'), level: localStorage.getItem('userLevel'), journal: localStorage.getItem('dailyJournal'), bibleStreak: bibleStreak, lastBibleDate: lastBibleDate, date: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url;
        const dateStr = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-'); a.download = `backup-v21-${dateStr}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        showToast("Backup salvo!", "success");
    }
    function importBackup(inputElement) {
        const file = inputElement.files[0]; if (!file) return; 
        if(!confirm('Restaurar backup substituir√° seus dados atuais. Continuar?')) { inputElement.value = ''; return; }
        const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if (data.tasks) { localStorage.setItem('myRoutineTasksV7', data.tasks); if(data.history) localStorage.setItem('routineHistoryV7', data.history); if(data.medals) localStorage.setItem('userMedals', data.medals); if(data.level) localStorage.setItem('userLevel', data.level); if(data.journal) localStorage.setItem('dailyJournal', data.journal); if(data.bibleStreak) localStorage.setItem('bibleStreak', data.bibleStreak); if(data.lastBibleDate) localStorage.setItem('lastBibleDate', data.lastBibleDate); showToast("Restaurado com sucesso!", "success"); setTimeout(()=>location.reload(), 1000); } } catch (err) { showToast("Erro no arquivo.", "error"); } }; reader.readAsText(file);
    }

    function updateHeaderDate() { document.getElementById('headerDate').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }); }
    function checkDailyReset() { const todayStr = new Date().toLocaleDateString(); const lastSavedDate = localStorage.getItem('lastRoutineDateV7'); if (lastSavedDate && lastSavedDate !== todayStr) { archiveTasks(lastSavedDate); for(let i=0; i<7; i++) allTasks[i] = allTasks[i].map(t => ({ ...t, done: false, completedAt: null })); saveAll(); } localStorage.setItem('lastRoutineDateV7', todayStr); }
    function archiveTasks(dateLabel) { Object.values(allTasks).forEach(dayList => { dayList.forEach(task => { historyLog.push({ date: dateLabel, title: task.title, category: task.category, scheduledTime: task.time, done: task.done, completedAt: task.completedAt || null }); }); }); if (historyLog.length > 500) historyLog = historyLog.slice(historyLog.length - 500); localStorage.setItem('routineHistoryV7', JSON.stringify(historyLog)); }
    function openDashboard() { document.getElementById('dashboardPanel').classList.add('open'); checkEvaluationButton(); updateSkippedStats(); }
    function closeDashboard() { document.getElementById('dashboardPanel').classList.remove('open'); }
    function clearHistory() { if(confirm('Tem certeza? Isso apaga tudo.')) { localStorage.clear(); location.reload(); } }
    function switchViewDay(dayIndex) { viewIndex = dayIndex; cancelEdit(); renderDayButtons(); renderTasks(); }
    function renderDayButtons() { for(let i=0; i<7; i++) { const btn = document.getElementById(`btnDay${i}`); btn.classList.remove('active', 'today-indicator'); if (i === viewIndex) btn.classList.add('active'); if (i === todayIndex) btn.classList.add('today-indicator'); } }
    
    // CRUD
    function startEdit(index) { editingTaskIndex = index; const task = allTasks[viewIndex][index]; document.getElementById('taskTime').value = task.time; document.getElementById('taskDesc').value = task.title; document.getElementById('taskCategory').value = task.category; document.getElementById('mainActionBtn').innerHTML = "üíæ"; document.getElementById('mainActionBtn').classList.add('editing-mode'); document.getElementById('cancelEditBtn').style.display = 'inline-block'; document.getElementById('repeatWrapper').style.opacity = '0.3'; document.getElementById('repeatWrapper').style.pointerEvents = 'none'; }
    function cancelEdit() { editingTaskIndex = null; document.getElementById('taskTime').value = ''; document.getElementById('taskDesc').value = ''; document.getElementById('mainActionBtn').innerHTML = "+"; document.getElementById('mainActionBtn').classList.remove('editing-mode'); document.getElementById('cancelEditBtn').style.display = 'none'; document.getElementById('repeatWrapper').style.opacity = '1'; document.getElementById('repeatWrapper').style.pointerEvents = 'auto'; }
    function handleAction() { 
        const timeInput = document.getElementById('taskTime'); const descInput = document.getElementById('taskDesc'); const catInput = document.getElementById('taskCategory'); 
        if (!timeInput.value || !descInput.value) { showToast("Preencha tudo!", "warning"); return; } 
        if (editingTaskIndex !== null) { 
            allTasks[viewIndex][editingTaskIndex].time = timeInput.value; allTasks[viewIndex][editingTaskIndex].title = descInput.value; allTasks[viewIndex][editingTaskIndex].category = catInput.value; 
            saveAll(); renderTasks(); updateTimer(); cancelEdit(); showToast("Atualizado!", "info");
        } else { 
            let targetDays = selectedRepeats.size > 0 ? Array.from(selectedRepeats) : [viewIndex]; 
            targetDays.forEach(day => { allTasks[day].push({ time: timeInput.value, title: descInput.value, category: catInput.value, done: false, completedAt: null }); }); 
            saveAll(); renderTasks(); updateTimer(); descInput.value = ''; selectedRepeats.clear(); 
            document.querySelectorAll('.repeat-btn').forEach(b => { b.classList.remove('active'); });
            showToast("Tarefa Criada!", "success");
        } 
    }
    function deleteTask(index) { if(confirm('Apagar tarefa?')) { allTasks[viewIndex].splice(index, 1); saveAll(); renderTasks(); updateTimer(); cancelEdit(); showToast("Apagado.", "error"); } }
    function saveAll() { localStorage.setItem('myRoutineTasksV7', JSON.stringify(allTasks)); }
    
    function toggleRepeat(dayIndex) { 
        if(editingTaskIndex !== null) return; 
        const btn = document.getElementById(`rep${dayIndex}`); 
        if (selectedRepeats.has(dayIndex)) { selectedRepeats.delete(dayIndex); btn.classList.remove('active'); } else { selectedRepeats.add(dayIndex); btn.classList.add('active'); } 
    }
    
    function toggleDetails() { const c = document.getElementById('appContainer'); c.classList.toggle('details-open'); document.getElementById('toggleBtn').innerHTML = c.classList.contains('details-open') ? "‚úï" : "+"; }
    function toggleAlarm() { alarmEnabled = !alarmEnabled; const btn = document.getElementById('alarmToggle'); if(alarmEnabled){ btn.classList.add('active'); alarmAudio.play().then(()=>{alarmAudio.pause();alarmAudio.currentTime=0;}).catch(e=>{}); if(Notification.permission!=="granted")Notification.requestPermission(); showToast("Alarme Ligado üîî", "success"); }else{ btn.classList.remove('active'); showToast("Alarme Mudo üîï", "info"); } }
    
    function checkAlarm(h,m){ if(!alarmEnabled)return; const t=`${formatTime(h)}:${formatTime(m)}`; if(lastAlarmTime===t)return; const tasks=allTasks[todayIndex].filter(tk=>tk.time===t&&!tk.done); if(tasks.length>0){ alarmAudio.currentTime=0; alarmAudio.play().catch(e=>{}); if(Notification.permission==="granted")new Notification("Rotina!",{body:tasks[0].title,icon:"icon-512.png"}); lastAlarmTime=t; showToast(`HORA DE: ${tasks[0].title}`, "warning"); } }
    
    function updateTimer(){ 
        const daily=allTasks[todayIndex]; const elN=document.getElementById('timerTaskName'); const elC=document.getElementById('timerCountdown'); const elNext=document.getElementById('timerNextLabel'); const elCi=document.getElementById('timerCircle'); const now=new Date(); const curH=now.getHours();const curM=now.getMinutes();const curS=now.getSeconds(); if(curS===0)checkAlarm(curH,curM); const curTotal=curH*60+curM; 
        if(!daily||daily.length===0){ elN.textContent="MODO LIVRE";elC.textContent="--:--";elNext.textContent="Aproveite!";elCi.style.stroke="var(--text-muted)";return;} 
        let act=-1,nxt=-1; const mins=daily.map(t=>{const[h,m]=t.time.split(':').map(Number);return h*60+m;}); for(let i=0;i<mins.length;i++){if(curTotal>=mins[i])act=i;else{nxt=i;break;}} 
        const circum=2*Math.PI*110; 
        if(act===-1&&nxt!==-1){ elN.textContent="PREPARAR"; elNext.textContent=`EM BREVE: ${daily[nxt].title}`; elC.textContent=`-${(mins[nxt]-curTotal-1).toString().padStart(2,'0')}:${(60-curS).toString().padStart(2,'0')}`; elCi.style.strokeDashoffset=0; return;} 
        if(nxt===-1){elN.textContent="TUDO FEITO";elC.textContent="00:00";elCi.style.strokeDashoffset=0;return;} 
        if(act!==-1&&nxt!==-1){ 
            const cur=daily[act]; elN.textContent=cur.title; elNext.textContent=`DEPOIS: ${daily[nxt].title}`; 
            const catColor = getComputedStyle(document.documentElement).getPropertyValue(`--cat-${cur.category}`).trim() || '#fff';
            elCi.style.stroke=catColor; 
            const rem=((mins[nxt]-mins[act])*60)-(((curTotal-mins[act])*60)+curS); 
            elC.textContent=`${Math.floor(rem/60).toString().padStart(2,'0')}:${(rem%60).toString().padStart(2,'0')}`; 
            elCi.style.strokeDashoffset=circum*(1-(rem/((mins[nxt]-mins[act])*60))); 
        } 
    }
    function formatTime(v){return v<10?`0${v}`:v;}
</script>
</body>
</html>