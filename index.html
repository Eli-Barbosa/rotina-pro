<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotina Pro V17 - Completa</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a90e2">
    <link rel="apple-touch-icon" href="icon-512.png">
    <link rel="icon" type="image/png" href="icon-512.png">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            /* Variaveis CLARAS */
            --bg: #f4f6f8; --card-bg: #ffffff; 
            --text: #333; --text-light: #777; --text-muted: #999;
            --primary-btn: #4a90e2; --edit-btn: #f39c12; --danger: #e74c3c; --success: #2ecc71;
            /* Medalhas */
            --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32;
            /* UI */
            --border-color: #eee; --input-bg: #fff; --shadow: 0 0 20px rgba(0,0,0,0.05);
            /* Categorias */
            --cat-trabalho: #4a90e2; --cat-saude: #2ecc71; --cat-estudos: #9b59b6;
            --cat-casa: #f39c12; --cat-lazer: #e74c3c; --cat-eclesiastico: #DAA520; --cat-outros: #95a5a6;
        }

        /* --- MODO ESCURO --- */
        body.dark-mode {
            --bg: #121212; --card-bg: #1e1e1e; 
            --text: #e0e0e0; --text-light: #aaa; --text-muted: #666;
            --border-color: #333; --input-bg: #2c2c2c; --shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; min-height: 100vh; transition: 0.3s; }
        
        .app-container {
            width: 100%; max-width: 500px; background: var(--card-bg);
            box-shadow: var(--shadow); min-height: 100vh;
            display: flex; flex-direction: column; position: relative; overflow-x: hidden;
        }

        /* BARRA DE MEDALHAS */
        .gamification-bar {
            background: var(--card-bg); padding: 10px 10px; border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; gap: 5px;
        }
        .level-badge { background: #333; color: #fff; padding: 5px 8px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; white-space: nowrap; }
        body.dark-mode .level-badge { background: #000; border: 1px solid #333; }
        
        .medals-display { display: flex; gap: 8px; flex-grow: 1; justify-content: center; flex-wrap: wrap; }
        .medal-count { display: flex; align-items: center; gap: 2px; font-size: 0.8rem; font-weight: bold; white-space: nowrap; }
        .medal-icon { font-size: 1rem; }

        /* Header */
        .header-section { padding: 15px 20px; text-align: center; }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; }
        .btn-icon { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #ccc; transition: 0.3s; }
        .btn-icon.active { color: var(--primary-btn); text-shadow: 0 0 10px rgba(74, 144, 226, 0.4); }
        h1 { margin: 0; font-size: 1rem; color: var(--text-light); }
        .subtitle { font-size: 0.9rem; color: var(--primary-btn); font-weight: bold; margin-bottom: 5px; }
        
        /* Frase do Dia */
        .quote-box {
            font-size: 0.8rem; font-style: italic; color: var(--text-muted); 
            margin: 5px 0 15px 0; min-height: 30px; padding: 0 10px;
        }

        /* Timer */
        .timer-wrapper { position: relative; width: 180px; height: 180px; margin: 0 auto; }
        .timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .timer-circle-bg { fill: none; stroke: var(--border-color); stroke-width: 8; }
        .timer-circle-progress { fill: none; stroke: var(--cat-outros); stroke-width: 8; stroke-linecap: round; stroke-dasharray: 691; stroke-dashoffset: 691; transition: stroke-dashoffset 1s linear, stroke 0.5s; }
        .timer-info { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .timer-current-task { font-size: 1rem; font-weight: 700; margin-bottom: 2px; line-height: 1.2; }
        .timer-countdown { font-size: 2rem; font-weight: 300; margin: 2px 0; }
        .timer-next { font-size: 0.75rem; color: var(--text-light); background: var(--border-color); padding: 2px 8px; border-radius: 10px; }

        /* Pain√©is */
        .dashboard-panel, .details-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--card-bg);
            z-index: 200; transform: translateY(100%); transition: transform 0.3s ease;
            overflow-y: auto; padding: 20px; box-sizing: border-box; color: var(--text);
        }
        .dashboard-panel.open { transform: translateY(0); }
        .details-panel { 
            background: var(--bg); border-top-left-radius: 25px; border-top-right-radius: 25px; 
            max-height: 0; opacity: 0; position: relative; transform: none; top: auto; left: auto; z-index: 10;
        }
        .app-container.details-open .details-panel { max-height: 80vh; opacity: 1; padding-bottom: 90px; }

        .dash-card { background: var(--input-bg); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .dash-title { font-size: 0.9rem; color: var(--text-light); font-weight: bold; text-transform: uppercase; margin-bottom: 10px; }
        .big-number { font-size: 2.5rem; font-weight: 800; }

        /* ESTAT√çSTICAS (Negligenciadas) */
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 8px 0; font-size: 0.9rem; }
        .stat-name { color: var(--text); }
        .stat-val { font-weight: bold; }
        .bad-stat { color: var(--danger); }
        
        /* Bot√£o de Avaliar Dia */
        .evaluate-btn {
            width: 100%; padding: 15px; background: linear-gradient(135deg, #4a90e2, #9b59b6);
            color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .evaluate-btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* Di√°rio */
        .journal-area {
            width: 100%; height: 100px; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--bg); color: var(--text); font-family: inherit; resize: none; box-sizing: border-box;
        }
        .journal-area:focus { outline: 2px solid var(--primary-btn); }

        /* Inputs & Lista */
        .day-selector { display: flex; justify-content: space-between; margin-bottom: 20px; background: var(--input-bg); padding: 10px; border-radius: 12px; border: 1px solid var(--border-color); }
        .day-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light); font-weight: bold; cursor: pointer; }
        .day-btn.active { background: var(--primary-btn); color: white; border-color: var(--primary-btn); transform: scale(1.1); }
        .day-btn.today-indicator { border-color: var(--cat-saude); color: var(--cat-saude); }
        .day-btn.active.today-indicator { color: white; }

        .input-group { background: var(--input-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 20px;}
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .full-width { display: flex; gap: 10px; }
        input, select { border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; background: var(--card-bg); color: var(--text); }
        button.add-btn { background: var(--primary-btn); color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; min-width: 50px; }
        button.add-btn.editing-mode { background: var(--edit-btn); }
        .cancel-edit-btn { display: none; background: #777; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; margin-top: 5px; }

        .repeat-wrapper { margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .repeat-wrapper.disabled { opacity: 0.4; pointer-events: none; }
        .repeat-selector { display: flex; gap: 5px; justify-content: space-between;}
        .repeat-btn { width: 28px; height: 28px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg); color: var(--text-light); cursor: pointer; }
        .repeat-btn.selected { background: #333; color: white; border-color: #333; }
        body.dark-mode .repeat-btn.selected { background: #ccc; color: #000; }

        ul { list-style: none; padding: 0; margin: 0; }
        li { display: flex; align-items: center; background: var(--input-bg); border-bottom: 1px solid var(--border-color); padding: 15px; margin-bottom: 8px; border-radius: 8px; border-left: 5px solid transparent; color: var(--text); }
        li.completed { opacity: 0.6; background-color: var(--bg); }
        li.completed .task-desc { text-decoration: line-through; }
        .task-checkbox { margin-right: 15px; width: 22px; height: 22px; cursor: pointer; accent-color: var(--success); }
        .task-info { flex-grow: 1; }
        .task-header { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--text-light);}
        .cat-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; color: white; text-transform: uppercase; font-weight: bold; }
        .punctuality-badge { font-size: 0.7rem; margin-left: auto; font-weight: bold; color: var(--text-light); }

        .action-container { display: flex; gap: 10px; margin-left: 10px; }
        .list-btn { background: transparent; border: none; cursor: pointer; font-size: 1.2rem; padding: 2px;}
        .edit-btn-icon { color: var(--edit-btn); }
        .delete-btn-icon { color: var(--danger); }

        .backup-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-download { background-color: #333; color: white; }
        .btn-restore { background-color: #ccc; color: #333; }
        body.dark-mode .btn-download { background-color: #444; }

        .fab-toggle { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background-color: var(--primary-btn); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4); cursor: pointer; border: none; z-index: 100; }
    </style>
</head>
<body>

<div class="app-container" id="appContainer">
    
    <div class="gamification-bar">
        <div class="level-badge" id="userLevelBadge">N√≠vel 1</div>
        <div class="medals-display">
            <div class="medal-count" style="color:var(--gold)"><span class="medal-icon">ü•á</span> <span id="cntGold">0</span>/10</div>
            <div class="medal-count" style="color:var(--silver)"><span class="medal-icon">ü•à</span> <span id="cntSilver">0</span>/20</div>
            <div class="medal-count" style="color:var(--bronze)"><span class="medal-icon">ü•â</span> <span id="cntBronze">0</span>/30</div>
        </div>
        <button class="btn-icon" onclick="toggleTheme()" id="themeBtn" style="font-size:1.2rem;">üåô</button>
    </div>

    <div class="header-section">
        <div class="header-top-row">
            <h1 id="headerDate">Carregando...</h1>
            <div class="header-actions">
                <button class="btn-icon" id="alarmToggle" onclick="toggleAlarm()" title="Alarme">üîî</button>
                <button class="btn-icon" onclick="openDashboard()" title="Painel">üìä</button>
            </div>
        </div>
        <div class="subtitle" id="dayStatus">Foco no Agora</div>
        <div class="quote-box" id="dailyQuote">"Tudo tem o seu tempo determinado..."</div>
        
        <div class="timer-wrapper">
            <svg class="timer-svg" viewBox="0 0 240 240">
                <circle class="timer-circle-bg" cx="120" cy="120" r="110"></circle>
                <circle class="timer-circle-progress" id="timerCircle" cx="120" cy="120" r="110"></circle>
            </svg>
            <div class="timer-info">
                <div class="timer-current-task" id="timerTaskName">Livre</div>
                <div class="timer-countdown" id="timerCountdown">--:--</div>
                <div class="timer-next" id="timerNextLabel">...</div>
            </div>
        </div>
    </div>

    <div class="dashboard-panel" id="dashboardPanel">
        <div class="dash-header">
            <h2>Gest√£o & Resultados</h2>
            <button class="btn-icon" onclick="closeDashboard()">‚úï</button>
        </div>
        
        <button class="evaluate-btn" id="btnEvaluate" onclick="evaluateDay()">
            üèÜ Avaliar Desempenho do Dia
        </button>

        <div class="dash-card">
            <div class="dash-title">‚ö†Ô∏è Onde Precisa Melhorar</div>
            <div id="dashSkippedList">
                <p style="font-size:0.8rem; color:var(--text-light);">Carregando dados...</p>
            </div>
        </div>

        <div class="dash-card">
            <div class="dash-title">Status do N√≠vel</div>
            <div style="font-size:0.9rem;">
                Meta para subir de n√≠vel:<br>
                <strong>10 Ouros</strong> (ü•á) OU <strong>20 Pratas</strong> (ü•à) OU <strong>30 Bronzes</strong> (ü•â).
            </div>
        </div>

        <div class="dash-card">
            <div class="dash-title">Di√°rio de Gratid√£o ‚úçÔ∏è</div>
            <textarea id="journalInput" class="journal-area" placeholder="Pelo que voc√™ √© grato hoje? O que aprendeu? Escreva aqui..." oninput="saveJournal()"></textarea>
        </div>

        <div class="backup-section" style="margin-top:20px; border-top:1px dashed var(--border-color); padding-top:15px;">
            <div class="dash-title">Backup Seguro</div>
            <button class="backup-btn btn-download" onclick="exportBackup()">üì• Baixar Dados</button>
            <button class="backup-btn btn-restore" onclick="document.getElementById('backupInput').click()">üì§ Restaurar</button>
            <input type="file" id="backupInput" style="display:none" accept=".json" onchange="importBackup(this)">
        </div>
        
        <button onclick="clearHistory()" style="color:red; background:none; border:none; margin-top:15px; text-decoration:underline; cursor:pointer;">Resetar App</button>
        <div style="height:50px;"></div>
    </div>

    <div class="details-panel" id="detailsPanel">
        <div style="padding-top: 10px;">
            <h3 style="text-align:center; color:var(--text-light); margin-bottom:15px;">Planejamento</h3>
            <div class="day-selector">
                <button class="day-btn" onclick="switchViewDay(0)" id="btnDay0">D</button>
                <button class="day-btn" onclick="switchViewDay(1)" id="btnDay1">S</button>
                <button class="day-btn" onclick="switchViewDay(2)" id="btnDay2">T</button>
                <button class="day-btn" onclick="switchViewDay(3)" id="btnDay3">Q</button>
                <button class="day-btn" onclick="switchViewDay(4)" id="btnDay4">Q</button>
                <button class="day-btn" onclick="switchViewDay(5)" id="btnDay5">S</button>
                <button class="day-btn" onclick="switchViewDay(6)" id="btnDay6">S</button>
            </div>
            <div class="input-group">
                <div class="input-row">
                    <input type="time" id="taskTime" required>
                    <select id="taskCategory">
                        <option value="trabalho">Trabalho</option>
                        <option value="eclesiastico">Eclesi√°stico</option>
                        <option value="saude">Sa√∫de</option>
                        <option value="estudos">Estudos</option>
                        <option value="casa">Casa</option>
                        <option value="lazer">Lazer</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="full-width">
                    <input type="text" id="taskDesc" placeholder="Atividade..." required>
                    <button class="add-btn" id="mainActionBtn" onclick="handleAction()">+</button>
                </div>
                <div style="text-align: right;">
                    <button class="cancel-edit-btn" id="cancelEditBtn" onclick="cancelEdit()">Cancelar</button>
                </div>
                <div class="repeat-wrapper" id="repeatWrapper">
                    <span style="font-size:0.8rem; color:var(--text-light);">Repetir em:</span>
                    <div class="repeat-selector">
                        <button class="repeat-btn" onclick="toggleRepeat(0)" id="rep0">D</button>
                        <button class="repeat-btn" onclick="toggleRepeat(1)" id="rep1">S</button>
                        <button class="repeat-btn" onclick="toggleRepeat(2)" id="rep2">T</button>
                        <button class="repeat-btn" onclick="toggleRepeat(3)" id="rep3">Q</button>
                        <button class="repeat-btn" onclick="toggleRepeat(4)" id="rep4">Q</button>
                        <button class="repeat-btn" onclick="toggleRepeat(5)" id="rep5">S</button>
                        <button class="repeat-btn" onclick="toggleRepeat(6)" id="rep6">S</button>
                    </div>
                </div>
            </div>
            <ul id="taskList"></ul>
            <div style="height: 50px;"></div>
        </div>
    </div>
    <button class="fab-toggle" id="toggleBtn" onclick="toggleDetails()">‚ò∞</button>
</div>

<script>
    // --- CORES & DADOS ---
    const categoryColors = { 'trabalho': '#4a90e2', 'saude': '#2ecc71', 'estudos': '#9b59b6', 'casa': '#f39c12', 'lazer': '#e74c3c', 'eclesiastico': '#DAA520', 'outros': '#95a5a6' };
    const emptyWeek = { 0:[], 1:[], 2:[], 3:[], 4:[], 5:[], 6:[] };
    let allTasks = JSON.parse(localStorage.getItem('myRoutineTasksV7')) || emptyWeek;
    let historyLog = JSON.parse(localStorage.getItem('routineHistoryV7')) || [];
    let medals = JSON.parse(localStorage.getItem('userMedals')) || { gold: 0, silver: 0, bronze: 0 };
    let userLevel = parseInt(localStorage.getItem('userLevel')) || 1;
    let lastEvaluationDate = localStorage.getItem('lastEvalDate');
    let todayIndex = new Date().getDay();
    let viewIndex = todayIndex; 
    let selectedRepeats = new Set();
    let editingTaskIndex = null;
    let alarmEnabled = false;
    let lastAlarmTime = null; 
    const alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

    const dailyQuotes = [
        "Tudo posso naquele que me fortalece. (Filipenses 4:13)",
        "O Senhor √© meu pastor e nada me faltar√°. (Salmos 23:1)",
        "Esfor√ßa-te, e tem bom √¢nimo. (Josu√© 1:9)",
        "A disciplina √© a liberdade.",
        "Agrade√ßa pelo que tem enquanto busca o que quer.",
        "N√£o se preocupe com o amanh√£, pois o amanh√£ trar√° as suas pr√≥prias preocupa√ß√µes.",
        "O que voc√™ faz hoje ecoa na eternidade.",
        "Alegrai-vos sempre no Senhor. (Filipenses 4:4)",
        "Seja forte e corajoso."
    ];

    // --- INIT ---
    loadTheme();
    updateHeaderDate();
    checkDailyReset();
    renderDayButtons();
    updateMedalsUI();
    renderTasks();
    renderQuote();
    loadJournal();
    setInterval(updateTimer, 1000);
    updateTimer();
    checkEvaluationButton();

    // --- L√ìGICA DE NEGLIGENCIADAS (Restaurada) ---
    function updateSkippedStats() {
        const container = document.getElementById('dashSkippedList'); 
        if (!container) return;
        
        if (historyLog.length === 0) {
            container.innerHTML = '<p style="font-size:0.8rem; color:var(--text-light);">Ainda n√£o h√° dados suficientes.</p>';
            return;
        }

        const skippedMap = {}; 
        historyLog.forEach(t => { 
            if (!t.done) skippedMap[t.title] = (skippedMap[t.title] || 0) + 1; 
        });
        
        const sortedSkipped = Object.entries(skippedMap).sort((a,b) => b[1] - a[1]).slice(0, 3);
        container.innerHTML = '';
        
        if (sortedSkipped.length === 0) {
            container.innerHTML = '<p style="font-size:0.8rem; color:var(--success);">Parab√©ns! Voc√™ n√£o tem negligenciado tarefas.</p>';
        } else {
            sortedSkipped.forEach(([title, count]) => { 
                container.innerHTML += `
                    <div class="stat-row">
                        <span class="stat-name">${title}</span> 
                        <span class="stat-val bad-stat">${count}x</span>
                    </div>`; 
            });
        }
    }

    // --- L√ìGICA DE AVALIA√á√ÉO ---
    function evaluateDay() {
        const todayStr = new Date().toLocaleDateString();
        if (lastEvaluationDate === todayStr) { alert("Voc√™ j√° avaliou o dia de hoje! Volte amanh√£."); return; }
        const tasks = allTasks[todayIndex];
        if (!tasks || tasks.length === 0) { alert("N√£o h√° tarefas para avaliar hoje."); return; }

        const total = tasks.length;
        const completed = tasks.filter(t => t.done).length;
        let punctual = 0;
        tasks.forEach(t => {
            if (t.done && t.completedAt) {
                const [sH, sM] = t.time.split(':').map(Number);
                const d = new Date(t.completedAt);
                const diffMin = (d.getHours()*60 + d.getMinutes()) - (sH*60 + sM);
                if (Math.abs(diffMin) <= 15) punctual++;
            }
        });

        const punctualityRate = total > 0 ? punctual / total : 0;
        const completionRate = total > 0 ? completed / total : 0;
        let medalWon = null;

        if (punctualityRate >= 0.99) { medals.gold++; medalWon = "ü•á OURO (Pontualidade Perfeita)"; fireConfetti(true); } 
        else if (punctualityRate >= 0.7) { medals.silver++; medalWon = "ü•à PRATA (Boa Pontualidade)"; fireConfetti(false); } 
        else if (completionRate >= 0.5) { medals.bronze++; medalWon = "ü•â BRONZE (Tarefa Cumprida)"; fireConfetti(false); } 
        else { alert("Continue tentando! Complete mais tarefas amanh√£."); }

        if (medalWon) {
            alert(`Parab√©ns! Voc√™ ganhou uma medalha de ${medalWon}!`);
            lastEvaluationDate = todayStr;
            localStorage.setItem('lastEvalDate', lastEvaluationDate);
            saveMedals(); checkLevelUp();
        }
        checkEvaluationButton();
    }

    function checkLevelUp() {
        if (medals.gold >= 10 || medals.silver >= 20 || medals.bronze >= 30) {
            userLevel++;
            medals.gold = 0; medals.silver = 0; medals.bronze = 0;
            saveMedals();
            alert(`üéâ INCR√çVEL! Voc√™ subiu para o N√çVEL ${userLevel}! Um novo ciclo come√ßa agora.`);
            fireConfetti(true);
        }
        updateMedalsUI();
    }

    function saveMedals() { localStorage.setItem('userMedals', JSON.stringify(medals)); localStorage.setItem('userLevel', userLevel); updateMedalsUI(); }
    function updateMedalsUI() { document.getElementById('userLevelBadge').innerText = `N√≠vel ${userLevel}`; document.getElementById('cntGold').innerText = medals.gold; document.getElementById('cntSilver').innerText = medals.silver; document.getElementById('cntBronze').innerText = medals.bronze; }
    function checkEvaluationButton() { const todayStr = new Date().toLocaleDateString(); const btn = document.getElementById('btnEvaluate'); if (lastEvaluationDate === todayStr) { btn.disabled = true; btn.innerText = "Dia j√° avaliado ‚úÖ"; btn.style.background = "#ccc"; } else { btn.disabled = false; btn.innerText = "üèÜ Avaliar Desempenho do Dia"; btn.style.background = "linear-gradient(135deg, #4a90e2, #9b59b6)"; } }
    function fireConfetti(isBig) { const count = isBig ? 150 : 50; confetti({ particleCount: count, spread: 70, origin: { y: 0.6 } }); }
    
    // --- CORE TASKS ---
    function toggleTask(index) { const task = allTasks[viewIndex][index]; task.done = !task.done; task.completedAt = task.done ? new Date().toISOString() : null; saveAll(); renderTasks(); }
    function renderTasks() {
        const list = document.getElementById('taskList'); list.innerHTML = ''; let tasksToShow = allTasks[viewIndex];
        tasksToShow.forEach((task, index) => {
            const li = document.createElement('li'); li.className = task.done ? 'completed' : ''; li.style.borderLeftColor = categoryColors[task.category] || categoryColors['outros'];
            let badges = '';
            if (task.done && task.completedAt) {
                const [sH, sM] = task.time.split(':').map(Number); const d = new Date(task.completedAt);
                const diffMin = (d.getHours()*60 + d.getMinutes()) - (sH*60 + sM);
                if (diffMin > 15) badges += ` <span class="punctuality-badge" style="color:var(--danger)">Atraso</span>`; else if (diffMin < -15) badges += ` <span class="punctuality-badge" style="color:var(--success)">Adiantado</span>`; else badges += ` <span class="punctuality-badge" style="color:var(--cat-casa)">‚òÖ Pontual</span>`;
            }
            li.innerHTML = ` <input type="checkbox" class="task-checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${index})"> <div class="task-info"> <div class="task-header"><span class="task-time">${task.time}</span><span class="cat-badge" style="background:${li.style.borderLeftColor}">${task.category}</span>${badges}</div> <span class="task-desc">${task.title}</span> </div> <div class="action-container"><button class="list-btn edit-btn-icon" onclick="startEdit(${index})">‚úé</button><button class="list-btn delete-btn-icon" onclick="deleteTask(${index})">&times;</button></div>`;
            list.appendChild(li);
        });
    }

    // --- UTILS ---
    function renderQuote() { const i = Math.floor(Math.random() * dailyQuotes.length); document.getElementById('dailyQuote').textContent = `"${dailyQuotes[i]}"`; }
    function saveJournal() { localStorage.setItem('dailyJournal', document.getElementById('journalInput').value); }
    function loadJournal() { const t = localStorage.getItem('dailyJournal'); if(t) document.getElementById('journalInput').value = t; }
    function toggleTheme() { document.body.classList.toggle('dark-mode'); const isDark = document.body.classList.contains('dark-mode'); document.getElementById('themeBtn').innerText = isDark ? "‚òÄÔ∏è" : "üåô"; localStorage.setItem('darkMode', isDark); }
    function loadTheme() { const isDark = localStorage.getItem('darkMode') === 'true'; if (isDark) { document.body.classList.add('dark-mode'); document.getElementById('themeBtn').innerText = "‚òÄÔ∏è"; } else { document.getElementById('themeBtn').innerText = "üåô"; } }
    
    function exportBackup() { const data = { tasks: localStorage.getItem('myRoutineTasksV7'), history: localStorage.getItem('routineHistoryV7'), medals: localStorage.getItem('userMedals'), level: localStorage.getItem('userLevel'), journal: localStorage.getItem('dailyJournal'), date: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const dateStr = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-'); a.download = `backup-v17-${dateStr}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    function importBackup(inputElement) { const file = inputElement.files[0]; if (!file) return; if(!confirm('Restaurar backup substituir√° TODOS os dados. Continuar?')) { inputElement.value = ''; return; } const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if (data.tasks) { localStorage.setItem('myRoutineTasksV7', data.tasks); if(data.history) localStorage.setItem('routineHistoryV7', data.history); if(data.medals) localStorage.setItem('userMedals', data.medals); if(data.level) localStorage.setItem('userLevel', data.level); if(data.journal) localStorage.setItem('dailyJournal', data.journal); alert('Restaurado!'); location.reload(); } } catch (err) { alert('Erro ao ler.'); } }; reader.readAsText(file); }

    function updateHeaderDate() { document.getElementById('headerDate').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }); }
    function checkDailyReset() { const todayStr = new Date().toLocaleDateString(); const lastSavedDate = localStorage.getItem('lastRoutineDateV7'); if (lastSavedDate && lastSavedDate !== todayStr) { archiveTasks(lastSavedDate); for(let i=0; i<7; i++) allTasks[i] = allTasks[i].map(t => ({ ...t, done: false, completedAt: null })); saveAll(); } localStorage.setItem('lastRoutineDateV7', todayStr); }
    function archiveTasks(dateLabel) { Object.values(allTasks).forEach(dayList => { dayList.forEach(task => { historyLog.push({ date: dateLabel, title: task.title, category: task.category, scheduledTime: task.time, done: task.done, completedAt: task.completedAt || null }); }); }); if (historyLog.length > 500) historyLog = historyLog.slice(historyLog.length - 500); localStorage.setItem('routineHistoryV7', JSON.stringify(historyLog)); }
    function openDashboard() { document.getElementById('dashboardPanel').classList.add('open'); checkEvaluationButton(); updateSkippedStats(); }
    function closeDashboard() { document.getElementById('dashboardPanel').classList.remove('open'); }
    function clearHistory() { if(confirm('Resetar TUDO?')) { localStorage.clear(); location.reload(); } }
    function switchViewDay(dayIndex) { viewIndex = dayIndex; cancelEdit(); renderDayButtons(); renderTasks(); }
    function renderDayButtons() { for(let i=0; i<7; i++) { const btn = document.getElementById(`btnDay${i}`); btn.classList.remove('active', 'today-indicator'); if (i === viewIndex) btn.classList.add('active'); if (i === todayIndex) btn.classList.add('today-indicator'); } }
    function startEdit(index) { editingTaskIndex = index; const task = allTasks[viewIndex][index]; document.getElementById('taskTime').value = task.time; document.getElementById('taskDesc').value = task.title; document.getElementById('taskCategory').value = task.category; document.getElementById('mainActionBtn').innerHTML = "üíæ"; document.getElementById('mainActionBtn').classList.add('editing-mode'); document.getElementById('cancelEditBtn').style.display = 'inline-block'; document.getElementById('repeatWrapper').classList.add('disabled'); }
    function cancelEdit() { editingTaskIndex = null; document.getElementById('taskTime').value = ''; document.getElementById('taskDesc').value = ''; document.getElementById('mainActionBtn').innerHTML = "+"; document.getElementById('mainActionBtn').classList.remove('editing-mode'); document.getElementById('cancelEditBtn').style.display = 'none'; document.getElementById('repeatWrapper').classList.remove('disabled'); }
    function handleAction() { const timeInput = document.getElementById('taskTime'); const descInput = document.getElementById('taskDesc'); const catInput = document.getElementById('taskCategory'); if (!timeInput.value || !descInput.value) { alert('Preencha os dados!'); return; } if (editingTaskIndex !== null) { allTasks[viewIndex][editingTaskIndex].time = timeInput.value; allTasks[viewIndex][editingTaskIndex].title = descInput.value; allTasks[viewIndex][editingTaskIndex].category = catInput.value; allTasks[viewIndex].sort((a, b) => a.time.localeCompare(b.time)); saveAll(); renderTasks(); updateTimer(); cancelEdit(); } else { let targetDays = selectedRepeats.size > 0 ? Array.from(selectedRepeats) : [viewIndex]; targetDays.forEach(day => { allTasks[day].push({ time: timeInput.value, title: descInput.value, category: catInput.value, done: false, completedAt: null }); allTasks[day].sort((a, b) => a.time.localeCompare(b.time)); }); saveAll(); renderTasks(); updateTimer(); descInput.value = ''; selectedRepeats.clear(); document.querySelectorAll('.repeat-btn').forEach(b => b.classList.remove('selected')); } }
    function deleteTask(index) { if(confirm('Excluir?')) { allTasks[viewIndex].splice(index, 1); saveAll(); renderTasks(); updateTimer(); cancelEdit(); } }
    function saveAll() { localStorage.setItem('myRoutineTasksV7', JSON.stringify(allTasks)); }
    function toggleRepeat(dayIndex) { if(editingTaskIndex !== null) return; const btn = document.getElementById(`rep${dayIndex}`); if (selectedRepeats.has(dayIndex)) { selectedRepeats.delete(dayIndex); btn.classList.remove('selected'); } else { selectedRepeats.add(dayIndex); btn.classList.add('selected'); } }
    function toggleDetails() { const c = document.getElementById('appContainer'); c.classList.toggle('details-open'); document.getElementById('toggleBtn').innerHTML = c.classList.contains('details-open') ? "&times;" : "‚ò∞"; }
    function toggleAlarm() { alarmEnabled = !alarmEnabled; const btn = document.getElementById('alarmToggle'); if(alarmEnabled){ btn.classList.add('active'); alarmAudio.play().then(()=>{alarmAudio.pause();alarmAudio.currentTime=0;}).catch(e=>{}); if(Notification.permission!=="granted")Notification.requestPermission(); }else{ btn.classList.remove('active'); } }
    function checkAlarm(h,m){ if(!alarmEnabled)return; const t=`${formatTime(h)}:${formatTime(m)}`; if(lastAlarmTime===t)return; const tasks=allTasks[todayIndex].filter(tk=>tk.time===t&&!tk.done); if(tasks.length>0){ alarmAudio.currentTime=0; alarmAudio.play().catch(e=>{}); if(Notification.permission==="granted")new Notification("Rotina!",{body:tasks[0].title,icon:"icon-512.png"}); lastAlarmTime=t; } }
    function updateTimer(){ const daily=allTasks[todayIndex]; const elN=document.getElementById('timerTaskName'); const elC=document.getElementById('timerCountdown'); const elNext=document.getElementById('timerNextLabel'); const elCi=document.getElementById('timerCircle'); const now=new Date(); const curH=now.getHours();const curM=now.getMinutes();const curS=now.getSeconds(); if(curS===0)checkAlarm(curH,curM); const curTotal=curH*60+curM; if(!daily||daily.length===0){ elN.textContent="Dia Livre";elC.textContent="--:--";elNext.textContent="";elCi.style.stroke="#eee";return;} let act=-1,nxt=-1; const mins=daily.map(t=>{const[h,m]=t.time.split(':').map(Number);return h*60+m;}); for(let i=0;i<mins.length;i++){if(curTotal>=mins[i])act=i;else{nxt=i;break;}} const circum=2*Math.PI*110; if(act===-1&&nxt!==-1){ elN.textContent="Prepare-se"; elNext.textContent=`Pr√≥x: ${daily[nxt].title}`; elC.textContent=`-${(mins[nxt]-curTotal-1).toString().padStart(2,'0')}:${(60-curS).toString().padStart(2,'0')}`; elCi.style.strokeDashoffset=0; return;} if(nxt===-1){elN.textContent="Tudo Feito!";elC.textContent="00:00";elCi.style.strokeDashoffset=0;return;} if(act!==-1&&nxt!==-1){ const cur=daily[act]; elN.textContent=cur.title; elNext.textContent=`Depois: ${daily[nxt].title}`; elCi.style.stroke=categoryColors[cur.category]||'#999'; const rem=((mins[nxt]-mins[act])*60)-(((curTotal-mins[act])*60)+curS); elC.textContent=`${Math.floor(rem/60).toString().padStart(2,'0')}:${(rem%60).toString().padStart(2,'0')}`; elCi.style.strokeDashoffset=circum*(1-(rem/((mins[nxt]-mins[act])*60))); } }
    function formatTime(v){return v<10?`0${v}`:v;}
</script>
</body>
</html>