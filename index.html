<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotina Pro V18 - Gamer HUD</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b0c15">
    <link rel="apple-touch-icon" href="icon-512.png">
    <link rel="icon" type="image/png" href="icon-512.png">

    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            /* PALETA GAMER / CYBERPUNK (Default Dark) */
            --bg: #0b0c15; 
            --card-bg: rgba(20, 22, 35, 0.95);
            --text: #e0e6ed; 
            --text-muted: #8b9bb4;
            
            /* NEON ACCENTS */
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-green: #00ff9d;
            --neon-gold: #ffd700;
            --neon-red: #ff2a6d;
            
            /* UI Elements */
            --border-color: #2a2e45;
            --input-bg: #151725;
            --hud-border: 1px solid rgba(0, 243, 255, 0.3);
            --shadow: 0 0 15px rgba(0, 243, 255, 0.05);
            --glow-text: 0 0 5px rgba(0, 243, 255, 0.5);

            /* Categorias (Vers√£o Neon) */
            --cat-trabalho: #00f3ff; 
            --cat-saude: #00ff9d; 
            --cat-estudos: #bc13fe;
            --cat-casa: #ff9100; 
            --cat-lazer: #ff2a6d; 
            --cat-eclesiastico: #ffd700; 
            --cat-outros: #8b9bb4;
        }

        /* MODO CLARO (Hologr√°fico) */
        body.light-mode {
            --bg: #eef2f5; 
            --card-bg: #ffffff;
            --text: #2d3436; 
            --text-muted: #636e72;
            --border-color: #dfe6e9;
            --input-bg: #f8f9fa;
            --hud-border: 1px solid #b2bec3;
            --shadow: 0 5px 20px rgba(0,0,0,0.05);
            --glow-text: none;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Rajdhani', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
            transition: 0.3s;
            background-image: radial-gradient(circle at 50% 0%, rgba(0, 243, 255, 0.1) 0%, transparent 50%);
        }
        
        .app-container {
            width: 100%; max-width: 500px; background: var(--card-bg);
            box-shadow: var(--shadow); min-height: 100vh;
            display: flex; flex-direction: column; position: relative; overflow-x: hidden;
            border-left: 1px solid rgba(255,255,255,0.05);
            border-right: 1px solid rgba(255,255,255,0.05);
        }

        /* --- TOASTS GAMER (Notifica√ß√µes) --- */
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .gamer-toast {
            background: rgba(11, 12, 21, 0.95);
            color: #fff;
            padding: 12px 20px;
            border-radius: 4px;
            border-left: 4px solid var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex; align-items: center; gap: 10px;
            transform: translateX(120%);
            animation: slideIn 0.3s forwards;
            pointer-events: auto;
            backdrop-filter: blur(5px);
            min-width: 250px;
        }
        .gamer-toast.success { border-color: var(--neon-green); box-shadow: 0 0 15px rgba(0, 255, 157, 0.3); }
        .gamer-toast.warning { border-color: var(--neon-gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .gamer-toast.error { border-color: var(--neon-red); box-shadow: 0 0 15px rgba(255, 42, 109, 0.3); }
        .gamer-toast.level-up { 
            border-color: var(--neon-purple); 
            background: linear-gradient(90deg, rgba(188,19,254,0.1), rgba(11,12,21,0.95));
            box-shadow: 0 0 20px var(--neon-purple);
        }

        @keyframes slideIn { to { transform: translateX(0); } }
        @keyframes slideOut { to { transform: translateX(120%); opacity: 0; } }

        /* --- HUD DE MEDALHAS --- */
        .gamification-bar {
            background: rgba(0,0,0,0.2); padding: 12px 15px; 
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; gap: 8px;
            backdrop-filter: blur(10px);
        }
        .level-badge { 
            background: rgba(0, 243, 255, 0.1); color: var(--neon-blue); 
            border: 1px solid var(--neon-blue);
            padding: 4px 10px; border-radius: 4px; 
            font-size: 0.9rem; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }
        
        .medals-display { display: flex; gap: 12px; flex-grow: 1; justify-content: center; }
        .medal-count { display: flex; align-items: center; gap: 4px; font-size: 0.9rem; font-weight: bold; }
        .medal-count span:first-child { filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); }

        /* --- HEADER --- */
        .header-section { padding: 20px; text-align: center; }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-icon { background: none; border: none; font-size: 1.6rem; cursor: pointer; color: var(--text-muted); transition: 0.3s; }
        .btn-icon:hover { color: var(--neon-blue); transform: scale(1.1); text-shadow: 0 0 8px var(--neon-blue); }
        .btn-icon.active { color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); }
        
        h1 { margin: 0; font-size: 1.2rem; color: var(--text); letter-spacing: 2px; text-transform: uppercase; }
        .subtitle { font-size: 1rem; color: var(--neon-blue); font-weight: 700; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; text-shadow: var(--glow-text); }
        
        .quote-box {
            font-size: 0.9rem; font-style: italic; color: var(--text-muted); 
            margin: 5px 0 20px 0; min-height: 30px; padding: 0 15px; border-left: 2px solid var(--border-color);
        }

        /* --- TIMER FUTURISTA --- */
        .timer-wrapper { position: relative; width: 200px; height: 200px; margin: 0 auto; filter: drop-shadow(0 0 10px rgba(0,0,0,0.3)); }
        .timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .timer-circle-bg { fill: none; stroke: var(--border-color); stroke-width: 6; opacity: 0.3; }
        .timer-circle-progress { 
            fill: none; stroke: var(--cat-outros); stroke-width: 6; stroke-linecap: round; 
            stroke-dasharray: 691; stroke-dashoffset: 691; 
            transition: stroke-dashoffset 1s linear, stroke 0.5s; 
            filter: drop-shadow(0 0 5px currentColor);
        }
        .timer-info { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .timer-current-task { font-size: 1.1rem; font-weight: 700; margin-bottom: 5px; color: var(--text); text-transform: uppercase; letter-spacing: 1px; }
        .timer-countdown { font-size: 2.8rem; font-weight: 700; margin: 0; font-family: 'Rajdhani', monospace; text-shadow: 0 0 10px rgba(255,255,255,0.1); }
        .timer-next { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 4px; border: 1px solid var(--border-color); }

        /* --- PAIN√âIS DESLIZANTES --- */
        .dashboard-panel, .details-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg); z-index: 200; 
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            overflow-y: auto; padding: 25px; box-sizing: border-box; color: var(--text);
        }
        .dashboard-panel.open { transform: translateY(0); }
        .details-panel { 
            background: var(--card-bg); 
            backdrop-filter: blur(15px);
            border-top: 1px solid var(--neon-blue);
            box-shadow: 0 -10px 30px rgba(0, 243, 255, 0.1);
            max-height: 0; opacity: 0; position: relative; transform: none; top: auto; left: auto; z-index: 10;
        }
        .app-container.details-open .details-panel { max-height: 80vh; opacity: 1; padding-bottom: 100px; }

        .dash-card { 
            background: var(--input-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; 
            border: 1px solid var(--border-color); box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
        }
        .dash-card::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--neon-blue); opacity: 0.5; }
        
        .dash-title { font-size: 0.9rem; color: var(--neon-blue); font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 15px; }
        .big-number { font-size: 3rem; font-weight: 700; line-height: 1; text-shadow: 0 0 10px rgba(255,255,255,0.1); }

        /* BUTTONS GAMER */
        .evaluate-btn {
            width: 100%; padding: 18px; 
            background: linear-gradient(90deg, rgba(0, 243, 255, 0.1), rgba(188, 19, 254, 0.1));
            color: var(--neon-blue); border: 1px solid var(--neon-blue);
            border-radius: 4px; font-size: 1.1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px;
            cursor: pointer; box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); margin-bottom: 25px;
            display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s;
            font-family: 'Rajdhani', sans-serif;
        }
        .evaluate-btn:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 25px var(--neon-blue); }
        .evaluate-btn:disabled { background: #222; border-color: #444; color: #666; cursor: not-allowed; box-shadow: none; }

        /* JOURNAL */
        .journal-area {
            width: 100%; height: 120px; padding: 15px; border-radius: 4px; 
            border: 1px solid var(--border-color); background: rgba(0,0,0,0.2); 
            color: var(--text); font-family: 'Rajdhani', sans-serif; font-size: 1rem; resize: none; 
        }
        .journal-area:focus { outline: none; border-color: var(--neon-purple); box-shadow: 0 0 10px rgba(188, 19, 254, 0.2); }

        /* LISTA & INPUTS */
        .day-selector { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .day-btn { 
            width: 40px; height: 40px; border-radius: 8px; border: 1px solid var(--border-color); 
            background: var(--input-bg); color: var(--text-muted); font-weight: bold; cursor: pointer; transition: 0.2s;
            font-family: 'Rajdhani', sans-serif; font-size: 1.1rem;
        }
        .day-btn.active { background: var(--neon-blue); color: #000; border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 243, 255, 0.4); }
        .day-btn.today-indicator { border-color: var(--neon-green); color: var(--neon-green); }
        .day-btn.active.today-indicator { color: #000; background: var(--neon-green); border-color: var(--neon-green); }

        .input-group { background: var(--input-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px; position: relative; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .full-width { display: flex; gap: 10px; }
        
        input, select { 
            border: 1px solid var(--border-color); padding: 12px; border-radius: 4px; 
            width: 100%; background: rgba(0,0,0,0.3); color: var(--text); 
            font-family: 'Rajdhani', sans-serif; font-size: 1.1rem;
        }
        input:focus, select:focus { outline: none; border-color: var(--neon-blue); }

        button.add-btn { 
            background: var(--neon-blue); color: #000; border: none; padding: 0 25px; 
            border-radius: 4px; cursor: pointer; font-size: 1.5rem; min-width: 60px; font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.3); transition: 0.2s;
        }
        button.add-btn:hover { box-shadow: 0 0 20px rgba(0, 243, 255, 0.6); transform: scale(1.05); }
        button.add-btn.editing-mode { background: var(--neon-purple); box-shadow: 0 0 10px rgba(188, 19, 254, 0.3); }

        ul { list-style: none; padding: 0; margin: 0; }
        li { 
            display: flex; align-items: center; background: var(--input-bg); 
            border: 1px solid var(--border-color); border-left-width: 4px;
            padding: 18px; margin-bottom: 10px; border-radius: 4px; 
            color: var(--text); transition: 0.2s;
        }
        li:hover { transform: translateX(5px); border-color: rgba(255,255,255,0.2); }
        li.completed { opacity: 0.5; filter: grayscale(0.8); }
        li.completed .task-desc { text-decoration: line-through; color: var(--text-muted); }
        
        .task-checkbox { 
            appearance: none; width: 24px; height: 24px; border: 2px solid var(--text-muted); border-radius: 4px; 
            margin-right: 15px; cursor: pointer; display: grid; place-items: center; transition: 0.2s;
        }
        .task-checkbox::after { content: '‚úì'; font-weight: bold; color: #000; display: none; }
        .task-checkbox:checked { background: var(--neon-green); border-color: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        .task-checkbox:checked::after { display: block; }

        .task-info { flex-grow: 1; }
        .task-header { display: flex; align-items: center; gap: 10px; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .task-desc { font-size: 1.1rem; font-weight: 500; }
        
        .cat-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; color: #000; font-weight: 800; box-shadow: 0 0 5px currentColor; }
        .punctuality-badge { font-size: 0.75rem; margin-left: auto; font-weight: bold; letter-spacing: 1px; }

        .action-container { display: flex; gap: 15px; margin-left: 15px; }
        .list-btn { background: transparent; border: none; cursor: pointer; font-size: 1.2rem; padding: 0; color: var(--text-muted); transition: 0.2s; }
        .list-btn:hover { color: var(--neon-blue); transform: scale(1.2); }
        .delete-btn-icon:hover { color: var(--neon-red); }

        /* BACKUP BUTTONS */
        .backup-btn { 
            width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 4px; border: 1px solid var(--border-color); 
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; 
            font-family: 'Rajdhani', sans-serif; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
        }
        .btn-download { background: rgba(255,255,255,0.05); color: var(--text); }
        .btn-download:hover { background: rgba(255,255,255,0.1); border-color: var(--neon-blue); color: var(--neon-blue); }
        .btn-restore { background: transparent; color: var(--text-muted); border-style: dashed; }
        .btn-restore:hover { color: var(--text); border-color: var(--text); }

        .fab-toggle { 
            position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; 
            background: var(--neon-blue); color: #000; border-radius: 50%; border: none;
            display: flex; justify-content: center; align-items: center; font-size: 1.8rem; 
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.5); cursor: pointer; z-index: 100; transition: 0.3s;
        }
        .fab-toggle:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 0 30px rgba(0, 243, 255, 0.8); }

        /* STATS (Negligenciadas) */
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 10px 0; font-size: 1rem; }
        .bad-stat { color: var(--neon-red); text-shadow: 0 0 5px rgba(255, 42, 109, 0.5); }

    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="app-container" id="appContainer">
    
    <div class="gamification-bar">
        <div class="level-badge" id="userLevelBadge">LVL 1</div>
        <div class="medals-display">
            <div class="medal-count" style="color:var(--neon-gold)"><span class="medal-icon">ü•á</span> <span id="cntGold">0</span>/10</div>
            <div class="medal-count" style="color:#C0C0C0"><span class="medal-icon">ü•à</span> <span id="cntSilver">0</span>/20</div>
            <div class="medal-count" style="color:#CD7F32"><span class="medal-icon">ü•â</span> <span id="cntBronze">0</span>/30</div>
        </div>
        <button class="btn-icon" onclick="toggleTheme()" id="themeBtn" title="Alternar Modo Hologr√°fico">üëÅÔ∏è</button>
    </div>

    <div class="header-section">
        <div class="header-top-row">
            <h1 id="headerDate">SYSTEM READY</h1>
            <div class="header-actions">
                <button class="btn-icon" id="alarmToggle" onclick="toggleAlarm()" title="Alarme Sonoro">üîî</button>
                <button class="btn-icon" onclick="openDashboard()" title="Painel de Controle">üìä</button>
            </div>
        </div>
        <div class="subtitle" id="dayStatus">Status: Online</div>
        <div class="quote-box" id="dailyQuote">"Carregando dados..."</div>
        
        <div class="timer-wrapper">
            <svg class="timer-svg" viewBox="0 0 240 240">
                <circle class="timer-circle-bg" cx="120" cy="120" r="110"></circle>
                <circle class="timer-circle-progress" id="timerCircle" cx="120" cy="120" r="110"></circle>
            </svg>
            <div class="timer-info">
                <div class="timer-current-task" id="timerTaskName">AGUARDANDO</div>
                <div class="timer-countdown" id="timerCountdown">00:00</div>
                <div class="timer-next" id="timerNextLabel">--</div>
            </div>
        </div>
    </div>

    <div class="dashboard-panel" id="dashboardPanel">
        <div class="dash-header" style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="margin:0; text-transform:uppercase; letter-spacing:2px; color:var(--neon-blue);">Estat√≠sticas</h2>
            <button class="btn-icon" onclick="closeDashboard()">‚úï</button>
        </div>
        
        <button class="evaluate-btn" id="btnEvaluate" onclick="evaluateDay()">
            <span>üèÜ</span> Avaliar Miss√£o Di√°ria
        </button>

        <div class="dash-card">
            <div class="dash-title">‚ö†Ô∏è Pontos de Aten√ß√£o (Negligenciadas)</div>
            <div id="dashSkippedList">
                <p style="font-size:0.9rem; color:var(--text-muted);">Sem dados suficientes.</p>
            </div>
        </div>

        <div class="dash-card">
            <div class="dash-title">Pr√≥ximo N√≠vel</div>
            <div style="font-size:0.9rem; line-height:1.5;">
                Objetivos para <strong>LEVEL UP</strong>:<br>
                <span style="color:var(--neon-gold)">10x Ouro</span> <small>(100% Pontual)</small> OU<br>
                <span style="color:#C0C0C0">20x Prata</span> <small>(>70% Pontual)</small> OU<br>
                <span style="color:#CD7F32">30x Bronze</span> <small>(>50% Conclu√≠do)</small>
            </div>
        </div>

        <div class="dash-card">
            <div class="dash-title">Log de Gratid√£o ‚úçÔ∏è</div>
            <textarea id="journalInput" class="journal-area" placeholder="Registre suas conquistas do dia aqui..." oninput="saveJournal()"></textarea>
        </div>

        <div style="margin-top:30px; border-top:1px dashed var(--border-color); padding-top:20px;">
            <div class="dash-title" style="margin-bottom:15px;">Data Management</div>
            <button class="backup-btn btn-download" onclick="exportBackup()">üì• Salvar Backup</button>
            <button class="backup-btn btn-restore" onclick="document.getElementById('backupInput').click()">üì§ Carregar Backup</button>
            <input type="file" id="backupInput" style="display:none" accept=".json" onchange="importBackup(this)">
        </div>
        
        <button onclick="clearHistory()" style="color:var(--neon-red); background:none; border:none; margin-top:20px; width:100%; text-transform:uppercase; letter-spacing:1px; cursor:pointer; font-weight:bold; opacity:0.7;">‚ö† Resetar Sistema ‚ö†</button>
        <div style="height:50px;"></div>
    </div>

    <div class="details-panel" id="detailsPanel">
        <div style="padding-top: 10px;">
            <h3 style="text-align:center; color:var(--neon-blue); margin-bottom:20px; text-transform:uppercase; letter-spacing:2px;">Configurar Rotina</h3>
            
            <div class="day-selector">
                <button class="day-btn" onclick="switchViewDay(0)" id="btnDay0">D</button>
                <button class="day-btn" onclick="switchViewDay(1)" id="btnDay1">S</button>
                <button class="day-btn" onclick="switchViewDay(2)" id="btnDay2">T</button>
                <button class="day-btn" onclick="switchViewDay(3)" id="btnDay3">Q</button>
                <button class="day-btn" onclick="switchViewDay(4)" id="btnDay4">Q</button>
                <button class="day-btn" onclick="switchViewDay(5)" id="btnDay5">S</button>
                <button class="day-btn" onclick="switchViewDay(6)" id="btnDay6">S</button>
            </div>

            <div class="input-group">
                <div class="input-row">
                    <input type="time" id="taskTime" required>
                    <select id="taskCategory">
                        <option value="trabalho">Trabalho</option>
                        <option value="eclesiastico">Eclesi√°stico</option>
                        <option value="saude">Sa√∫de</option>
                        <option value="estudos">Estudos</option>
                        <option value="casa">Casa</option>
                        <option value="lazer">Lazer</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="full-width">
                    <input type="text" id="taskDesc" placeholder="Nome da miss√£o..." required>
                    <button class="add-btn" id="mainActionBtn" onclick="handleAction()">+</button>
                </div>
                <div style="text-align: right;">
                    <button class="cancel-edit-btn" id="cancelEditBtn" onclick="cancelEdit()">Cancelar</button>
                </div>
                
                <div class="repeat-wrapper" id="repeatWrapper" style="margin-top:15px; border-top:1px solid var(--border-color); padding-top:10px;">
                    <span style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase;">Repetir em:</span>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <button class="repeat-btn" onclick="toggleRepeat(0)" id="rep0" style="width:30px; height:30px; border-radius:4px; border:1px solid var(--border-color); background:transparent; color:var(--text-muted); cursor:pointer;">D</button>
                        <button class="repeat-btn" onclick="toggleRepeat(1)" id="rep1" style="width:30px; height:30px; border-radius:4px; border:1px solid var(--border-color); background:transparent; color:var(--text-muted); cursor:pointer;">S</button>
                        <button class="repeat-btn" onclick="toggleRepeat(2)" id="rep2" style="width:30px; height:30px; border-radius:4px; border:1px solid var(--border-color); background:transparent; color:var(--text-muted); cursor:pointer;">T</button>
                        <button class="repeat-btn" onclick="toggleRepeat(3)" id="rep3" style="width:30px; height:30px; border-radius:4px; border:1px solid var(--border-color); background:transparent; color:var(--text-muted); cursor:pointer;">Q</button>
                        <button class="repeat-btn" onclick="toggleRepeat(4)" id="rep4" style="width:30px; height:30px; border-radius:4px; border:1px solid var(--border-color); background:transparent; color:var(--text-muted); cursor:pointer;">Q</button>
                        <button class="repeat-btn" onclick="toggleRepeat(5)" id="rep5" style="width:30px; height:30px; border-radius:4px; border:1px solid var(--border-color); background:transparent; color:var(--text-muted); cursor:pointer;">S</button>
                        <button class="repeat-btn" onclick="toggleRepeat(6)" id="rep6" style="width:30px; height:30px; border-radius:4px; border:1px solid var(--border-color); background:transparent; color:var(--text-muted); cursor:pointer;">S</button>
                    </div>
                </div>
            </div>

            <ul id="taskList"></ul>
            <div style="height: 50px;"></div>
        </div>
    </div>

    <button class="fab-toggle" id="toggleBtn" onclick="toggleDetails()">‚ò∞</button>

</div>

<script>
    // --- SISTEMA DE TOASTS (NOTIFICA√á√ïES GAMER) ---
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `gamer-toast ${type}`;
        
        let icon = '‚ÑπÔ∏è';
        if(type === 'success') icon = '‚úÖ';
        if(type === 'warning') icon = 'üèÜ';
        if(type === 'error') icon = '‚ö†Ô∏è';
        if(type === 'level-up') icon = 'üöÄ';

        toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
        container.appendChild(toast);

        // Remove ap√≥s 4 segundos (tempo da anima√ß√£o de sa√≠da)
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s forwards';
            setTimeout(() => { toast.remove(); }, 300);
        }, 4000);
    }

    // --- CORES & DADOS ---
    // Usando vari√°veis CSS para categorias neon
    const categoryColors = { 
        'trabalho': 'var(--cat-trabalho)', 
        'saude': 'var(--cat-saude)', 
        'estudos': 'var(--cat-estudos)', 
        'casa': 'var(--cat-casa)', 
        'lazer': 'var(--cat-lazer)', 
        'eclesiastico': 'var(--cat-eclesiastico)', 
        'outros': 'var(--cat-outros)' 
    };
    
    const emptyWeek = { 0:[], 1:[], 2:[], 3:[], 4:[], 5:[], 6:[] };
    let allTasks = JSON.parse(localStorage.getItem('myRoutineTasksV7')) || emptyWeek;
    let historyLog = JSON.parse(localStorage.getItem('routineHistoryV7')) || [];
    
    // MEDALHAS
    let medals = JSON.parse(localStorage.getItem('userMedals')) || { gold: 0, silver: 0, bronze: 0 };
    let userLevel = parseInt(localStorage.getItem('userLevel')) || 1;
    let lastEvaluationDate = localStorage.getItem('lastEvalDate');

    let todayIndex = new Date().getDay();
    let viewIndex = todayIndex; 
    let selectedRepeats = new Set();
    let editingTaskIndex = null;
    let alarmEnabled = false;
    let lastAlarmTime = null; 
    const alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

    const dailyQuotes = [
        "Tudo posso naquele que me fortalece.",
        "A disciplina √© a chave da liberdade.",
        "Seja forte e corajoso.",
        "O Senhor √© meu pastor e nada me faltar√°.",
        "Foco total na miss√£o de hoje.",
        "Pequenos progressos geram grandes resultados.",
        "O que voc√™ faz hoje define seu amanh√£."
    ];

    // --- INIT ---
    // Definir tema escuro como padr√£o se n√£o houver salvo
    if (localStorage.getItem('darkMode') === null) localStorage.setItem('darkMode', 'false'); // 'false' agora significa dark mode no visual gamer pois inverti a logica
    loadTheme();
    updateHeaderDate();
    checkDailyReset();
    renderDayButtons();
    updateMedalsUI();
    renderTasks();
    renderQuote();
    loadJournal();
    setInterval(updateTimer, 1000);
    updateTimer();
    checkEvaluationButton();

    // --- L√ìGICA DE NEGLIGENCIADAS ---
    function updateSkippedStats() {
        const container = document.getElementById('dashSkippedList'); 
        if (!container) return;
        
        if (historyLog.length === 0) {
            container.innerHTML = '<p style="font-size:0.9rem; color:var(--text-muted);">Sem dados suficientes.</p>';
            return;
        }

        const skippedMap = {}; 
        historyLog.forEach(t => { 
            if (!t.done) skippedMap[t.title] = (skippedMap[t.title] || 0) + 1; 
        });
        
        const sortedSkipped = Object.entries(skippedMap).sort((a,b) => b[1] - a[1]).slice(0, 3);
        container.innerHTML = '';
        
        if (sortedSkipped.length === 0) {
            container.innerHTML = '<p style="font-size:0.9rem; color:var(--neon-green);">Excelente! Nenhuma tarefa negligenciada.</p>';
        } else {
            sortedSkipped.forEach(([title, count]) => { 
                container.innerHTML += `
                    <div class="stat-row">
                        <span class="stat-name">${title}</span> 
                        <span class="stat-val bad-stat">${count}x</span>
                    </div>`; 
            });
        }
    }

    // --- L√ìGICA DE AVALIA√á√ÉO E MEDALHAS ---
    function evaluateDay() {
        const todayStr = new Date().toLocaleDateString();
        if (lastEvaluationDate === todayStr) {
            showToast("Miss√£o di√°ria j√° avaliada!", "info"); return;
        }

        const tasks = allTasks[todayIndex];
        if (!tasks || tasks.length === 0) { showToast("Sem miss√µes hoje.", "warning"); return; }

        const total = tasks.length;
        const completed = tasks.filter(t => t.done).length;
        let punctual = 0;

        tasks.forEach(t => {
            if (t.done && t.completedAt) {
                const [sH, sM] = t.time.split(':').map(Number);
                const d = new Date(t.completedAt);
                const diffMin = (d.getHours()*60 + d.getMinutes()) - (sH*60 + sM);
                if (Math.abs(diffMin) <= 15) punctual++;
            }
        });

        const punctualityRate = total > 0 ? punctual / total : 0;
        const completionRate = total > 0 ? completed / total : 0;
        let medalWon = null;

        if (punctualityRate >= 0.99) { 
            medals.gold++; medalWon = "ü•á OURO (Impec√°vel!)"; fireConfetti(true);
        } else if (punctualityRate >= 0.7) {
            medals.silver++; medalWon = "ü•à PRATA (Muito Bom!)"; fireConfetti(false);
        } else if (completionRate >= 0.5) {
            medals.bronze++; medalWon = "ü•â BRONZE (Completou)"; fireConfetti(false);
        } else {
            showToast("Miss√£o Falhou. Tente amanh√£.", "error");
        }

        if (medalWon) {
            showToast(`Conquista Desbloqueada: ${medalWon}`, "success");
            lastEvaluationDate = todayStr;
            localStorage.setItem('lastEvalDate', lastEvaluationDate);
            saveMedals();
            checkLevelUp();
        }
        checkEvaluationButton();
    }

    function checkLevelUp() {
        if (medals.gold >= 10 || medals.silver >= 20 || medals.bronze >= 30) {
            userLevel++;
            medals.gold = 0; medals.silver = 0; medals.bronze = 0;
            saveMedals();
            showToast(`LEVEL UP! Voc√™ alcan√ßou o N√≠vel ${userLevel}!`, "level-up");
            fireConfetti(true);
        }
        updateMedalsUI();
    }

    function saveMedals() { localStorage.setItem('userMedals', JSON.stringify(medals)); localStorage.setItem('userLevel', userLevel); updateMedalsUI(); }
    function updateMedalsUI() { document.getElementById('userLevelBadge').innerText = `LVL ${userLevel}`; document.getElementById('cntGold').innerText = medals.gold; document.getElementById('cntSilver').innerText = medals.silver; document.getElementById('cntBronze').innerText = medals.bronze; }
    function checkEvaluationButton() { const todayStr = new Date().toLocaleDateString(); const btn = document.getElementById('btnEvaluate'); if (lastEvaluationDate === todayStr) { btn.disabled = true; btn.innerHTML = "<span>‚úÖ</span> Miss√£o Cumprida"; btn.style.background = "rgba(0,0,0,0.3)"; } else { btn.disabled = false; btn.innerHTML = "<span>üèÜ</span> Avaliar Miss√£o Di√°ria"; btn.style.background = ""; } }
    function fireConfetti(isBig) { const count = isBig ? 150 : 50; confetti({ particleCount: count, spread: 70, origin: { y: 0.6 } }); }
    
    // --- CORE TASKS ---
    function toggleTask(index) {
        const task = allTasks[viewIndex][index];
        task.done = !task.done;
        task.completedAt = task.done ? new Date().toISOString() : null;
        saveAll(); renderTasks();
    }
    
    function renderTasks() {
        const list = document.getElementById('taskList'); list.innerHTML = '';
        let tasksToShow = allTasks[viewIndex];
        
        // Ordenar por hora
        tasksToShow.sort((a, b) => a.time.localeCompare(b.time));

        tasksToShow.forEach((task, index) => {
            const li = document.createElement('li'); 
            li.className = task.done ? 'completed' : '';
            // Aplicar cor da categoria na borda
            const catVar = categoryColors[task.category] || categoryColors['outros'];
            li.style.borderLeftColor = catVar;
            li.style.boxShadow = `inset 4px 0 0 0 ${catVar}`; // Efeito neon interno na borda

            let badges = '';
            if (task.done && task.completedAt) {
                const [sH, sM] = task.time.split(':').map(Number); const d = new Date(task.completedAt);
                const diffMin = (d.getHours()*60 + d.getMinutes()) - (sH*60 + sM);
                if (diffMin > 15) badges += ` <span class="punctuality-badge" style="color:var(--neon-red)">ATRASO</span>`;
                else if (diffMin < -15) badges += ` <span class="punctuality-badge" style="color:var(--neon-green)">ADIANTADO</span>`;
                else badges += ` <span class="punctuality-badge" style="color:var(--cat-casa)">PONTUAL</span>`;
            }
            
            // Tradu√ß√£o visual de categoria para texto limpo
            const catLabel = `<span class="cat-badge" style="background:${catVar}; color:#000;">${task.category.toUpperCase()}</span>`;

            li.innerHTML = `
                <input type="checkbox" class="task-checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${index})">
                <div class="task-info">
                    <div class="task-header">
                        <span class="task-time" style="font-weight:bold; color:var(--text);">${task.time}</span>
                        ${catLabel}
                        ${badges}
                    </div>
                    <span class="task-desc">${task.title}</span>
                </div>
                <div class="action-container">
                    <button class="list-btn edit-btn-icon" onclick="startEdit(${index})">‚úé</button>
                    <button class="list-btn delete-btn-icon" onclick="deleteTask(${index})">‚úï</button>
                </div>`;
            list.appendChild(li);
        });
    }

    // --- UTILS ---
    function renderQuote() { const i = Math.floor(Math.random() * dailyQuotes.length); document.getElementById('dailyQuote').textContent = `"${dailyQuotes[i]}"`; }
    function saveJournal() { localStorage.setItem('dailyJournal', document.getElementById('journalInput').value); }
    function loadJournal() { const t = localStorage.getItem('dailyJournal'); if(t) document.getElementById('journalInput').value = t; }
    
    // THEME LOGIC (Invertido: Dark √© padr√£o, Light √© a op√ß√£o)
    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        const isLight = document.body.classList.contains('light-mode');
        localStorage.setItem('lightMode', isLight);
    }
    function loadTheme() {
        const isLight = localStorage.getItem('lightMode') === 'true';
        if (isLight) { document.body.classList.add('light-mode'); }
    }
    
    // BACKUP
    function exportBackup() {
        const data = { tasks: localStorage.getItem('myRoutineTasksV7'), history: localStorage.getItem('routineHistoryV7'), medals: localStorage.getItem('userMedals'), level: localStorage.getItem('userLevel'), journal: localStorage.getItem('dailyJournal'), date: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url;
        const dateStr = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-'); a.download = `backup-v18-${dateStr}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        showToast("Backup salvo!", "success");
    }
    function importBackup(inputElement) {
        const file = inputElement.files[0]; if (!file) return; 
        if(!confirm('CUIDADO: Restaurar backup substituir√° TODOS os dados atuais. Continuar?')) { inputElement.value = ''; return; }
        const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if (data.tasks) { localStorage.setItem('myRoutineTasksV7', data.tasks); if(data.history) localStorage.setItem('routineHistoryV7', data.history); if(data.medals) localStorage.setItem('userMedals', data.medals); if(data.level) localStorage.setItem('userLevel', data.level); if(data.journal) localStorage.setItem('dailyJournal', data.journal); showToast("Sistema Restaurado!", "success"); setTimeout(()=>location.reload(), 1000); } } catch (err) { showToast("Arquivo Corrompido.", "error"); } }; reader.readAsText(file);
    }

    function updateHeaderDate() { document.getElementById('headerDate').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }).toUpperCase(); }
    function checkDailyReset() { const todayStr = new Date().toLocaleDateString(); const lastSavedDate = localStorage.getItem('lastRoutineDateV7'); if (lastSavedDate && lastSavedDate !== todayStr) { archiveTasks(lastSavedDate); for(let i=0; i<7; i++) allTasks[i] = allTasks[i].map(t => ({ ...t, done: false, completedAt: null })); saveAll(); } localStorage.setItem('lastRoutineDateV7', todayStr); }
    function archiveTasks(dateLabel) { Object.values(allTasks).forEach(dayList => { dayList.forEach(task => { historyLog.push({ date: dateLabel, title: task.title, category: task.category, scheduledTime: task.time, done: task.done, completedAt: task.completedAt || null }); }); }); if (historyLog.length > 500) historyLog = historyLog.slice(historyLog.length - 500); localStorage.setItem('routineHistoryV7', JSON.stringify(historyLog)); }
    function openDashboard() { document.getElementById('dashboardPanel').classList.add('open'); checkEvaluationButton(); updateSkippedStats(); }
    function closeDashboard() { document.getElementById('dashboardPanel').classList.remove('open'); }
    function clearHistory() { if(confirm('RESETAR F√ÅBRICA? Isso apaga tudo.')) { localStorage.clear(); location.reload(); } }
    function switchViewDay(dayIndex) { viewIndex = dayIndex; cancelEdit(); renderDayButtons(); renderTasks(); }
    function renderDayButtons() { for(let i=0; i<7; i++) { const btn = document.getElementById(`btnDay${i}`); btn.classList.remove('active', 'today-indicator'); if (i === viewIndex) btn.classList.add('active'); if (i === todayIndex) btn.classList.add('today-indicator'); } }
    
    // CRUD
    function startEdit(index) { editingTaskIndex = index; const task = allTasks[viewIndex][index]; document.getElementById('taskTime').value = task.time; document.getElementById('taskDesc').value = task.title; document.getElementById('taskCategory').value = task.category; document.getElementById('mainActionBtn').innerHTML = "üíæ"; document.getElementById('mainActionBtn').classList.add('editing-mode'); document.getElementById('cancelEditBtn').style.display = 'inline-block'; document.getElementById('repeatWrapper').style.opacity = '0.3'; document.getElementById('repeatWrapper').style.pointerEvents = 'none'; }
    function cancelEdit() { editingTaskIndex = null; document.getElementById('taskTime').value = ''; document.getElementById('taskDesc').value = ''; document.getElementById('mainActionBtn').innerHTML = "+"; document.getElementById('mainActionBtn').classList.remove('editing-mode'); document.getElementById('cancelEditBtn').style.display = 'none'; document.getElementById('repeatWrapper').style.opacity = '1'; document.getElementById('repeatWrapper').style.pointerEvents = 'auto'; }
    function handleAction() { 
        const timeInput = document.getElementById('taskTime'); const descInput = document.getElementById('taskDesc'); const catInput = document.getElementById('taskCategory'); 
        if (!timeInput.value || !descInput.value) { showToast("Dados incompletos!", "warning"); return; } 
        if (editingTaskIndex !== null) { 
            allTasks[viewIndex][editingTaskIndex].time = timeInput.value; allTasks[viewIndex][editingTaskIndex].title = descInput.value; allTasks[viewIndex][editingTaskIndex].category = catInput.value; 
            saveAll(); renderTasks(); updateTimer(); cancelEdit(); showToast("Tarefa atualizada.", "info");
        } else { 
            let targetDays = selectedRepeats.size > 0 ? Array.from(selectedRepeats) : [viewIndex]; 
            targetDays.forEach(day => { allTasks[day].push({ time: timeInput.value, title: descInput.value, category: catInput.value, done: false, completedAt: null }); }); 
            saveAll(); renderTasks(); updateTimer(); descInput.value = ''; selectedRepeats.clear(); 
            document.querySelectorAll('.repeat-btn').forEach(b => { b.style.background='transparent'; b.style.color='var(--text-muted)'; });
            showToast("Nova miss√£o adicionada!", "success");
        } 
    }
    function deleteTask(index) { if(confirm('Abortar miss√£o? (Excluir)')) { allTasks[viewIndex].splice(index, 1); saveAll(); renderTasks(); updateTimer(); cancelEdit(); showToast("Miss√£o abortada.", "error"); } }
    function saveAll() { localStorage.setItem('myRoutineTasksV7', JSON.stringify(allTasks)); }
    
    function toggleRepeat(dayIndex) { 
        if(editingTaskIndex !== null) return; 
        const btn = document.getElementById(`rep${dayIndex}`); 
        if (selectedRepeats.has(dayIndex)) { 
            selectedRepeats.delete(dayIndex); 
            btn.style.background = 'transparent'; btn.style.color = 'var(--text-muted)'; btn.style.borderColor = 'var(--border-color)';
        } else { 
            selectedRepeats.add(dayIndex); 
            btn.style.background = 'var(--neon-blue)'; btn.style.color = '#000'; btn.style.borderColor = 'var(--neon-blue)';
        } 
    }
    
    function toggleDetails() { const c = document.getElementById('appContainer'); c.classList.toggle('details-open'); document.getElementById('toggleBtn').innerHTML = c.classList.contains('details-open') ? "‚úï" : "‚ò∞"; }
    function toggleAlarm() { alarmEnabled = !alarmEnabled; const btn = document.getElementById('alarmToggle'); if(alarmEnabled){ btn.classList.add('active'); alarmAudio.play().then(()=>{alarmAudio.pause();alarmAudio.currentTime=0;}).catch(e=>{}); if(Notification.permission!=="granted")Notification.requestPermission(); showToast("Alarme Ativado", "success"); }else{ btn.classList.remove('active'); showToast("Alarme Desativado", "info"); } }
    
    function checkAlarm(h,m){ if(!alarmEnabled)return; const t=`${formatTime(h)}:${formatTime(m)}`; if(lastAlarmTime===t)return; const tasks=allTasks[todayIndex].filter(tk=>tk.time===t&&!tk.done); if(tasks.length>0){ alarmAudio.currentTime=0; alarmAudio.play().catch(e=>{}); if(Notification.permission==="granted")new Notification("Rotina!",{body:tasks[0].title,icon:"icon-512.png"}); lastAlarmTime=t; showToast(`Hora de: ${tasks[0].title}`, "warning"); } }
    
    function updateTimer(){ 
        const daily=allTasks[todayIndex]; const elN=document.getElementById('timerTaskName'); const elC=document.getElementById('timerCountdown'); const elNext=document.getElementById('timerNextLabel'); const elCi=document.getElementById('timerCircle'); const now=new Date(); const curH=now.getHours();const curM=now.getMinutes();const curS=now.getSeconds(); if(curS===0)checkAlarm(curH,curM); const curTotal=curH*60+curM; 
        if(!daily||daily.length===0){ elN.textContent="MODO LIVRE";elC.textContent="--:--";elNext.textContent="Sem miss√µes";elCi.style.stroke="var(--border-color)";return;} 
        let act=-1,nxt=-1; const mins=daily.map(t=>{const[h,m]=t.time.split(':').map(Number);return h*60+m;}); for(let i=0;i<mins.length;i++){if(curTotal>=mins[i])act=i;else{nxt=i;break;}} 
        const circum=2*Math.PI*110; 
        if(act===-1&&nxt!==-1){ elN.textContent="PREPARAR"; elNext.textContent=`PR√ìX: ${daily[nxt].title}`; elC.textContent=`-${(mins[nxt]-curTotal-1).toString().padStart(2,'0')}:${(60-curS).toString().padStart(2,'0')}`; elCi.style.strokeDashoffset=0; return;} 
        if(nxt===-1){elN.textContent="TUDO FEITO";elC.textContent="00:00";elCi.style.strokeDashoffset=0;return;} 
        if(act!==-1&&nxt!==-1){ 
            const cur=daily[act]; elN.textContent=cur.title; elNext.textContent=`DEPOIS: ${daily[nxt].title}`; 
            // Cor do timer baseada na categoria
            const catColor = getComputedStyle(document.documentElement).getPropertyValue(`--cat-${cur.category}`).trim() || '#fff';
            elCi.style.stroke=catColor; 
            const rem=((mins[nxt]-mins[act])*60)-(((curTotal-mins[act])*60)+curS); 
            elC.textContent=`${Math.floor(rem/60).toString().padStart(2,'0')}:${(rem%60).toString().padStart(2,'0')}`; 
            elCi.style.strokeDashoffset=circum*(1-(rem/((mins[nxt]-mins[act])*60))); 
        } 
    }
    function formatTime(v){return v<10?`0${v}`:v;}
</script>
</body>
</html>