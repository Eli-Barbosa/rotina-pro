<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotina Pro V27.1 - Anime Icons</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="apple-touch-icon" href="icon-512.png">
    <link rel="icon" type="image/png" href="icon-512.png">

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            /* PALETA ANIME FUN */
            --bg: #1a1a2e;         
            --card-bg: #16213e;    
            --text: #ffffff; 
            --text-muted: #a9a9a9;
            
            /* Cores POP */
            --pop-pink: #ff2a6d;
            --pop-yellow: #ffbd00;
            --pop-cyan: #05d5ff;
            --pop-green: #00ff9f;
            --pop-purple: #d35dff;
            
            /* UI */
            --border-radius: 25px;
            --btn-shadow: 0 5px 0 rgba(0,0,0,0.3);
            --nav-height: 80px;
            
            /* Categorias */
            --cat-trabalho: #05d5ff; 
            --cat-saude: #00ff9f; 
            --cat-estudos: #ff2a6d;
            --cat-casa: #ffbd00; 
            --cat-lazer: #d35dff; 
            --cat-eclesiastico: #ff9f1c; 
            --cat-outros: #a0aab5;
        }

        body.light-mode {
            --bg: #fff5f5; 
            --card-bg: #ffffff; 
            --text: #2d3436; 
            --text-muted: #636e72; 
            --btn-shadow: 0 5px 0 #dfe6e9;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Nunito', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; display: flex; justify-content: center; min-height: 100vh; 
            transition: 0.3s; overflow: hidden;
            background-image: radial-gradient(rgba(255,255,255,0.1) 15%, transparent 16%);
            background-size: 20px 20px;
        }
        
        h1, h2, h3, .level-badge, .timer-countdown, .dash-title, .evaluate-btn, .quest-title, .nav-btn, .header-title { 
            font-family: 'Fredoka', sans-serif; letter-spacing: 0.5px; 
        }
        
        .app-container { 
            width: 100%; max-width: 500px; background: transparent; 
            height: 100vh; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- VIEWS --- */
        .view-section {
            flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px;
            display: none; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .view-section.active { display: block; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }

        /* --- HEADER --- */
        .header-simple { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; 
            background: var(--card-bg); padding: 15px 20px; border-radius: var(--border-radius);
            box-shadow: var(--btn-shadow); border: 2px solid rgba(255,255,255,0.05);
        }
        .header-title { font-size: 1.8rem; color: var(--pop-yellow); margin: 0; text-transform: uppercase; text-shadow: 2px 2px 0px #000; }
        .header-date { font-size: 0.85rem; color: var(--text-muted); font-weight: 800; text-transform: uppercase; }

        /* --- BOT√ïES 3D POP & √çCONES --- */
        .btn-icon-small {
            width: 45px; height: 45px; border-radius: 14px; border: none; 
            background: var(--pop-cyan); color: #000; font-size: 1.4rem; cursor: pointer;
            box-shadow: 0 4px 0 #009ac0; transition: 0.1s; display: grid; place-items: center;
        }
        .btn-icon-small:active { transform: translateY(4px); box-shadow: none; }
        
        /* Ajuste para √≠cones dentro dos bot√µes */
        .btn-icon-small i { font-size: 1.5rem; }

        /* --- TIMER --- */
        .timer-wrapper { 
            position: relative; width: 220px; height: 220px; margin: 30px auto; 
            background: var(--card-bg); border-radius: 50%; 
            box-shadow: 0 10px 0 rgba(0,0,0,0.2); border: 5px solid rgba(255,255,255,0.05);
        }
        .timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; padding: 10px; }
        .timer-circle-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 18; stroke-linecap: round; }
        .timer-circle-progress { 
            fill: none; stroke: var(--pop-green); stroke-width: 18; stroke-linecap: round; 
            stroke-dasharray: 691; stroke-dashoffset: 691; transition: stroke-dashoffset 1s linear, stroke 0.5s; 
            filter: drop-shadow(0 0 5px var(--pop-green));
        }
        .timer-info { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .timer-current-task { font-size: 1.1rem; font-weight: 700; margin-bottom: 5px; color: var(--pop-cyan); text-transform: uppercase; }
        .timer-countdown { font-size: 3.2rem; margin: 0; color: var(--text); letter-spacing: -1px; text-shadow: 2px 2px 0px rgba(0,0,0,0.3); }
        .timer-next { font-size: 0.85rem; color: #000; background: var(--pop-yellow); padding: 5px 15px; border-radius: 20px; margin-top: 10px; font-weight: 800; box-shadow: 0 3px 0 #cc9a00; }

        /* --- QUEST CARD --- */
        .quest-card {
            background: var(--pop-purple); color: white; padding: 20px; 
            border-radius: var(--border-radius); margin-top: 20px;
            box-shadow: 0 6px 0 #8e24aa; position: relative; overflow: hidden;
            border: 3px solid rgba(255,255,255,0.2);
        }
        .quest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .quest-tag { background: rgba(0,0,0,0.3); font-size: 0.7rem; padding: 5px 10px; border-radius: 10px; font-weight: 800; }
        .quest-xp { background: var(--pop-yellow); color: #000; padding: 5px 10px; border-radius: 10px; font-weight: 900; box-shadow: 0 3px 0 #cc9a00; }
        
        .quest-btn {
            width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 15px;
            background: #fff; color: var(--pop-purple); font-weight: 900; font-family: 'Fredoka', sans-serif;
            cursor: pointer; box-shadow: 0 5px 0 #ddd; transition: 0.1s; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .quest-btn:active { transform: translateY(5px); box-shadow: none; }
        .quest-btn:disabled { background: rgba(255,255,255,0.3); color: rgba(255,255,255,0.7); cursor: default; transform: translateY(5px); box-shadow: none; }

        /* --- TAREFAS LISTA --- */
        .day-selector { display: flex; justify-content: space-between; margin-bottom: 20px; background: var(--card-bg); padding: 10px; border-radius: var(--border-radius); box-shadow: var(--btn-shadow); }
        .day-btn { 
            width: 42px; height: 42px; border-radius: 12px; border: none; 
            background: transparent; color: var(--text-muted); font-weight: 800; cursor: pointer; transition: 0.2s;
            font-family: 'Fredoka', sans-serif; font-size: 1rem;
        }
        .day-btn.active { background: var(--pop-cyan); color: #000; box-shadow: 0 4px 0 #009ac0; transform: translateY(-2px); }
        .day-btn.today-indicator { color: var(--pop-yellow); }
        .day-btn.active.today-indicator { background: var(--pop-yellow); color: #000; box-shadow: 0 4px 0 #cc9a00; }

        .input-group { background: var(--card-bg); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: var(--btn-shadow); }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .full-width { display: flex; gap: 10px; }
        
        input, select { 
            border: 2px solid transparent; padding: 12px; border-radius: 12px; 
            width: 100%; background: rgba(0,0,0,0.3); color: var(--text); 
            font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: 700;
        }
        input:focus, select:focus { outline: none; border-color: var(--pop-pink); background: rgba(0,0,0,0.5); }

        button.add-btn { 
            background: var(--pop-green); color: #000; border: none; padding: 0 20px; 
            border-radius: 12px; cursor: pointer; font-size: 1.5rem; font-weight: 900; 
            box-shadow: 0 5px 0 #00b36e; transition: 0.1s; display: grid; place-items: center;
        }
        button.add-btn:active { transform: translateY(5px); box-shadow: none; }
        button.add-btn.editing-mode { background: var(--pop-pink); box-shadow: 0 5px 0 #b0004c; color: white; }

        ul { list-style: none; padding: 0; margin: 0; }
        li { 
            display: flex; align-items: center; background: var(--card-bg); 
            border-radius: 16px; margin-bottom: 12px; padding: 15px; 
            color: var(--text); position: relative; overflow: hidden; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); border: 2px solid transparent;
            transition: 0.2s;
        }
        li:hover { transform: scale(1.02); }
        li.completed { opacity: 0.6; filter: grayscale(0.6); box-shadow: none; transform: translateY(2px); }
        li.completed .task-desc { text-decoration: line-through; color: var(--text-muted); }
        
        .task-checkbox { 
            appearance: none; width: 28px; height: 28px; border: 3px solid var(--text-muted); border-radius: 8px; 
            margin-right: 15px; cursor: pointer; display: grid; place-items: center; transition: 0.2s; background: transparent;
        }
        .task-checkbox::after { content: '‚úî'; font-weight: 900; color: #fff; font-size: 16px; display: none; }
        .task-checkbox:checked { background: var(--pop-green); border-color: var(--pop-green); transform: scale(1.1); box-shadow: 0 0 10px var(--pop-green); }
        .task-checkbox:checked::after { display: block; }

        .task-info { flex-grow: 1; }
        .task-header { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 2px; }
        .task-desc { font-size: 1.1rem; font-weight: 800; font-family: 'Nunito', sans-serif; }
        
        .cat-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 8px; color: #000; font-weight: 800; text-transform: uppercase; }
        .punctuality-badge { font-size: 0.7rem; margin-left: auto; font-weight: 900; background: rgba(0,0,0,0.3); padding: 3px 8px; border-radius: 8px; }

        .action-container { display: flex; gap: 8px; margin-left: 10px; }
        .list-btn { 
            background: rgba(255,255,255,0.1); border: none; width: 36px; height: 36px; 
            border-radius: 10px; cursor: pointer; font-size: 1.2rem; color: var(--text); 
            transition: 0.2s; display: grid; place-items: center; 
        }
        .list-btn:hover { transform: scale(1.1); background: rgba(255,255,255,0.2); }
        .edit-btn-icon { color: var(--pop-yellow); }
        .delete-btn-icon { color: var(--pop-pink); }

        /* --- PERFIL / HUD --- */
        .gamification-bar { 
            background: var(--card-bg); padding: 20px; border-radius: 20px; margin-bottom: 20px; 
            display: flex; flex-direction: column; gap: 15px; box-shadow: var(--btn-shadow);
        }
        .hud-row-1 { display: flex; justify-content: space-between; align-items: center; }
        .level-badge { background: var(--pop-pink); color: white; padding: 5px 12px; border-radius: 10px; font-size: 1rem; box-shadow: 0 3px 0 #b0004c; }
        .score-display { font-family: 'Fredoka', sans-serif; font-size: 1rem; color: var(--pop-cyan); font-weight: bold; text-shadow: 0 2px 0 rgba(0,0,0,0.3); }
        .medals-display { 
            display: flex; gap: 15px; justify-content: center; background: rgba(0,0,0,0.2); 
            padding: 10px; border-radius: 15px; font-size: 0.9rem;
        }
        .medal-count { display: flex; align-items: center; gap: 5px; font-weight: 800; font-family: 'Fredoka', sans-serif; }

        .evaluate-btn { 
            width: 100%; padding: 18px; background: var(--pop-green); color: #000; border: none; 
            border-radius: 16px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 6px 0 #00b36e; 
            margin-bottom: 20px; font-weight: 900; text-transform: uppercase; transition: 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .evaluate-btn:active { transform: translateY(6px); box-shadow: none; }
        .evaluate-btn:disabled { background: var(--text-muted); color: #555; box-shadow: none; cursor: not-allowed; transform: translateY(6px); }

        .dash-card { background: var(--card-bg); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 2px solid transparent; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .dash-title { font-size: 1rem; color: var(--pop-yellow); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-weight: 700; text-transform: uppercase; }

        .backup-btn { 
            width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; border: 2px solid var(--text-muted); 
            font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; 
            font-family: 'Fredoka', sans-serif; transition: 0.2s; background: transparent; color: var(--text-muted);
        }
        .btn-download { border-color: var(--pop-cyan); color: var(--pop-cyan); }
        .btn-download:hover { background: var(--pop-cyan); color: var(--card-bg); }
        .btn-restore:hover { border-color: var(--text); color: var(--text); }

        /* --- TOASTS ANIME --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .gamer-toast { 
            background: #fff; color: #333; padding: 15px 25px; border-radius: 25px; 
            border: 4px solid var(--pop-cyan); box-shadow: 0 8px 0 rgba(0,0,0,0.2); 
            font-family: 'Fredoka', sans-serif; font-weight: 700; font-size: 1.1rem;
            display: flex; align-items: center; gap: 10px; 
            transform: translateX(120%); animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; 
            pointer-events: auto; 
        }
        .gamer-toast.success { border-color: var(--pop-green); } 
        .gamer-toast.warning { border-color: var(--pop-yellow); }
        .gamer-toast.error { border-color: var(--pop-pink); color: var(--pop-pink); }
        .gamer-toast.quest { border-color: var(--pop-purple); color: var(--pop-purple); }
        
        @keyframes bounceIn { 0% { transform: translateX(120%); } 60% { transform: translateX(-20px); } 100% { transform: translateX(0); } }
        @keyframes slideOut { to { transform: translateX(120%) scale(0.8); opacity: 0; } }

        /* --- XP FLUTUANTE --- */
        .floating-xp {
            position: fixed; color: var(--pop-yellow); font-family: 'Fredoka', sans-serif; font-weight: 900; font-size: 2.5rem;
            text-shadow: 3px 3px 0 #000; pointer-events: none; z-index: 9999;
            animation: floatUpFade 1.5s ease-out forwards;
        }
        @keyframes floatUpFade { 0% { opacity: 1; transform: translateY(0) scale(1) rotate(-10deg); } 100% { opacity: 0; transform: translateY(-80px) scale(1.5) rotate(10deg); } }

        /* --- NAV BAR --- */
        .bottom-nav {
            position: absolute; bottom: 20px; left: 20px; right: 20px; height: 80px;
            background: var(--card-bg); border-radius: 30px;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            border: 2px solid rgba(255,255,255,0.05);
        }
        .nav-btn {
            background: none; border: none; color: var(--text-muted);
            font-size: 0.7rem; font-family: 'Fredoka', sans-serif; font-weight: 700;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer; transition: 0.2s; width: 70px;
        }
        .nav-btn i { font-size: 1.8rem; display: block; transition: 0.2s; }
        .nav-btn.active { color: var(--pop-yellow); transform: translateY(-8px); }
        .nav-btn.active i { filter: drop-shadow(0 4px 0 rgba(0,0,0,0.2)); transform: scale(1.1); color: var(--pop-cyan); }

        /* --- MODAL LEITOR --- */
        #bibleReaderModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        #bibleReaderModal.show { display: flex; opacity: 1; }
        .reader-content { background: var(--card-bg); width: 90%; max-width: 600px; height: 85vh; border-radius: 30px; display: flex; flex-direction: column; overflow: hidden; border: 4px solid var(--pop-purple); box-shadow: 0 0 40px rgba(131, 56, 236, 0.6); }
        .reader-header { padding: 20px; background: var(--pop-purple); color: white; display: flex; justify-content: space-between; align-items: center; }
        .reader-body { padding: 25px; overflow-y: auto; flex-grow: 1; font-family: 'Nunito', sans-serif; font-size: 1.2rem; line-height: 1.7; color: var(--text); }
        .reader-footer { padding: 20px; border-top: 2px solid rgba(255,255,255,0.1); background: var(--input-bg); text-align: center; }
        .verse-num { font-weight: 900; color: var(--pop-cyan); margin-right: 8px; font-size: 0.9rem; vertical-align: super; }
        .confirm-read-btn { width: 100%; padding: 18px; background: var(--text-muted); color: var(--bg); border: none; border-radius: 20px; font-weight: 900; cursor: not-allowed; font-family: 'Fredoka', sans-serif; font-size: 1.1rem; transition: 0.3s; }
        .confirm-read-btn.unlocked { background: var(--pop-green); color: #000; cursor: pointer; box-shadow: 0 6px 0 #00b36e; }
        .confirm-read-btn.unlocked:active { transform: translateY(6px); box-shadow: none; }
        .reading-progress-bar { height: 6px; background: rgba(0,0,0,0.3); width: 100%; }
        .reading-progress-fill { height: 100%; background: var(--pop-green); width: 0%; transition: width 0.1s; }

        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 10px 0; font-size: 1rem; }
        .bad-stat { color: var(--pop-pink); font-weight: bold; }
        .daily-progress-container { margin-bottom: 20px; background: var(--input-bg); padding: 15px; border-radius: 16px; }
        .progress-track { height: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; overflow: hidden; position: relative; margin-top: 5px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--pop-orange), var(--pop-yellow), var(--pop-green)); width: 0%; transition: width 0.5s; }
        .quote-box { font-size: 1rem; font-style: italic; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; margin: 20px 0; border-left: 5px solid var(--pop-pink); text-align: center; }
        
        .repeat-btn { width: 35px; height: 35px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.2); background: transparent; color: var(--text-muted); cursor: pointer; font-weight: bold; }
        .repeat-btn.active { background: var(--pop-cyan); color: #000; border-color: var(--pop-cyan); }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="bibleReaderModal">
    <div class="reader-content">
        <div class="reader-header">
            <h3 style="margin:0" id="bibleChapterTitle">Carregando...</h3>
            <button onclick="closeReader()" style="background:none; border:none; color:white; font-size:2rem; cursor:pointer;"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="reading-progress-bar"><div class="reading-progress-fill" id="readingProgress"></div></div>
        <div class="reader-body" id="bibleTextContent">
            <div style="text-align:center; padding:50px; color:var(--text-muted);"><i class="ph-duotone ph-book-open-text" style="font-size:4rem; margin-bottom:10px;"></i><p>Buscando texto sagrado...</p></div>
        </div>
        <div class="reader-footer">
            <button id="btnConfirmRead" class="confirm-read-btn" onclick="finishReading()">LEIA AT√â O FIM...</button>
        </div>
    </div>
</div>

<div class="app-container">
    
    <div id="view-home" class="view-section active">
        <div class="header-simple">
            <div>
                <h1 class="header-title">FOCO</h1>
                <div id="headerDate" class="header-date">Carregando...</div>
            </div>
            <div>
                <button class="btn-icon-small" id="alarmToggle" onclick="toggleAlarm()"><i class="ph-fill ph-bell"></i></button>
            </div>
        </div>

        <div class="timer-wrapper">
            <svg class="timer-svg" viewBox="0 0 240 240">
                <circle class="timer-circle-bg" cx="120" cy="120" r="110"></circle>
                <circle class="timer-circle-progress" id="timerCircle" cx="120" cy="120" r="110"></circle>
            </svg>
            <div class="timer-info">
                <div class="timer-current-task" id="timerTaskName">Livre</div>
                <div class="timer-countdown" id="timerCountdown">00:00</div>
                <div class="timer-next" id="timerNextLabel">--</div>
            </div>
        </div>

        <div class="quote-box" id="dailyQuote">"Carregando inspira√ß√£o..."</div>

        <div class="quest-card">
            <div class="quest-header">
                <span class="quest-tag">MISS√ÉO DI√ÅRIA</span>
                <span class="quest-xp">+50 XP</span>
            </div>
            <h3 style="margin:0 0 5px 0;">Leitura B√≠blica üìñ</h3>
            <p style="margin:0; font-size:0.9rem; opacity:0.9;">Leia para fortalecer o esp√≠rito.</p>
            <button class="quest-btn" id="btnBibleQuest" onclick="openBibleReader()"><i class="ph-bold ph-book-open"></i> LER AGORA</button>
            <div style="margin-top:10px; font-weight:bold; font-size:0.9rem;" id="bibleStreak">üî• Ofensiva: 0 dias</div>
        </div>
    </div>

    <div id="view-tasks" class="view-section">
        <div class="header-simple">
            <h1 class="header-title">ROTINA</h1>
        </div>

        <div class="day-selector">
            <button class="day-btn" onclick="switchViewDay(0)" id="btnDay0">D</button>
            <button class="day-btn" onclick="switchViewDay(1)" id="btnDay1">S</button>
            <button class="day-btn" onclick="switchViewDay(2)" id="btnDay2">T</button>
            <button class="day-btn" onclick="switchViewDay(3)" id="btnDay3">Q</button>
            <button class="day-btn" onclick="switchViewDay(4)" id="btnDay4">Q</button>
            <button class="day-btn" onclick="switchViewDay(5)" id="btnDay5">S</button>
            <button class="day-btn" onclick="switchViewDay(6)" id="btnDay6">S</button>
        </div>

        <div class="input-group">
            <div class="input-row">
                <input type="time" id="taskTime" required>
                <select id="taskCategory">
                    <option value="trabalho">Trabalho üíº</option>
                    <option value="eclesiastico">Igreja ‚õ™</option>
                    <option value="saude">Sa√∫de üçé</option>
                    <option value="estudos">Estudos üìö</option>
                    <option value="casa">Casa üè†</option>
                    <option value="lazer">Lazer üéÆ</option>
                    <option value="outros">Outros üìå</option>
                </select>
            </div>
            <div class="full-width">
                <input type="text" id="taskDesc" placeholder="Nome da tarefa..." required>
                <button class="add-btn" id="mainActionBtn" onclick="handleAction()"><i class="ph-bold ph-plus"></i></button>
            </div>
            <div style="text-align: right;">
                <button onclick="cancelEdit()" id="cancelEditBtn" style="display:none; background:transparent; color:var(--text-muted); border:none; cursor:pointer; font-weight:bold;">Cancelar</button>
            </div>
            
            <div class="repeat-wrapper" id="repeatWrapper" style="margin-top:15px; border-top:2px dashed rgba(255,255,255,0.1); padding-top:10px;">
                <span style="font-size:0.8rem; color:var(--text-muted); font-weight:bold;">REPETIR:</span>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                    <button class="repeat-btn" onclick="toggleRepeat(0)" id="rep0">D</button>
                    <button class="repeat-btn" onclick="toggleRepeat(1)" id="rep1">S</button>
                    <button class="repeat-btn" onclick="toggleRepeat(2)" id="rep2">T</button>
                    <button class="repeat-btn" onclick="toggleRepeat(3)" id="rep3">Q</button>
                    <button class="repeat-btn" onclick="toggleRepeat(4)" id="rep4">Q</button>
                    <button class="repeat-btn" onclick="toggleRepeat(5)" id="rep5">S</button>
                    <button class="repeat-btn" onclick="toggleRepeat(6)" id="rep6">S</button>
                </div>
            </div>
        </div>

        <ul id="taskList"></ul>
    </div>

    <div id="view-profile" class="view-section">
        <div class="header-simple">
            <h1 class="header-title">PERFIL</h1>
            <button class="btn-icon-small" onclick="toggleTheme()" id="themeBtn"><i class="ph-fill ph-sun"></i></button>
        </div>

        <div class="gamification-bar">
            <div class="hud-row-1">
                <div class="level-badge" id="userLevelBadge">N√≠vel 1</div>
                <div class="score-display">PONTOS: <span id="userScore">0</span></div>
            </div>
            <div class="medals-display">
                <div class="medal-count" style="color:var(--pop-yellow)">ü•á <span id="cntGold">0</span></div>
                <div class="medal-count" style="color:#dfe6e9">ü•à <span id="cntSilver">0</span></div>
                <div class="medal-count" style="color:#e17055">ü•â <span id="cntBronze">0</span></div>
            </div>
        </div>

        <div class="daily-progress-container">
            <div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:5px; font-weight:bold; color:var(--text);">
                <span>Progresso Hoje</span>
                <span id="progressText">0%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="dayProgressBar"></div>
                <div class="medal-marker" style="left:50%;" title="Bronze"></div>
                <div class="medal-marker" style="left:70%;" title="Prata"></div>
            </div>
        </div>

        <button class="evaluate-btn" id="btnEvaluate" onclick="evaluateDay()">
            <i class="ph-fill ph-trophy"></i> Avaliar Desempenho
        </button>

        <div class="dash-card">
            <div class="dash-title"><i class="ph-bold ph-warning"></i> Negligenciadas</div>
            <div id="dashSkippedList"><p style="font-size:0.9rem; color:var(--text-muted);">Sem dados.</p></div>
        </div>

        <div class="dash-card">
            <div class="dash-title"><i class="ph-bold ph-notebook"></i> Di√°rio de Bordo</div>
            <textarea id="journalInput" class="journal-area" placeholder="Notas do dia..." oninput="saveJournal()"></textarea>
        </div>

        <div style="margin-top:20px; border-top:2px dashed rgba(255,255,255,0.1); padding-top:20px;">
            <div class="dash-title" style="color:var(--text-muted);">DADOS</div>
            <button class="backup-btn btn-download" onclick="exportBackup()"><i class="ph-bold ph-download-simple"></i> Backup</button>
            <button class="backup-btn btn-restore" onclick="document.getElementById('backupInput').click()"><i class="ph-bold ph-upload-simple"></i> Restaurar</button>
            <input type="file" id="backupInput" style="display:none" accept=".json" onchange="importBackup(this)">
        </div>
        
        <button onclick="clearHistory()" style="color:var(--pop-pink); background:none; border:none; margin-top:20px; width:100%; font-weight:bold; cursor:pointer;">RESETAR TUDO</button>
    </div>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('view-home', this)">
            <i class="ph-fill ph-house"></i> FOCO
        </button>
        <button class="nav-btn" onclick="switchTab('view-tasks', this)">
            <i class="ph-fill ph-check-square"></i> ROTINA
        </button>
        <button class="nav-btn" onclick="switchTab('view-profile', this)">
            <i class="ph-fill ph-user-circle"></i> PERFIL
        </button>
    </nav>

</div>

<script>
    // --- L√ìGICA DE NAVEGA√á√ÉO ---
    function switchTab(viewId, btn) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        if(viewId === 'view-tasks') { cancelEdit(); renderTasks(); }
        if(viewId === 'view-profile') { updateSkippedStats(); checkEvaluationButton(); }
    }

    // --- CORES & DADOS ---
    const categoryColors = { 'trabalho': 'var(--cat-trabalho)', 'saude': 'var(--cat-saude)', 'estudos': 'var(--cat-estudos)', 'casa': 'var(--cat-casa)', 'lazer': 'var(--cat-lazer)', 'eclesiastico': 'var(--cat-eclesiastico)', 'outros': 'var(--cat-outros)' };
    const emptyWeek = { 0:[], 1:[], 2:[], 3:[], 4:[], 5:[], 6:[] };
    let allTasks = JSON.parse(localStorage.getItem('myRoutineTasksV7')) || emptyWeek;
    let historyLog = JSON.parse(localStorage.getItem('routineHistoryV7')) || [];
    let medals = JSON.parse(localStorage.getItem('userMedals')) || { gold: 0, silver: 0, bronze: 0 };
    let userLevel = parseInt(localStorage.getItem('userLevel')) || 1;
    let userScore = parseInt(localStorage.getItem('userScore')) || 0;
    let lastEvaluationDate = localStorage.getItem('lastEvalDate');
    let bibleStreak = parseInt(localStorage.getItem('bibleStreak')) || 0;
    let lastBibleDate = localStorage.getItem('lastBibleDate');
    let todayIndex = new Date().getDay(); let viewIndex = todayIndex; let selectedRepeats = new Set(); let editingTaskIndex = null;
    let alarmEnabled = false; let lastAlarmTime = null; const alarmAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    const dailyQuotes = ["Tudo posso naquele que me fortalece.", "Seja forte e corajoso.", "Entrega o teu caminho ao Senhor.", "A alegria do Senhor √© a nossa for√ßa."];

    // --- INIT ---
    if (localStorage.getItem('lightMode') === 'true') document.body.classList.add('light-mode');
    updateHeaderDate(); checkDailyReset(); renderDayButtons(); updateMedalsUI(); updateScoreUI(); renderTasks(); renderQuote(); loadJournal(); checkBibleQuestState(); updateSkippedStats();
    setInterval(updateTimer, 1000); updateTimer(); checkEvaluationButton();

    // --- FUN√á√ïES DE FEEDBACK ---
    function showToast(msg, type = 'info') {
        const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `gamer-toast ${type}`;
        let i = '<i class="ph-fill ph-info"></i>'; 
        if(type==='success')i='<i class="ph-fill ph-check-circle"></i>'; 
        if(type==='warning')i='<i class="ph-fill ph-warning"></i>'; 
        if(type==='error')i='<i class="ph-fill ph-x-circle"></i>'; 
        if(type==='quest')i='<i class="ph-fill ph-star"></i>';
        t.innerHTML = `<span>${i}</span> <span>${msg}</span>`; c.appendChild(t);
        setTimeout(() => { t.style.animation = 'slideOut 0.3s forwards'; setTimeout(() => t.remove(), 300); }, 4000);
    }
    function showFloatingXP(amount) {
        const el = document.createElement('div'); el.className = 'floating-xp'; el.innerText = `+${amount} XP`;
        el.style.left = '50%'; el.style.top = '50%'; el.style.transform = 'translate(-50%, -50%)';
        document.body.appendChild(el); setTimeout(() => el.remove(), 1500);
        userScore += amount; localStorage.setItem('userScore', userScore); updateScoreUI();
    }
    function updateScoreUI() { 
        const el = document.getElementById('userScore'); el.innerText = userScore; el.style.color='#fff'; 
        setTimeout(()=>el.style.color='var(--pop-cyan)',300); 
    }
    function updateDailyProgress() {
        const tasks = allTasks[todayIndex]; const bar = document.getElementById('dayProgressBar'); const txt = document.getElementById('progressText');
        if(!tasks || tasks.length===0){ bar.style.width='0%'; txt.innerText='0%'; return; }
        const comp = tasks.filter(t=>t.done).length; const pct = Math.round((comp/tasks.length)*100);
        bar.style.width=`${pct}%`; txt.innerText=`${pct}%`;
    }

    // --- CONTROLE DE TEMPO ---
    function isTaskAllowed(taskTimeStr) {
        if(viewIndex !== todayIndex) return "OK"; 
        const now = new Date(); const [h, m] = taskTimeStr.split(':').map(Number);
        const taskDate = new Date(); taskDate.setHours(h, m, 0, 0);
        const diff = now - taskDate;
        if (diff < -60000) return "WAIT"; 
        if (diff > (24 * 60 * 60 * 1000)) return "EXPIRED";
        return "OK";
    }

    // --- LEITOR B√çBLICO ---
    let readingStartTime = 0; let isReadingComplete = false; const MIN_READING_SECONDS = 15;
    const backupChapter = { title: "Salmos 23", text: ["O Senhor √© o meu pastor...", "Em verdes pastagens...", "Ainda que eu andasse...", "Preparas uma mesa...", "Certamente que a bondade..."] };

    async function openBibleReader() {
        const modal = document.getElementById('bibleReaderModal'); const contentDiv = document.getElementById('bibleTextContent');
        const titleDiv = document.getElementById('bibleChapterTitle'); const btn = document.getElementById('btnConfirmRead');
        const progress = document.getElementById('readingProgress');
        modal.classList.add('show'); contentDiv.scrollTop = 0; progress.style.width = '0%';
        btn.classList.remove('unlocked'); btn.innerText = `Lendo... (M√≠nimo ${MIN_READING_SECONDS}s)`; btn.disabled = true;
        isReadingComplete = false; readingStartTime = Date.now();
        contentDiv.innerHTML = '<div style="text-align:center; padding:50px;"><div style="font-size:3rem;">üìñ</div><p>Buscando...</p></div>';
        try {
            const rc = Math.floor(Math.random() * 150) + 1;
            const res = await fetch(`https://www.abibliadigital.com.br/api/verses/acf/sl/${rc}`);
            if(!res.ok) throw new Error(); const data = await res.json();
            titleDiv.innerText = `${data.book.name} ${data.chapter.number}`;
            let html = ''; data.verses.forEach(v => { html += `<p><span class="verse-num">${v.number}</span> ${v.text}</p>`; });
            contentDiv.innerHTML = html;
        } catch (e) {
            showToast("Modo Offline", "warning"); titleDiv.innerText = `${backupChapter.title} (Offline)`;
            let html = ''; backupChapter.text.forEach((v, i) => { html += `<p><span class="verse-num">${i+1}</span> ${v}</p>`; });
            contentDiv.innerHTML = html;
        }
        setupScrollMonitor(contentDiv, progress);
    }
    function setupScrollMonitor(div, prog) {
        div.onscroll = function() {
            const pct = (div.scrollTop / (div.scrollHeight - div.clientHeight)) * 100;
            prog.style.width = `${pct}%`;
            if (div.scrollHeight <= div.clientHeight || div.scrollTop + div.clientHeight >= div.scrollHeight - 30) checkReadingRequirements();
        }; setTimeout(() => { if (div.scrollHeight <= div.clientHeight) checkReadingRequirements(); }, 500);
    }
    function checkReadingRequirements() {
        if (isReadingComplete) return;
        const elapsed = (Date.now() - readingStartTime) / 1000;
        const btn = document.getElementById('btnConfirmRead');
        if (elapsed >= MIN_READING_SECONDS) {
            isReadingComplete = true; btn.classList.add('unlocked'); btn.disabled = false; btn.innerText = "CONFIRMAR LEITURA ‚úÖ";
        } else {
            btn.innerText = `Leia com calma... (${Math.ceil(MIN_READING_SECONDS - elapsed)}s)`;
            setTimeout(checkReadingRequirements, 1000);
        }
    }
    function finishReading() { if (!isReadingComplete) return; closeReader(); completeBibleQuest(); }
    function closeReader() { document.getElementById('bibleReaderModal').classList.remove('show'); }

    // --- QUESTS & AVALIA√á√ÉO ---
    function checkBibleQuestState() {
        const todayStr = new Date().toLocaleDateString(); const btn = document.getElementById('btnBibleQuest'); const lbl = document.getElementById('bibleStreak');
        lbl.innerText = `üî• Ofensiva: ${bibleStreak} dias`;
        if (lastBibleDate === todayStr) { btn.disabled = true; btn.innerHTML = "<i class='ph-bold ph-check'></i> LIDO HOJE"; btn.style.background = "rgba(255,255,255,0.2)"; btn.style.color = "#fff"; }
        else { btn.disabled = false; btn.innerHTML = "<i class='ph-bold ph-book-open'></i> LER AGORA"; btn.style.background = "#fff"; btn.style.color = "#4a148c"; }
    }
    function completeBibleQuest() {
        const todayStr = new Date().toLocaleDateString();
        if (lastBibleDate) { const d = new Date(); d.setDate(d.getDate()-1); if(lastBibleDate !== d.toLocaleDateString() && lastBibleDate !== todayStr) bibleStreak = 0; }
        bibleStreak++; lastBibleDate = todayStr; localStorage.setItem('bibleStreak', bibleStreak); localStorage.setItem('lastBibleDate', lastBibleDate);
        medals.bronze += 5; saveMedals(); showFloatingXP(50); showToast(`Ofensiva: ${bibleStreak} dias!`, "quest"); fireConfetti(true); checkBibleQuestState();
    }

    function evaluateDay() {
        const todayStr = new Date().toLocaleDateString();
        if (lastEvaluationDate === todayStr) { showToast("J√° avaliado hoje!", "info"); return; }
        const tasks = allTasks[todayIndex];
        if (!tasks || tasks.length === 0) { showToast("Sem tarefas hoje.", "warning"); return; }
        
        // --- BLOQUEIO DE HOR√ÅRIO ---
        let lastTaskMinutes = 0; let lastTaskTimeStr = "";
        tasks.forEach(t => { const [h, m] = t.time.split(':').map(Number); const mins = h*60+m; if(mins>lastTaskMinutes){lastTaskMinutes=mins; lastTaskTimeStr=t.time;} });
        const now = new Date(); const curMin = now.getHours()*60+now.getMinutes();
        if(curMin < lastTaskMinutes) { showToast(`Aguarde a √∫ltima tarefa (${lastTaskTimeStr})!`, "error"); return; }
        // ---------------------------

        const total = tasks.length; const completed = tasks.filter(t => t.done).length;
        let punctual = 0; tasks.forEach(t => { if (t.done && t.completedAt) { const [h, m] = t.time.split(':').map(Number); const d = new Date(t.completedAt); const diff = (d.getHours()*60 + d.getMinutes()) - (h*60 + m); if (Math.abs(diff) <= 15) punctual++; } });
        const pRate = total>0?punctual/total:0; const cRate = total>0?completed/total:0; let won = null;
        if (pRate >= 0.99) { medals.gold++; won = "ü•á OURO"; fireConfetti(true); showFloatingXP(100); }
        else if (pRate >= 0.7) { medals.silver++; won = "ü•à PRATA"; fireConfetti(false); showFloatingXP(50); }
        else if (cRate >= 0.5) { medals.bronze++; won = "ü•â BRONZE"; fireConfetti(false); showFloatingXP(25); }
        else { showToast("Tente amanh√£!", "error"); }
        if (won) { showToast(`Ganhou: ${won}`, "success"); lastEvaluationDate = todayStr; localStorage.setItem('lastEvalDate', lastEvaluationDate); saveMedals(); checkLevelUp(); }
        checkEvaluationButton();
    }

    // --- CORE & UTILS ---
    function updateSkippedStats() {
        const container = document.getElementById('dashSkippedList'); if (!container) return;
        if (historyLog.length === 0) { container.innerHTML = '<p style="font-size:0.9rem; color:var(--text-muted);">Sem dados.</p>'; return; }
        const skippedMap = {}; historyLog.forEach(t => { if (!t.done) skippedMap[t.title] = (skippedMap[t.title] || 0) + 1; });
        const sorted = Object.entries(skippedMap).sort((a,b) => b[1] - a[1]).slice(0, 3);
        container.innerHTML = '';
        if (sorted.length === 0) container.innerHTML = '<p style="font-size:0.9rem; color:var(--pop-green);">Tudo em dia!</p>';
        else sorted.forEach(([t, c]) => { container.innerHTML += `<div class="stat-row"><span class="stat-name">${t}</span> <span class="stat-val bad-stat">${c}x</span></div>`; });
    }

    function checkLevelUp() { if (medals.gold >= 10 || medals.silver >= 20 || medals.bronze >= 30) { userLevel++; medals.gold=0; medals.silver=0; medals.bronze=0; saveMedals(); showToast(`LEVEL UP! N√≠vel ${userLevel}!`, "level-up"); fireConfetti(true); } updateMedalsUI(); }
    function saveMedals() { localStorage.setItem('userMedals', JSON.stringify(medals)); localStorage.setItem('userLevel', userLevel); updateMedalsUI(); }
    function updateMedalsUI() { document.getElementById('userLevelBadge').innerText = `N√≠vel ${userLevel}`; document.getElementById('cntGold').innerText = medals.gold; document.getElementById('cntSilver').innerText = medals.silver; document.getElementById('cntBronze').innerText = medals.bronze; }
    function checkEvaluationButton() { const todayStr = new Date().toLocaleDateString(); const btn = document.getElementById('btnEvaluate'); if (lastEvaluationDate === todayStr) { btn.disabled = true; btn.innerHTML = "<span>‚úÖ</span> Dia Avaliado"; btn.style.background = "var(--input-bg)"; } else { btn.disabled = false; btn.innerHTML = "<span>üèÜ</span> Avaliar Desempenho"; btn.style.background = ""; } }
    function fireConfetti(isBig) { confetti({ particleCount: isBig?150:50, spread: 70, origin: { y: 0.6 } }); }
    
    function toggleTask(index) { 
        const task = allTasks[viewIndex][index]; 
        if (!task.done) {
            const status = isTaskAllowed(task.time);
            if (status === "WAIT") { showToast("Ainda n√£o √© hora!", "warning"); renderTasks(); return; }
            if (status === "EXPIRED") { showToast("Prazo expirado (24h)!", "error"); renderTasks(); return; }
        }
        const wasDone = task.done; task.done = !task.done; task.completedAt = task.done ? new Date().toISOString() : null; 
        if(task.done && !wasDone) showFloatingXP(10); 
        saveAll(); renderTasks(); updateDailyProgress();
    }
    
    function renderTasks() {
        const list = document.getElementById('taskList'); list.innerHTML = ''; let tasks = allTasks[viewIndex]; tasks.sort((a,b) => a.time.localeCompare(b.time));
        tasks.forEach((t, i) => {
            const li = document.createElement('li'); li.className = t.done ? 'completed' : ''; 
            const catVar = categoryColors[t.category] || categoryColors['outros'];
            li.style.color = "var(--text)"; 
            li.style.borderLeft = `5px solid ${catVar}`;
            
            let badges = ''; if (t.done && t.completedAt) { const [h, m] = t.time.split(':').map(Number); const d = new Date(t.completedAt); const diff = (d.getHours()*60 + d.getMinutes()) - (h*60 + m); if (diff > 15) badges += ` <span class="punctuality-badge" style="color:var(--pop-pink)">ATRASO</span>`; else if (diff < -15) badges += ` <span class="punctuality-badge" style="color:var(--pop-green)">CEDO</span>`; else badges += ` <span class="punctuality-badge" style="color:var(--pop-yellow)">PONTUAL</span>`; }
            
            const catLabel = `<span class="cat-badge" style="background:${catVar}; color:#000;">${t.category.toUpperCase()}</span>`;

            li.innerHTML = `<input type="checkbox" class="task-checkbox" ${t.done?'checked':''} onchange="toggleTask(${i})"> <div class="task-info"> <div class="task-header"><span class="task-time" style="color:var(--text); font-weight:800;">${t.time}</span> ${catLabel} ${badges}</div> <span class="task-desc">${t.title}</span> </div> <div class="action-container"><button class="list-btn edit-btn-icon" onclick="startEdit(${i})"><i class="ph-bold ph-pencil-simple"></i></button><button class="list-btn delete-btn-icon" onclick="deleteTask(${i})"><i class="ph-bold ph-trash"></i></button></div>`;
            list.appendChild(li);
        });
        updateDailyProgress();
    }

    function renderQuote() { document.getElementById('dailyQuote').innerText = dailyQuotes[Math.floor(Math.random() * dailyQuotes.length)]; }
    function saveJournal() { localStorage.setItem('dailyJournal', document.getElementById('journalInput').value); }
    function loadJournal() { const t = localStorage.getItem('dailyJournal'); if(t) document.getElementById('journalInput').value = t; }
    
    function toggleTheme() { 
        document.body.classList.toggle('light-mode'); 
        localStorage.setItem('lightMode', document.body.classList.contains('light-mode')); 
        document.getElementById('themeBtn').innerHTML = document.body.classList.contains('light-mode') ? '<i class="ph-fill ph-moon"></i>' : '<i class="ph-fill ph-sun"></i>'; 
    }
    
    function exportBackup() { const data = { tasks: localStorage.getItem('myRoutineTasksV7'), history: localStorage.getItem('routineHistoryV7'), medals: localStorage.getItem('userMedals'), level: localStorage.getItem('userLevel'), score: userScore, journal: localStorage.getItem('dailyJournal'), bible: { streak: bibleStreak, date: lastBibleDate }, date: new Date().toISOString() }; const b = new Blob([JSON.stringify(data)], {type:'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download=`backup-v27-${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); showToast("Salvo!", "success"); }
    function importBackup(elm) { const f = elm.files[0]; if(!f) return; if(!confirm('Restaurar?')) return; const r = new FileReader(); r.onload = e => { try { const d = JSON.parse(e.target.result); if(d.tasks) { localStorage.setItem('myRoutineTasksV7', d.tasks); if(d.history) localStorage.setItem('routineHistoryV7', d.history); if(d.medals) localStorage.setItem('userMedals', d.medals); if(d.level) localStorage.setItem('userLevel', d.level); if(d.score) localStorage.setItem('userScore', d.score); if(d.journal) localStorage.setItem('dailyJournal', d.journal); if(d.bible) { localStorage.setItem('bibleStreak', d.bible.streak); localStorage.setItem('lastBibleDate', d.bible.date); } showToast("Restaurado!", "success"); setTimeout(()=>location.reload(), 1000); } } catch(err) { showToast("Erro", "error"); } }; r.readAsText(f); }
    
    function updateHeaderDate() { document.getElementById('headerDate').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }); }
    function checkDailyReset() { const today = new Date().toLocaleDateString(); const last = localStorage.getItem('lastRoutineDateV7'); if(last && last !== today) { archiveTasks(last); for(let i=0; i<7; i++) allTasks[i] = allTasks[i].map(t => ({...t, done: false, completedAt: null})); saveAll(); } localStorage.setItem('lastRoutineDateV7', today); }
    function archiveTasks(date) { Object.values(allTasks).forEach(list => list.forEach(t => historyLog.push({ date: date, ...t }))); if(historyLog.length > 500) historyLog = historyLog.slice(-500); localStorage.setItem('routineHistoryV7', JSON.stringify(historyLog)); }
    function clearHistory() { if(confirm('Resetar Tudo?')) { localStorage.clear(); location.reload(); } }
    function switchViewDay(i) { viewIndex = i; cancelEdit(); renderDayButtons(); renderTasks(); }
    function renderDayButtons() { for(let i=0; i<7; i++) { const btn = document.getElementById(`btnDay${i}`); btn.classList.remove('active', 'today-indicator'); if(i===viewIndex) btn.classList.add('active'); if(i===todayIndex) btn.classList.add('today-indicator'); } }
    function startEdit(i) { editingTaskIndex = i; const t = allTasks[viewIndex][i]; document.getElementById('taskTime').value = t.time; document.getElementById('taskDesc').value = t.title; document.getElementById('taskCategory').value = t.category; document.getElementById('mainActionBtn').innerHTML = "<i class='ph-bold ph-floppy-disk'></i>"; document.getElementById('mainActionBtn').classList.add('editing-mode'); document.getElementById('cancelEditBtn').style.display = 'inline-block'; document.getElementById('repeatWrapper').style.opacity = '0.3'; document.getElementById('repeatWrapper').style.pointerEvents = 'none'; }
    function cancelEdit() { editingTaskIndex = null; document.getElementById('taskTime').value = ''; document.getElementById('taskDesc').value = ''; document.getElementById('mainActionBtn').innerHTML = "<i class='ph-bold ph-plus'></i>"; document.getElementById('mainActionBtn').classList.remove('editing-mode'); document.getElementById('cancelEditBtn').style.display = 'none'; document.getElementById('repeatWrapper').style.opacity = '1'; document.getElementById('repeatWrapper').style.pointerEvents = 'auto'; }
    function handleAction() { const time = document.getElementById('taskTime').value; const title = document.getElementById('taskDesc').value; const cat = document.getElementById('taskCategory').value; if(!time || !title) { showToast("Preencha tudo!", "warning"); return; } if(editingTaskIndex !== null) { allTasks[viewIndex][editingTaskIndex] = { time, title, category: cat, done: false, completedAt: null }; saveAll(); renderTasks(); cancelEdit(); showToast("Editado!", "info"); } else { const days = selectedRepeats.size > 0 ? Array.from(selectedRepeats) : [viewIndex]; days.forEach(d => allTasks[d].push({ time, title, category: cat, done: false, completedAt: null })); saveAll(); renderTasks(); document.getElementById('taskDesc').value = ''; selectedRepeats.clear(); document.querySelectorAll('.repeat-btn').forEach(b => b.classList.remove('active')); showToast("Criado!", "success"); } }
    function deleteTask(i) { if(confirm('Apagar?')) { allTasks[viewIndex].splice(i, 1); saveAll(); renderTasks(); showToast("Apagado.", "error"); } }
    function saveAll() { localStorage.setItem('myRoutineTasksV7', JSON.stringify(allTasks)); updateTimer(); }
    function toggleRepeat(i) { if(editingTaskIndex !== null) return; const btn = document.getElementById(`rep${i}`); if(selectedRepeats.has(i)) { selectedRepeats.delete(i); btn.classList.remove('active'); } else { selectedRepeats.add(i); btn.classList.add('active'); } }
    function toggleAlarm() { alarmEnabled = !alarmEnabled; const btn = document.getElementById('alarmToggle'); if(alarmEnabled) { btn.classList.add('active'); showToast("Alarme ON", "success"); if(Notification.permission!=='granted') Notification.requestPermission(); } else { btn.classList.remove('active'); showToast("Alarme OFF", "info"); } }
    function updateTimer() { const tasks = allTasks[todayIndex]; const elN = document.getElementById('timerTaskName'); const elC = document.getElementById('timerCountdown'); const elNext = document.getElementById('timerNextLabel'); const elCircle = document.getElementById('timerCircle'); const now = new Date(); const curMin = now.getHours()*60 + now.getMinutes(); 
        if(alarmEnabled && now.getSeconds() === 0) { const t = `${formatTime(now.getHours())}:${formatTime(now.getMinutes())}`; const match = tasks.find(tk => tk.time === t && !tk.done); if(match) { alarmAudio.play().catch(()=>{}); if(Notification.permission==='granted') new Notification("Rotina", {body: match.title}); showToast(match.title, "warning"); } }
        if(!tasks || tasks.length === 0) { elN.innerText="Livre"; elC.innerText="00:00"; elCircle.style.strokeDashoffset=0; return; }
        const taskMins = tasks.map(t => { const [h, m] = t.time.split(':').map(Number); return h*60 + m; });
        let act = -1, nxt = -1; for(let i=0; i<taskMins.length; i++) { if(curMin >= taskMins[i]) act = i; else { nxt = i; break; } }
        if(act !== -1 && nxt !== -1) { const cur = tasks[act]; elN.innerText = cur.title; elNext.innerText = `Pr√≥x: ${tasks[nxt].title}`; const total = taskMins[nxt] - taskMins[act]; const passed = curMin - taskMins[act]; const pct = 1 - (passed / total); elCircle.style.strokeDashoffset = (2*Math.PI*110) * (1-pct); elC.innerText = `${formatTime(Math.floor((taskMins[nxt]-curMin)/60))}:${formatTime((taskMins[nxt]-curMin)%60)}`; elCircle.style.stroke = getComputedStyle(document.documentElement).getPropertyValue(`--cat-${cur.category}`).trim(); }
        else if(nxt !== -1) { elN.innerText = "Prepare-se"; elNext.innerText = `Pr√≥x: ${tasks[nxt].title}`; elC.innerText = `${formatTime(Math.floor((taskMins[nxt]-curMin)/60))}:${formatTime((taskMins[nxt]-curMin)%60)}`; elCircle.style.strokeDashoffset=0; }
        else { elN.innerText = "Dia Conclu√≠do"; elC.innerText = "00:00"; elNext.innerText = "Bom descanso"; elCircle.style.strokeDashoffset=0; }
    }
    function formatTime(v) { return v<10?`0${v}`:v; }
</script>
</body>
</html>
