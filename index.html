<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Agenda Eventos | Premium</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    
    <style>
        /* === VARIÁVEIS DE TEMA === */
        :root {
            --primary: #4F46E5;       
            --primary-hover: #4338ca; 
            --primary-light: #EEF2FF; 
            
            --secondary: #10B981;     
            --accent: #F59E0B;        
            --danger: #EF4444;        
            --danger-light: #FEF2F2;
            --purple: #9b59b6;        
            --purple-hover: #8e44ad;
            --whatsapp: #25D366;      
            
            --bg-body: #F8FAFC;       
            --bg-card: #FFFFFF;       
            --bg-footer: #F9FAFB;
            
            --text-main: #1E293B;     
            --text-muted: #64748B;    
            --border: #E2E8F0;        
            
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius: 16px;           
        }

        .dark-mode {
            --bg-body: #0F172A;       
            --bg-card: #1E293B;       
            --bg-footer: #182234;
            --text-main: #F1F5F9;
            --text-muted: #94A3B8;
            --border: #334155;
            --primary-light: #312e81;
            --danger-light: #451a1a;
            --shadow-card: 0 4px 6px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            transition: background 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            max-width: 1100px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Header */
        .header-section {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; background: var(--bg-card); padding: 20px 30px;
            border-radius: var(--radius); box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand img { height: 48px; width: auto; border-radius: 8px; }
        .brand h1 { font-size: 1.25rem; font-weight: 700; margin: 0; letter-spacing: -0.025em; display: flex; align-items: center; gap: 8px; }
        .brand small { display: block; color: var(--text-muted); font-weight: 400; font-size: 0.875rem; margin-top: 2px; }

        .theme-btn {
            background: var(--bg-body); border: 1px solid var(--border);
            color: var(--text-main); width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; display: grid; place-items: center; transition: all 0.2s;
        }
        .theme-btn:hover { transform: rotate(15deg); border-color: var(--primary); color: var(--primary); }

        /* Hero Widget */
        .hero-widget {
            background: linear-gradient(135deg, #4F46E5 0%, #818CF8 100%);
            color: white; border-radius: var(--radius); padding: 30px;
            position: relative; overflow: hidden; margin-bottom: 30px;
            box-shadow: 0 10px 30px -10px rgba(79, 70, 229, 0.5);
            display: none; animation: slideDown 0.5s ease-out;
        }
        .hero-widget::after {
            content: ''; position: absolute; top: -50%; right: -10%;
            width: 300px; height: 300px; border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
        }
        .hero-badge {
            background: rgba(255,255,255,0.25); backdrop-filter: blur(4px);
            padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.05em; display: inline-block; margin-bottom: 10px;
        }
        .hero-title { font-size: 2rem; font-weight: 800; margin: 5px 0 15px 0; line-height: 1.1; }
        .hero-meta { display: flex; gap: 20px; font-size: 0.95rem; opacity: 0.95; }
        .hero-meta div { display: flex; align-items: center; gap: 8px; }

        /* Controls */
        .controls-bar {
            display: grid; grid-template-columns: auto 1fr auto; gap: 15px;
            margin-bottom: 25px; align-items: center;
        }
        .search-wrapper { position: relative; width: 100%; }
        .search-wrapper i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .search-input {
            width: 100%; padding: 12px 12px 12px 40px; border-radius: 12px;
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-main); font-size: 0.95rem; transition: all 0.2s; outline: none;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        /* Buttons */
        .btn {
            padding: 10px 18px; border-radius: 8px; border: none; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s ease;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background: var(--bg-body); border-color: var(--text-muted); }
        
        .btn-whatsapp { background: var(--whatsapp); color: white; }
        .btn-whatsapp:hover { filter: brightness(0.9); }

        .toolbar-bottom { display: flex; gap: 10px; margin-top: 15px; overflow-x: auto; padding-bottom: 5px; }

        /* === ÁREA DE DADOS === */
        .data-container {
            background: var(--bg-card); border-radius: var(--radius);
            box-shadow: var(--shadow-sm); border: 1px solid var(--border); overflow: hidden;
            animation: fadeIn 0.4s ease;
        }
        table { width: 100%; border-collapse: collapse; }
        th {
            background: var(--bg-body); color: var(--text-muted); font-size: 0.75rem;
            text-transform: uppercase; padding: 16px 20px; text-align: left; font-weight: 700;
            border-bottom: 1px solid var(--border);
        }
        td { padding: 16px 20px; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 0.925rem; }
        tr:hover td { background-color: var(--bg-body); }
        .tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; background: var(--bg-body); border: 1px solid var(--border); }
        
        /* Grid View (Cards) */
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; padding: 5px; }
        .event-card {
            background: var(--bg-card); border-radius: 20px; border: none; box-shadow: var(--shadow-card);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
            overflow: hidden; position: relative;
        }
        .event-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-hover); }
        .card-strip { height: 6px; width: 100%; background: var(--primary); }
        .event-card.sunday .card-strip { background: var(--danger); }
        .card-body { padding: 24px; flex-grow: 1; }
        
        .card-date-badge {
            display: inline-block; background: var(--primary-light); color: var(--primary);
            padding: 6px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px;
        }
        .event-card.sunday .card-date-badge { background: var(--danger-light); color: var(--danger); }
        .card-title { font-size: 1.25rem; font-weight: 700; margin: 0 0 20px 0; line-height: 1.4; color: var(--text-main); }
        .card-meta-list { display: flex; flex-direction: column; gap: 12px; }
        .meta-item { display: flex; align-items: center; gap: 12px; font-size: 0.95rem; color: var(--text-muted); }
        .meta-icon-box { width: 32px; height: 32px; border-radius: 8px; background: var(--bg-body); color: var(--text-muted); display: grid; place-items: center; font-size: 0.9rem; }

        /* Estilo das Observações no Card */
        .card-obs {
            margin-top: 16px;
            padding: 12px;
            background-color: var(--bg-body);
            border-radius: 10px;
            font-size: 0.85rem;
            color: var(--text-muted);
            border: 1px solid var(--border);
            line-height: 1.5;
            font-style: italic;
        }

        .card-actions-footer {
            background: var(--bg-footer); border-top: 1px solid var(--border); padding: 12px 24px;
            display: flex; justify-content: flex-end; gap: 8px;
        }
        .icon-btn {
            width: 36px; height: 36px; border-radius: 50%; border: 1px solid transparent;
            background: transparent; color: var(--text-muted); cursor: pointer;
            display: grid; place-items: center; transition: 0.2s;
        }
        .icon-btn:hover { background: white; border-color: var(--border); color: var(--primary); box-shadow: var(--shadow-sm); }
        .icon-btn.duplicate:hover { color: var(--purple); border-color: var(--purple); }
        .icon-btn.delete:hover { color: var(--danger); border-color: var(--danger); }

        /* === MODALS === */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            z-index: 1000; display: none; place-items: center; opacity: 0; transition: opacity 0.2s;
        }
        .modal-overlay.open { display: grid; opacity: 1; }
        .modal-box {
            background: var(--bg-card); border-radius: 20px; width: 90%; max-width: 500px;
            padding: 30px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transform: scale(0.95); transition: transform 0.2s; border: 1px solid var(--border);
        }
        .modal-overlay.open .modal-box { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-header h3 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; }
        .form-input {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
            background: var(--bg-body); color: var(--text-main); font-family: inherit; outline: none; transition: 0.2s;
        }
        .form-input:focus { border-color: var(--primary); background: var(--bg-card); }

        /* === VISUAL CARD === */
        #visual-card-wrapper {
            background: #fff; color: #1f2937; border-radius: 24px; overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); text-align: center;
            font-family: 'Inter', sans-serif; border: 1px solid #e5e7eb;
        }
        .vc-header { background: #4F46E5; color: white; padding: 25px; display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 1.1rem; }
        .vc-header.sunday-bg { background: #EF4444; }
        .vc-body { padding: 40px 30px; }
        .vc-logo { height: 70px; margin-bottom: 20px; object-fit: contain; }
        .vc-title { font-size: 2rem; font-weight: 900; margin: 10px 0 30px; line-height: 1.2; color: #111827; }
        .vc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 2px dashed #e5e7eb; text-align: left; }
        .vc-item label { display: block; font-size: 0.7rem; text-transform: uppercase; color: #666; font-weight: 700; }
        .vc-item span { font-size: 1rem; font-weight: 600; color: #333; }
        .vc-obs { margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 10px; font-size: 0.9rem; font-style: italic; color: #555; }

        /* === UTILS & PRINT === */
        #toast-box { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: var(--bg-card); color: var(--text-main); padding: 12px 18px; border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 5px solid var(--primary);
            display: flex; align-items: center; gap: 12px; font-weight: 600; animation: slideIn 0.3s ease;
        }
        
        .loader-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.7); backdrop-filter: blur(4px);
            z-index: 3000; display: none; place-items: center; flex-direction: column; gap: 15px; color: var(--primary);
        }
        .dark-mode .loader-overlay { background: rgba(0,0,0,0.7); }
        .spinner {
            width: 45px; height: 45px; border: 4px solid rgba(79, 70, 229, 0.2);
            border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        
        .print-visible { display: none; }
        
        @media print {
            body { background: white; color: black; }
            .app-container { max-width: none; margin: 0; padding: 0; }
            
            .controls-bar, .toolbar-bottom, .card-actions-footer, .loader-overlay, .theme-btn, .hero-widget, .no-print { display: none !important; }
            
            /* === HEADER NA IMPRESSÃO (Mantendo Estilo) === */
            .header-section {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: center !important;
                margin-bottom: 20px !important;
                
                /* Mantendo o visual de cartão */
                background: var(--bg-card) !important;
                border: 1px solid var(--border) !important;
                box-shadow: var(--shadow-sm) !important;
                padding: 20px 30px !important;
                border-radius: var(--radius) !important;
                
                /* Força impressão de fundo e cores */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .header-section i.fa-pen { display: none !important; }
            
            .data-container, table, th, td { box-shadow: none !important; border-color: #000 !important; }
            
            /* Ajuste para imprimir Grade de Cards */
            .grid-view { display: grid !important; grid-template-columns: 1fr 1fr; gap: 15px; }
            .event-card { break-inside: avoid; border: 1px solid #ddd; box-shadow: none; }
            .card-strip, .card-date-badge { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            
            /* Garante que o fundo da observação saia na impressão */
            .card-obs {
                background-color: #f9f9f9 !important;
                border: 1px solid #eee !important;
                color: #444 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            #obs-gerais { display: none !important; }
            .print-visible { display: block !important; white-space: pre-wrap; font-size: 10pt; margin-top: 10px; border: 1px solid #ddd; padding: 10px; }
            .print-only-signature { display: block !important; }
        }
        @media (max-width: 768px) {
            .app-container { margin: 10px; padding: 0; }
            .header-section { flex-direction: column; text-align: center; gap: 15px; }
            .controls-bar { grid-template-columns: 1fr; }
            .hero-title { font-size: 1.5rem; }
            .grid-view { grid-template-columns: 1fr; }
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="loading" class="loader-overlay">
        <div class="spinner"></div>
        <div style="font-weight: 600;">Processando...</div>
    </div>
    <div id="toast-box"></div>

    <div class="app-container">
        
        <header class="header-section">
            <div class="brand">
                <img id="app-logo" src="imagens/logo.png" onerror="this.style.display='none'" alt="Logo">
                <div>
                    <h1 id="header-title">Agenda da Igreja <i class="fas fa-pen" style="font-size:0.8rem; opacity:0.3; cursor:pointer;" onclick="editarTitulo()"></i></h1>
                    <small>Gestão de Eventos e Escalas</small>
                </div>
            </div>
            <button class="theme-btn" id="theme-toggle"><i class="fas fa-moon"></i></button>
        </header>

        <div id="hero-widget" class="hero-widget">
            <div class="hero-badge"><i class="fas fa-bolt"></i> Próximo Evento</div>
            <h2 class="hero-title" id="hero-title">Carregando...</h2>
            <div class="hero-meta">
                <div id="hero-date"><i class="far fa-calendar"></i> --/--</div>
                <div id="hero-porteiro"><i class="fas fa-user-shield"></i> --</div>
                <div id="hero-direcao"><i class="fas fa-microphone-alt"></i> --</div>
            </div>
        </div>

        <div class="controls-bar">
            <button class="btn btn-primary" onclick="abrirModal('modal-add')">
                <i class="fas fa-plus"></i> Novo Evento
            </button>
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" class="search-input" id="search-input" placeholder="Buscar..." onkeyup="filtrarEventos()">
            </div>
            <button class="btn btn-secondary" id="view-toggle" onclick="alternarVisao()">
                <i class="fas fa-grip-horizontal"></i>
            </button>
        </div>

        <div class="toolbar-bottom no-print">
            <button class="btn btn-secondary" onclick="imprimir()"><i class="fas fa-print"></i> Imprimir</button>
            <button class="btn btn-secondary" onclick="abrirModal('modal-config')"><i class="fas fa-cog"></i> Dados</button>
            <button class="btn btn-secondary" style="color: var(--accent);" onclick="projetarMes()"><i class="fas fa-angle-double-right"></i> Projetar Mês</button>
        </div>

        <div id="content-area" style="margin-top: 20px;"></div>

        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px dashed var(--border);">
            <h4 style="margin: 0 0 10px 0; color: var(--primary);"><i class="fas fa-sticky-note"></i> Observações Gerais</h4>
            <textarea id="obs-gerais" class="form-input" placeholder="Avisos gerais para o rodapé da impressão..."></textarea>
            <div id="obs-print-view" class="print-visible"></div>
        </div>

        <div style="display:none; margin-top:60px; text-align:center;" class="print-only-signature">
            <div style="border-top:1px solid #000; display:inline-block; width:300px; padding-top:5px;">Responsável pela Agenda</div>
        </div>
    </div>

    <div id="modal-add" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modal-title">Novo Evento</h3>
                <button class="icon-btn" onclick="fecharModal('modal-add')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label>Data</label><input type="text" id="inp-data" class="form-input" placeholder="Selecione..." required></div>
                <div class="form-group"><label>Evento</label><input type="text" id="inp-evento" class="form-input" placeholder="Ex: Culto de Jovens"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="form-group"><label>Porteiro</label><input type="text" id="inp-porteiro" class="form-input"></div>
                    <div class="form-group"><label>Direção</label><input type="text" id="inp-direcao" class="form-input"></div>
                </div>
                <div class="form-group"><label>Observações</label><textarea id="inp-obs" class="form-input" style="min-height: 80px;"></textarea></div>
                <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="salvarEvento()">Salvar Evento</button>
            </div>
        </div>
    </div>

    <div id="modal-card" class="modal-overlay">
        <div class="modal-box" style="background: transparent; box-shadow: none; border: none; max-width: 400px; padding: 0;">
            <div id="visual-card-wrapper">
                <div class="vc-header" id="vc-header"><span id="vc-data">--</span><span id="vc-dia">--</span></div>
                <div class="vc-body">
                    <img id="vc-logo" src="imagens/logo.png" onerror="this.style.display='none'" class="vc-logo">
                    <h2 class="vc-title" id="vc-evento">--</h2>
                    <div class="vc-grid">
                        <div class="vc-item"><label>Porteiro</label><span id="vc-porteiro">--</span></div>
                        <div class="vc-item"><label>Direção</label><span id="vc-direcao">--</span></div>
                    </div>
                    <div class="vc-obs" id="vc-obs-box"><span id="vc-obs">--</span></div>
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-whatsapp" onclick="shareWhatsApp()"><i class="fab fa-whatsapp"></i> Compartilhar</button>
                <button class="btn btn-secondary" onclick="imprimirCard()"><i class="fas fa-print"></i> Imprimir</button>
                <button class="btn btn-primary" onclick="downloadImage()"><i class="fas fa-download"></i> Baixar</button>
                <button class="btn btn-secondary" onclick="fecharModal('modal-card')">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modal-config" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><h3>Gerenciar Dados</h3><button class="icon-btn" onclick="fecharModal('modal-config')"><i class="fas fa-times"></i></button></div>
            <div style="display: grid; gap: 10px;">
                <button class="btn btn-secondary" onclick="exportExcel()"><i class="fas fa-file-excel" style="color:#10B981"></i> Excel</button>
                <button class="btn btn-secondary" onclick="exportPDF()"><i class="fas fa-file-pdf" style="color:#EF4444"></i> PDF</button>
                <button class="btn btn-secondary" onclick="exportJSON()"><i class="fas fa-code"></i> Backup JSON</button>
                <hr style="border:0; border-top:1px solid var(--border); width:100%; margin: 10px 0;">
                <input type="file" id="file-upload" accept=".json" style="display:none" onchange="importJSON(event)">
                <button class="btn btn-secondary" onclick="document.getElementById('file-upload').click()"><i class="fas fa-upload"></i> Restaurar Backup</button>
                <button class="btn btn-secondary" style="color:var(--danger);" onclick="limparTudo()">Apagar Tudo (Reset)</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDrJTTe8UZYWQFxCNKt4jH7s4bprBJ__58", authDomain: "agend-97931.firebaseapp.com", projectId: "agend-97931", storageBucket: "agend-97931.firebasestorage.app", messagingSenderId: "1046563583135", appId: "1:1046563583135:web:1bcc6b673c890ea7b8deaa", measurementId: "G-727K61WCFF" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

        let eventos = []; let editIndex = null; let isGridView = false; let flatpickrInst;
        const toggleLoad = (show) => document.getElementById('loading').style.display = show ? 'flex' : 'none';
        
        function toast(msg, type='success') {
            const box = document.getElementById('toast-box'); const el = document.createElement('div');
            el.className = `toast ${type}`; el.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i> ${msg}`;
            box.appendChild(el); setTimeout(() => { el.style.opacity = '0'; setTimeout(()=>el.remove(), 300); }, 3000);
        }

        function abrirModal(id) { 
            const m = document.getElementById(id); m.classList.add('open'); 
            if(id === 'modal-add' && editIndex === null) resetForm(); 
        }
        function fecharModal(id) { document.getElementById(id).classList.remove('open'); }

        async function loadData() {
            toggleLoad(true);
            try {
                const cfgSnap = await db.collection("config").doc("geral").get();
                if(cfgSnap.exists) {
                    const d = cfgSnap.data();
                    document.getElementById('header-title').innerHTML = `${d.tituloAgenda || 'Agenda da Igreja'} <i class="fas fa-pen" style="font-size:0.8rem; opacity:0.3; cursor:pointer;" onclick="editarTitulo()"></i>`;
                    document.getElementById('obs-gerais').value = d.obsGerais || '';
                } else await db.collection("config").doc("geral").set({tituloAgenda: 'Agenda da Igreja'});

                const snap = await db.collection("eventos").orderBy("data").get();
                eventos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render(); updateHero(); syncPrintObs();
            } catch(e) { console.error(e); toast("Erro ao carregar", "error"); }
            toggleLoad(false);
        }

        function render() {
            const area = document.getElementById('content-area');
            const termo = document.getElementById('search-input').value.toLowerCase();
            const lista = eventos.filter(e => JSON.stringify(e).toLowerCase().includes(termo));
            lista.sort((a,b) => a.data.localeCompare(b.data));

            if(lista.length === 0) { area.innerHTML = `<div style="text-align:center; padding:50px; color:var(--text-muted);">Nenhum evento encontrado.</div>`; return; }

            if(isGridView) {
                let html = '<div class="grid-view">';
                lista.forEach(e => {
                    const idx = eventos.findIndex(x => x.id === e.id);
                    const isSunday = e.dia.toLowerCase().includes('domingo');
                    
                    // Lógica para mostrar as observações APENAS se existirem
                    const obsHtml = e.observacoes 
                        ? `<div class="card-obs"><i class="fas fa-info-circle" style="margin-right:5px; opacity:0.7;"></i> ${e.observacoes}</div>` 
                        : '';

                    html += `
                        <div class="event-card ${isSunday ? 'sunday' : ''}">
                            <div class="card-strip"></div>
                            <div class="card-body">
                                <span class="card-date-badge">${formatDate(e.data)} • ${formatDia(e.dia)}</span>
                                <h3 class="card-title">${e.evento}</h3>
                                <div class="card-meta-list">
                                    <div class="meta-item"><div class="meta-icon-box"><i class="fas fa-user-shield"></i></div><span>${e.porteiro || '—'}</span></div>
                                    <div class="meta-item"><div class="meta-icon-box"><i class="fas fa-microphone"></i></div><span>${e.direcao || '—'}</span></div>
                                </div>
                                ${obsHtml} </div>
                            <div class="card-actions-footer">
                                <button class="icon-btn" onclick="prepCard(${idx})" title="Compartilhar/Imprimir"><i class="fas fa-share-alt"></i></button>
                                <button class="icon-btn duplicate" onclick="duplicarEvento(${idx})" title="Duplicar"><i class="fas fa-copy" style="color:var(--purple)"></i></button>
                                <button class="icon-btn" onclick="prepEdit(${idx})" title="Editar"><i class="fas fa-pen"></i></button>
                                <button class="icon-btn delete" onclick="delEvento(${idx})" title="Excluir"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>'; area.innerHTML = html;
            } else {
                let html = `<div class="data-container"><table><thead><tr><th>Data</th><th>Dia</th><th>Evento</th><th>Porteiro</th><th>Direção</th><th class="no-print">Ações</th></tr></thead><tbody>`;
                lista.forEach(e => {
                    const idx = eventos.findIndex(x => x.id === e.id);
                    const isSunday = e.dia.toLowerCase().includes('domingo');
                    html += `
                        <tr class="${isSunday ? 'sunday-row' : ''}">
                            <td style="font-weight:700; color:var(--primary);">${formatDate(e.data)}</td>
                            <td>${formatDia(e.dia)}</td>
                            <td style="font-weight:600;">${e.evento}</td>
                            <td>${e.porteiro ? `<span class="tag">${e.porteiro}</span>` : '—'}</td>
                            <td>${e.direcao || '—'}</td>
                            <td class="no-print">
                                <button class="icon-btn" onclick="prepCard(${idx})" style="display:inline-flex" title="Card"><i class="fas fa-share-alt"></i></button>
                                <button class="icon-btn duplicate" onclick="duplicarEvento(${idx})" style="display:inline-flex" title="Duplicar"><i class="fas fa-copy" style="color:var(--purple)"></i></button>
                                <button class="icon-btn" onclick="prepEdit(${idx})" style="display:inline-flex" title="Editar"><i class="fas fa-pen"></i></button>
                                <button class="icon-btn delete" onclick="delEvento(${idx})" style="display:inline-flex" title="Excluir"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                html += `</tbody></table></div>`; area.innerHTML = html;
            }
        }

        function updateHero() {
            const today = new Date().toISOString().split('T')[0];
            const next = eventos.find(e => e.data >= today);
            const w = document.getElementById('hero-widget');
            if(next) {
                w.style.display = 'block';
                document.getElementById('hero-title').innerText = next.evento;
                document.getElementById('hero-date').innerHTML = `<i class="far fa-calendar"></i> ${formatDate(next.data)} (${formatDia(next.dia)})`;
                document.getElementById('hero-porteiro').innerHTML = `<i class="fas fa-user-shield"></i> ${next.porteiro || '—'}`;
                document.getElementById('hero-direcao').innerHTML = `<i class="fas fa-microphone-alt"></i> ${next.direcao || '—'}`;
            } else w.style.display = 'none';
        }

        function resetForm() {
            document.getElementById('modal-title').innerText = "Novo Evento";
            ['inp-evento','inp-porteiro','inp-direcao','inp-obs'].forEach(id=>document.getElementById(id).value='');
            flatpickrInst.clear(); editIndex = null;
            const btn = document.querySelector('#modal-add .btn-primary');
            if(btn) btn.innerHTML = "Salvar Evento"; 
        }

        function prepEdit(idx) {
            editIndex = idx; const e = eventos[idx];
            document.getElementById('modal-title').innerText = "Editar Evento";
            document.getElementById('inp-evento').value = e.evento;
            document.getElementById('inp-porteiro').value = e.porteiro || '';
            document.getElementById('inp-direcao').value = e.direcao || '';
            document.getElementById('inp-obs').value = e.observacoes || '';
            flatpickrInst.setDate(e.data + "T00:00:00"); abrirModal('modal-add');
        }

        function duplicarEvento(idx) {
            if (idx < 0 || idx >= eventos.length) return;
            const e = eventos[idx];
            editIndex = null;
            abrirModal('modal-add');
            const dataObj = new Date(e.data + "T00:00:00");
            flatpickrInst.setDate(dataObj);
            document.getElementById('inp-evento').value = e.evento;
            document.getElementById('inp-porteiro').value = e.porteiro || '';
            document.getElementById('inp-direcao').value = e.direcao || '';
            document.getElementById('inp-obs').value = e.observacoes || '';
            document.getElementById('modal-title').innerHTML = `<i class="fas fa-copy"></i> Duplicar Evento`;
            const btn = document.querySelector('#modal-add .btn-primary');
            if(btn) btn.innerHTML = "Salvar Cópia"; 
            setTimeout(() => { document.getElementById("inp-data").focus(); }, 100);
        }

        async function salvarEvento() {
            const dataRaw = document.getElementById('inp-data').value;
            const evento = document.getElementById('inp-evento').value.trim();
            if(!dataRaw || !evento) return toast("Preencha data e nome!", "error");
            toggleLoad(true);
            try {
                const dateObj = new Date(dataRaw + "T00:00:00");
                const diaSemana = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
                const payload = { data: dataRaw, dia: diaSemana, evento: evento, porteiro: document.getElementById('inp-porteiro').value.trim(), direcao: document.getElementById('inp-direcao').value.trim(), observacoes: document.getElementById('inp-obs').value.trim() };
                if(editIndex !== null) { await db.collection("eventos").doc(eventos[editIndex].id).update(payload); toast("Atualizado!"); }
                else { await db.collection("eventos").add(payload); toast("Criado!"); }
                fecharModal('modal-add'); await loadData();
            } catch(e) { console.error(e); toast("Erro ao salvar", "error"); }
            toggleLoad(false);
        }

        async function delEvento(idx) {
            if(!confirm("Excluir?")) return; toggleLoad(true);
            try { await db.collection("eventos").doc(eventos[idx].id).delete(); toast("Excluído!", "success"); await loadData(); }
            catch(e) { toast("Erro ao excluir", "error"); } toggleLoad(false);
        }

        function prepCard(idx) {
            const e = eventos[idx];
            document.getElementById('vc-data').innerText = formatDate(e.data);
            document.getElementById('vc-dia').innerText = formatDia(e.dia);
            document.getElementById('vc-evento').innerText = e.evento;
            document.getElementById('vc-porteiro').innerText = e.porteiro || '—';
            document.getElementById('vc-direcao').innerText = e.direcao || '—';
            const obsBox = document.getElementById('vc-obs-box');
            if(e.observacoes) { document.getElementById('vc-obs').innerText = e.observacoes; obsBox.style.display = 'block'; } else obsBox.style.display = 'none';
            const header = document.getElementById('vc-header');
            if(e.dia.toLowerCase().includes('domingo')) header.classList.add('sunday-bg'); else header.classList.remove('sunday-bg');
            abrirModal('modal-card');
        }

        function imprimirCard() {
            const content = document.getElementById('visual-card-wrapper').outerHTML;
            const win = window.open('', '', 'width=600,height=600');
            win.document.write(`
                <html>
                <head>
                    <title>Imprimir Card</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Inter', sans-serif; padding: 20px; display: flex; justify-content: center; }
                        #visual-card-wrapper {
                            border: 1px solid #ccc; border-radius: 20px; overflow: hidden;
                            width: 100%; max-width: 400px;
                        }
                        .vc-header { background: #4F46E5; color: white; padding: 25px; display: flex; justify-content: space-between; font-weight: 800; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        .vc-header.sunday-bg { background: #EF4444; }
                        .vc-body { padding: 30px; }
                        .vc-logo { height: 60px; margin-bottom: 20px; display: block; }
                        .vc-title { font-size: 1.8rem; font-weight: 900; margin: 0 0 20px 0; color: #111827; }
                        .vc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; border-top: 2px dashed #eee; padding-top: 20px; }
                        .vc-item label { display: block; font-size: 0.7rem; text-transform: uppercase; color: #666; font-weight: 700; }
                        .vc-item span { font-size: 1rem; font-weight: 600; color: #333; }
                        .vc-obs { margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 10px; font-size: 0.9rem; font-style: italic; color: #555; }
                    </style>
                </head>
                <body>
                    ${content}
                    <script>
                        window.onload = () => { window.print(); window.close(); };
                    <\/script>
                </body>
                </html>
            `);
            win.document.close();
        }

        function captureCard(callback) {
            toggleLoad(true); const el = document.getElementById('visual-card-wrapper');
            html2canvas(el, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => { toggleLoad(false); callback(canvas); }).catch(e => { toggleLoad(false); toast("Erro", "error"); });
        }
        function downloadImage() { captureCard(canvas => { const a = document.createElement('a'); a.download = 'evento.png'; a.href = canvas.toDataURL(); a.click(); }); }
        function shareWhatsApp() { captureCard(canvas => { canvas.toBlob(async blob => { const file = new File([blob], "evento.png", { type: "image/png" }); if(navigator.canShare && navigator.canShare({ files: [file] })) { try { await navigator.share({ files: [file], title: 'Evento' }); } catch(e) {} } else { const a = document.createElement('a'); a.download = 'evento-whatsapp.png'; a.href = canvas.toDataURL(); a.click(); alert("Imagem baixada!"); } }); }); }

        function formatDate(dt) { const [y,m,d] = dt.split('-'); return `${d}/${m}`; }
        function formatDia(d) { return d.split('-')[0].substring(0,3).toUpperCase(); }
        function alternarVisao() { isGridView = !isGridView; render(); }
        function filtrarEventos() { render(); }
        function imprimir() { window.print(); }

        const obsArea = document.getElementById('obs-gerais');
        obsArea.addEventListener('input', () => { clearTimeout(obsArea.timer); syncPrintObs(); obsArea.timer = setTimeout(() => { db.collection("config").doc("geral").update({ obsGerais: obsArea.value }); }, 1000); });
        function syncPrintObs() { const val = obsArea.value; const printEl = document.getElementById('obs-print-view'); printEl.innerText = val; }

        async function projetarMes() {
            if(!confirm("Duplicar mês atual para o próximo e limpar passados?")) return; toggleLoad(true);
            try { const today = new Date(); const currentMonth = today.getMonth(); const batch = db.batch(); eventos.forEach(e => { const d = new Date(e.data + "T00:00:00"); if(d.getMonth() === currentMonth) { const nextD = new Date(d); nextD.setMonth(d.getMonth() + 1); const ref = db.collection("eventos").doc(); batch.set(ref, { ...e, data: nextD.toISOString().split('T')[0], dia: nextD.toLocaleDateString('pt-BR',{weekday:'long'}) }); } if(e.data < today.toISOString().split('T')[0]) batch.delete(db.collection("eventos").doc(e.id)); }); await batch.commit(); await loadData(); toast("Concluído!", "success"); } catch(e) { console.error(e); toast("Erro", "error"); } toggleLoad(false);
        }

        async function editarTitulo() { const current = document.getElementById('header-title').innerText; const novo = prompt("Novo título:", current); if(novo) { await db.collection("config").doc("geral").update({tituloAgenda: novo}); loadData(); } }
        
        const themeBtn = document.getElementById('theme-toggle');
        themeBtn.addEventListener('click', () => { document.body.classList.toggle('dark-mode'); const isDark = document.body.classList.contains('dark-mode'); themeBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; localStorage.setItem('theme', isDark ? 'dark' : 'light'); });

        function exportExcel() { const ws = XLSX.utils.json_to_sheet(eventos); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Agenda"); XLSX.writeFile(wb, "agenda.xlsx"); }
        function exportPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.autoTable({ head: [['Data', 'Dia', 'Evento', 'Porteiro']], body: eventos.map(e => [formatDate(e.data), formatDia(e.dia), e.evento, e.porteiro]) }); doc.save('agenda.pdf'); }
        function exportJSON() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(eventos)); const el = document.createElement('a'); el.setAttribute("href", dataStr); el.setAttribute("download", "backup.json"); el.click(); }
        function importJSON(e) { const reader = new FileReader(); reader.onload = async (evt) => { const data = JSON.parse(evt.target.result); if(confirm(`Restaurar ${data.length} eventos?`)) { toggleLoad(true); const batch = db.batch(); data.forEach(x => { const ref=db.collection("eventos").doc(); batch.set(ref, x); }); await batch.commit(); loadData(); toast("Restaurado!", "success"); } }; reader.readAsText(e.target.files[0]); }
        async function limparTudo() { if(!confirm("ATENÇÃO: Apagar tudo?")) return; toggleLoad(true); const snap = await db.collection("eventos").get(); const batch = db.batch(); snap.forEach(d => batch.delete(d.ref)); await batch.commit(); loadData(); toggleLoad(false); fecharModal('modal-config'); }

        window.onload = () => { flatpickrInst = flatpickr("#inp-data", { dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y", locale: "pt" }); if(localStorage.getItem('theme') === 'dark') themeBtn.click(); loadData(); };
    </script>
</body>
</html>